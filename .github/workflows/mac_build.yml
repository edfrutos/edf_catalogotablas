name: Build macOS App v2.0

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify checkout
        run: |
          echo "🔍 Verificando checkout del código..."
          echo "📁 Directorio actual: $(pwd)"
          echo "📋 Archivos en el directorio raíz:"
          ls -la
          echo "📋 Archivos requirements:"
          ls -la requirements*.txt || echo "No hay archivos requirements"
          echo "✅ Verificación de checkout completada"

      - name: Verify workflow version and connectivity
        run: |
          echo "🔍 Verificando versión del workflow y conectividad..."
          echo "Workflow: Build macOS App v2.0"
          echo "Fecha: $(date)"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          
          # Verificar el commit actual
          echo "📋 Información del commit actual:"
          git log --oneline -1
          git status --porcelain
          
          # Verificar conectividad básica
          echo "🌐 Verificando conectividad..."
          if ping -c 3 pypi.org > /dev/null 2>&1; then
            echo "✅ Conectividad con PyPI OK"
          else
            echo "⚠️  Problemas de conectividad con PyPI"
          fi
          
          if ping -c 3 github.com > /dev/null 2>&1; then
            echo "✅ Conectividad con GitHub OK"
          else
            echo "⚠️  Problemas de conectividad con GitHub"
          fi
          
          echo "✅ Verificación completada"

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          check-latest: false
        timeout-minutes: 15

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Verify and create requirements file
        run: |
          echo "🔍 Verificando y creando archivo requirements_python310.txt..."
          echo "📋 Archivos en el directorio actual:"
          ls -la
          echo "📋 Archivos .txt en el directorio:"
          ls -la *.txt || echo "No hay archivos .txt"
          echo "📋 Archivos requirements:"
          ls -la requirements*.txt || echo "No hay archivos requirements"
          
          # Ejecutar script de verificación de requirements
          if [ -f "verify_requirements.sh" ]; then
            echo "🔧 Ejecutando script de verificación de requirements..."
            chmod +x verify_requirements.sh
            ./verify_requirements.sh
          else
            echo "⚠️  Script verify_requirements.sh no encontrado, usando método manual..."
            
            if [ ! -f "requirements_python310.txt" ]; then
              echo "❌ ERROR: requirements_python310.txt no encontrado"
              echo "🔧 Intentando crear el archivo desde requirements.txt..."
              
              if [ -f "requirements.txt" ]; then
                echo "📋 Copiando requirements.txt a requirements_python310.txt..."
                cp requirements.txt requirements_python310.txt
                echo "✅ Archivo creado desde requirements.txt"
              else
                echo "❌ ERROR: requirements.txt tampoco existe"
                echo "🔧 Creando archivo requirements_python310.txt básico..."
                echo "# Requirements para Python 3.10" > requirements_python310.txt
                echo "Flask==2.3.3" >> requirements_python310.txt
                echo "pymongo==4.5.0" >> requirements_python310.txt
                echo "boto3==1.28.44" >> requirements_python310.txt
                echo "pandas==2.0.3" >> requirements_python310.txt
                echo "openpyxl==3.1.2" >> requirements_python310.txt
                echo "python-dotenv==1.0.0" >> requirements_python310.txt
                echo "Werkzeug==2.3.7" >> requirements_python310.txt
                echo "✅ Archivo requirements_python310.txt creado con dependencias básicas"
              fi
            fi
          fi
          
          echo "✅ requirements_python310.txt verificado/creado"
          echo "📏 Tamaño del archivo: $(wc -l < requirements_python310.txt) líneas"
          echo "📋 Primeras 5 líneas:"
          head -5 requirements_python310.txt

      - name: Install dependencies with retry
        run: |
          echo "📦 Instalando dependencias con reintentos..."
          
          # Función para instalar con reintentos
          install_with_retry() {
            local max_attempts=3
            local attempt=1
            
            while [ $attempt -le $max_attempts ]; do
              echo "🔄 Intento $attempt de $max_attempts..."
              
              if python -m pip install --upgrade pip; then
                echo "✅ pip actualizado correctamente"
                break
              else
                echo "❌ Error en intento $attempt"
                if [ $attempt -eq $max_attempts ]; then
                  echo "🚫 Falló después de $max_attempts intentos"
                  exit 1
                fi
                echo "⏳ Esperando 10 segundos antes del siguiente intento..."
                sleep 10
                attempt=$((attempt + 1))
              fi
            done
          }
          
          # Actualizar pip con reintentos
          install_with_retry
          
          # Instalar requirements con reintentos
          echo "📋 Instalando desde requirements_python310.txt..."
          for attempt in 1 2 3; do
            echo "🔄 Intento $attempt de 3 para requirements..."
            if pip install -r requirements_python310.txt; then
              echo "✅ Requirements instalados correctamente"
              break
            else
              echo "❌ Error en intento $attempt"
              if [ $attempt -eq 3 ]; then
                echo "🚫 Falló después de 3 intentos"
                exit 1
              fi
              echo "⏳ Esperando 15 segundos antes del siguiente intento..."
              sleep 15
            fi
          done
          
          # Instalar PyInstaller con reintentos
          echo "🔧 Instalando PyInstaller..."
          for attempt in 1 2 3; do
            echo "🔄 Intento $attempt de 3 para PyInstaller..."
            if pip install pyinstaller==6.15.0 pyinstaller-hooks-contrib==2025.8; then
              echo "✅ PyInstaller instalado correctamente"
              break
            else
              echo "❌ Error en intento $attempt"
              if [ $attempt -eq 3 ]; then
                echo "🚫 Falló después de 3 intentos"
                exit 1
              fi
              echo "⏳ Esperando 10 segundos antes del siguiente intento..."
              sleep 10
            fi
          done
          
          # Instalar pywebview con reintentos
          echo "🌐 Instalando pywebview..."
          for attempt in 1 2 3; do
            echo "🔄 Intento $attempt de 3 para pywebview..."
            if pip install pywebview; then
              echo "✅ pywebview instalado correctamente"
              break
            else
              echo "❌ Error en intento $attempt"
              if [ $attempt -eq 3 ]; then
                echo "🚫 Falló después de 3 intentos"
                exit 1
              fi
              echo "⏳ Esperando 10 segundos antes del siguiente intento..."
              sleep 10
            fi
          done
          
          echo "✅ Todas las dependencias instaladas correctamente"

      - name: Setup environment variables (non-sensitive)
        run: |
          echo "🔧 Configurando variables de entorno no sensibles..."
          cat > .env << EOF
          FLASK_ENV=production
          APP_VERSION=1.0.0
          BUILD_DATE=$(date +%Y-%m-%d)
          EOF
          echo "✅ Variables de entorno no sensibles configuradas"

      - name: Create placeholder credentials
        run: |
          echo "📝 Creando archivos de credenciales de ejemplo..."
          mkdir -p tools/db_utils
          cat > tools/db_utils/credentials.json.example << 'EOF'
          {
            "installed": {
              "client_id": "your-client-id.apps.googleusercontent.com",
              "project_id": "your-project-id",
              "auth_uri": "https://accounts.google.com/o/oauth2/auth",
              "token_uri": "https://oauth2.googleapis.com/token",
              "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
              "client_secret": "your-client-secret",
              "redirect_uris": ["http://localhost:8080/"]
            }
          }
          EOF
          echo "✅ Archivos de ejemplo creados"

      - name: Clean previous builds
        run: |
          echo "🧹 Limpiando builds anteriores..."
          rm -rf dist/ build/ || true
          find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
          find . -name "*.pyc" -delete 2>/dev/null || true
          find . -name ".mypy_cache" -type d -exec rm -rf {} + 2>/dev/null || true
          find . -name ".pytest_cache" -type d -exec rm -rf {} + 2>/dev/null || true
          echo "✅ Limpieza completa de cachés completada"

      - name: Verify spec file
        run: |
          echo "🔍 Verificando archivo .spec..."
          if [ ! -f "EDF_CatalogoDeTablas.spec" ]; then
            echo "❌ ERROR: EDF_CatalogoDeTablas.spec no encontrado"
            echo "📋 Archivos .spec disponibles:"
            ls -la *.spec || echo "No hay archivos .spec"
            exit 1
          fi
          echo "✅ EDF_CatalogoDeTablas.spec encontrado"
          echo "📏 Tamaño del archivo: $(wc -l < EDF_CatalogoDeTablas.spec) líneas"
          echo "📋 Primeras 10 líneas:"
          head -10 EDF_CatalogoDeTablas.spec
          echo "✅ Verificación completada"
          
      - name: Verify requirements file
        run: |
          echo "🔍 Verificando archivo requirements..."
          ls -la requirements_python310.txt
          echo "�� Contenido del archivo:"
          head -10 requirements_python310.txt
          echo "✅ Verificación de requirements completada"

      - name: Build App
        run: |
          echo "Iniciando construcción de la aplicación..."
          python -m PyInstaller EDF_CatalogoDeTablas.spec --clean
          echo "Construcción completada"

      - name: Verify build output
        run: |
          echo "Verificando salida de construcción..."
          ls -la dist/
          ls -la dist/EDF_CatalogoDeTablas.app/Contents/MacOS/ || echo "Aplicación no construida correctamente"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: EDF_CatalogoDeTablas.app
          path: dist/EDF_CatalogoDeTablas.app
          retention-days: 30

      - name: Upload build logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-logs
          path: |
            dist/
            build/
          retention-days: 7
