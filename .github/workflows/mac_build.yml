name: Build macOS App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements_python310.txt
          pip install pyinstaller==6.15.0 pyinstaller-hooks-contrib==2025.8
          pip install pywebview

      - name: Setup environment variables (non-sensitive)
        run: |
          echo "ðŸ”§ Configurando variables de entorno no sensibles..."
          cat > .env << EOF
          FLASK_ENV=production
          APP_VERSION=1.0.0
          BUILD_DATE=$(date +%Y-%m-%d)
          EOF
          echo "âœ… Variables de entorno no sensibles configuradas"

      - name: Create placeholder credentials
        run: |
          echo "ðŸ“ Creando archivos de credenciales de ejemplo..."
          mkdir -p tools/db_utils
          cat > tools/db_utils/credentials.json.example << 'EOF'
          {
            "installed": {
              "client_id": "your-client-id.apps.googleusercontent.com",
              "project_id": "your-project-id",
              "auth_uri": "https://accounts.google.com/o/oauth2/auth",
              "token_uri": "https://oauth2.googleapis.com/token",
              "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
              "client_secret": "your-client-secret",
              "redirect_uris": ["http://localhost:8080/"]
            }
          }
          EOF
          echo "âœ… Archivos de ejemplo creados"

      - name: Clean previous builds
        run: |
          echo "ðŸ§¹ Limpiando builds anteriores..."
          rm -rf dist/ build/ || true
          echo "âœ… Limpieza completada"

      - name: Verify spec file
        run: |
          echo "ðŸ” Verificando archivo .spec..."
          cat EDF_CatalogoDeTablas.spec
          echo "âœ… VerificaciÃ³n completada"

      - name: Build App
        run: |
          echo "Iniciando construcciÃ³n de la aplicaciÃ³n..."
          python -m PyInstaller EDF_CatalogoDeTablas.spec --clean
          echo "ConstrucciÃ³n completada"

      - name: Verify build output
        run: |
          echo "Verificando salida de construcciÃ³n..."
          ls -la dist/
          ls -la dist/EDF_CatalogoDeTablas.app/Contents/MacOS/ || echo "AplicaciÃ³n no construida correctamente"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: EDF_CatalogoDeTablas.app
          path: dist/EDF_CatalogoDeTablas.app
          retention-days: 30

      - name: Upload build logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-logs
          path: |
            dist/
            build/
          retention-days: 7
