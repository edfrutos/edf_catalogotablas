name: Build macOS App v2.0

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify checkout
        run: |
          echo "ğŸ” Verificando checkout del cÃ³digo..."
          echo "ğŸ“ Directorio actual: $(pwd)"
          echo "ğŸ“‹ Archivos en el directorio raÃ­z:"
          ls -la
          echo "ğŸ“‹ Archivos requirements:"
          ls -la requirements*.txt || echo "No hay archivos requirements"
          echo "âœ… VerificaciÃ³n de checkout completada"

      - name: Verify workflow version and connectivity
        run: |
          echo "ğŸ” Verificando versiÃ³n del workflow y conectividad..."
          echo "Workflow: Build macOS App v2.0"
          echo "Fecha: $(date)"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          
          # Verificar el commit actual
          echo "ğŸ“‹ InformaciÃ³n del commit actual:"
          git log --oneline -1
          git status --porcelain
          
          # Verificar conectividad bÃ¡sica
          echo "ğŸŒ Verificando conectividad..."
          if ping -c 3 pypi.org > /dev/null 2>&1; then
            echo "âœ… Conectividad con PyPI OK"
          else
            echo "âš ï¸  Problemas de conectividad con PyPI"
          fi
          
          if ping -c 3 github.com > /dev/null 2>&1; then
            echo "âœ… Conectividad con GitHub OK"
          else
            echo "âš ï¸  Problemas de conectividad con GitHub"
          fi
          
          echo "âœ… VerificaciÃ³n completada"

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          check-latest: false
        timeout-minutes: 15

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Verify and create requirements file
        run: |
          echo "ğŸ” Verificando y creando archivo requirements_python310.txt..."
          echo "ğŸ“‹ Archivos en el directorio actual:"
          ls -la
          echo "ğŸ“‹ Archivos .txt en el directorio:"
          ls -la *.txt || echo "No hay archivos .txt"
          echo "ğŸ“‹ Archivos requirements:"
          ls -la requirements*.txt || echo "No hay archivos requirements"
          
          # Ejecutar script de verificaciÃ³n de requirements
          if [ -f "verify_requirements.sh" ]; then
            echo "ğŸ”§ Ejecutando script de verificaciÃ³n de requirements..."
            chmod +x verify_requirements.sh
            ./verify_requirements.sh
          else
            echo "âš ï¸  Script verify_requirements.sh no encontrado, usando mÃ©todo manual..."
            
            if [ ! -f "requirements_python310.txt" ]; then
              echo "âŒ ERROR: requirements_python310.txt no encontrado"
              echo "ğŸ”§ Intentando crear el archivo desde requirements.txt..."
              
              if [ -f "requirements.txt" ]; then
                echo "ğŸ“‹ Copiando requirements.txt a requirements_python310.txt..."
                cp requirements.txt requirements_python310.txt
                echo "âœ… Archivo creado desde requirements.txt"
              else
                echo "âŒ ERROR: requirements.txt tampoco existe"
                echo "ğŸ”§ Creando archivo requirements_python310.txt bÃ¡sico..."
                echo "# Requirements para Python 3.10" > requirements_python310.txt
                echo "Flask==2.3.3" >> requirements_python310.txt
                echo "pymongo==4.5.0" >> requirements_python310.txt
                echo "boto3==1.28.44" >> requirements_python310.txt
                echo "pandas==2.0.3" >> requirements_python310.txt
                echo "openpyxl==3.1.2" >> requirements_python310.txt
                echo "python-dotenv==1.0.0" >> requirements_python310.txt
                echo "Werkzeug==2.3.7" >> requirements_python310.txt
                echo "âœ… Archivo requirements_python310.txt creado con dependencias bÃ¡sicas"
              fi
            fi
          fi
          
          echo "âœ… requirements_python310.txt verificado/creado"
          echo "ğŸ“ TamaÃ±o del archivo: $(wc -l < requirements_python310.txt) lÃ­neas"
          echo "ğŸ“‹ Primeras 5 lÃ­neas:"
          head -5 requirements_python310.txt

      - name: Install dependencies with retry
        run: |
          echo "ğŸ“¦ Instalando dependencias con reintentos..."
          
          # FunciÃ³n para instalar con reintentos
          install_with_retry() {
            local max_attempts=3
            local attempt=1
            
            while [ $attempt -le $max_attempts ]; do
              echo "ğŸ”„ Intento $attempt de $max_attempts..."
              
              if python -m pip install --upgrade pip; then
                echo "âœ… pip actualizado correctamente"
                break
              else
                echo "âŒ Error en intento $attempt"
                if [ $attempt -eq $max_attempts ]; then
                  echo "ğŸš« FallÃ³ despuÃ©s de $max_attempts intentos"
                  exit 1
                fi
                echo "â³ Esperando 10 segundos antes del siguiente intento..."
                sleep 10
                attempt=$((attempt + 1))
              fi
            done
          }
          
          # Actualizar pip con reintentos
          install_with_retry
          
          # Instalar requirements con reintentos
          echo "ğŸ“‹ Instalando desde requirements_python310.txt..."
          for attempt in 1 2 3; do
            echo "ğŸ”„ Intento $attempt de 3 para requirements..."
            if pip install -r requirements_python310.txt; then
              echo "âœ… Requirements instalados correctamente"
              break
            else
              echo "âŒ Error en intento $attempt"
              if [ $attempt -eq 3 ]; then
                echo "ğŸš« FallÃ³ despuÃ©s de 3 intentos"
                exit 1
              fi
              echo "â³ Esperando 15 segundos antes del siguiente intento..."
              sleep 15
            fi
          done
          
          # Instalar PyInstaller con reintentos
          echo "ğŸ”§ Instalando PyInstaller..."
          for attempt in 1 2 3; do
            echo "ğŸ”„ Intento $attempt de 3 para PyInstaller..."
            if pip install pyinstaller==6.15.0 pyinstaller-hooks-contrib==2025.8; then
              echo "âœ… PyInstaller instalado correctamente"
              break
            else
              echo "âŒ Error en intento $attempt"
              if [ $attempt -eq 3 ]; then
                echo "ğŸš« FallÃ³ despuÃ©s de 3 intentos"
                exit 1
              fi
              echo "â³ Esperando 10 segundos antes del siguiente intento..."
              sleep 10
            fi
          done
          
          # Instalar pywebview con reintentos
          echo "ğŸŒ Instalando pywebview..."
          for attempt in 1 2 3; do
            echo "ğŸ”„ Intento $attempt de 3 para pywebview..."
            if pip install pywebview; then
              echo "âœ… pywebview instalado correctamente"
              break
            else
              echo "âŒ Error en intento $attempt"
              if [ $attempt -eq 3 ]; then
                echo "ğŸš« FallÃ³ despuÃ©s de 3 intentos"
                exit 1
              fi
              echo "â³ Esperando 10 segundos antes del siguiente intento..."
              sleep 10
            fi
          done
          
          echo "âœ… Todas las dependencias instaladas correctamente"

      - name: Setup environment variables (non-sensitive)
        run: |
          echo "ğŸ”§ Configurando variables de entorno no sensibles..."
          cat > .env << EOF
          FLASK_ENV=production
          APP_VERSION=1.0.0
          BUILD_DATE=$(date +%Y-%m-%d)
          EOF
          echo "âœ… Variables de entorno no sensibles configuradas"

      - name: Create placeholder credentials
        run: |
          echo "ğŸ“ Creando archivos de credenciales de ejemplo..."
          mkdir -p tools/db_utils
          cat > tools/db_utils/credentials.json.example << 'EOF'
          {
            "installed": {
              "client_id": "your-client-id.apps.googleusercontent.com",
              "project_id": "your-project-id",
              "auth_uri": "https://accounts.google.com/o/oauth2/auth",
              "token_uri": "https://oauth2.googleapis.com/token",
              "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
              "client_secret": "your-client-secret",
              "redirect_uris": ["http://localhost:8080/"]
            }
          }
          EOF
          echo "âœ… Archivos de ejemplo creados"

      - name: Clean previous builds
        run: |
          echo "ğŸ§¹ Limpiando builds anteriores..."
          rm -rf dist/ build/ || true
          find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
          find . -name "*.pyc" -delete 2>/dev/null || true
          find . -name ".mypy_cache" -type d -exec rm -rf {} + 2>/dev/null || true
          find . -name ".pytest_cache" -type d -exec rm -rf {} + 2>/dev/null || true
          echo "âœ… Limpieza completa de cachÃ©s completada"

      - name: Verify spec file
        run: |
          echo "ğŸ” Verificando archivo .spec..."
          if [ ! -f "EDF_CatalogoDeTablas.spec" ]; then
            echo "âŒ ERROR: EDF_CatalogoDeTablas.spec no encontrado"
            echo "ğŸ“‹ Archivos .spec disponibles:"
            ls -la *.spec || echo "No hay archivos .spec"
            exit 1
          fi
          echo "âœ… EDF_CatalogoDeTablas.spec encontrado"
          echo "ğŸ“ TamaÃ±o del archivo: $(wc -l < EDF_CatalogoDeTablas.spec) lÃ­neas"
          echo "ğŸ“‹ Primeras 10 lÃ­neas:"
          head -10 EDF_CatalogoDeTablas.spec
          echo "âœ… VerificaciÃ³n completada"
          
      - name: Verify requirements file
        run: |
          echo "ğŸ” Verificando archivo requirements..."
          ls -la requirements_python310.txt
          echo "ï¿½ï¿½ Contenido del archivo:"
          head -10 requirements_python310.txt
          echo "âœ… VerificaciÃ³n de requirements completada"

      - name: Build App
        run: |
          echo "Iniciando construcciÃ³n de la aplicaciÃ³n..."
          python -m PyInstaller EDF_CatalogoDeTablas.spec --clean
          echo "ConstrucciÃ³n completada"

      - name: Verify build output
        run: |
          echo "Verificando salida de construcciÃ³n..."
          ls -la dist/
          ls -la dist/EDF_CatalogoDeTablas.app/Contents/MacOS/ || echo "AplicaciÃ³n no construida correctamente"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: EDF_CatalogoDeTablas.app
          path: dist/EDF_CatalogoDeTablas.app
          retention-days: 30

      - name: Upload build logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-logs
          path: |
            dist/
            build/
          retention-days: 7
