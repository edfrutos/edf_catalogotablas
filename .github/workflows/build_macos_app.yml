name: Build macOS App v2.0

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify checkout
        run: |
          echo "ğŸ” Verificando checkout del cÃ³digo..."
          echo "ğŸ“ Directorio actual: $(pwd)"
          echo "ğŸ“‹ Archivos en el directorio raÃ­z:"
          ls -la
          echo "ğŸ“‹ Archivos requirements:"
          ls -la requirements*.txt || echo "No hay archivos requirements"
          echo "âœ… VerificaciÃ³n de checkout completada"

      - name: Verify workflow version and connectivity
        run: |
          echo "ğŸ” Verificando versiÃ³n del workflow y conectividad..."
          echo "Workflow: Build macOS App v2.0"
          echo "Fecha: $(date)"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          
          # Verificar el commit actual
          echo "ğŸ“‹ InformaciÃ³n del commit actual:"
          git log --oneline -1
          git status --porcelain
          
          # Verificar conectividad bÃ¡sica
          echo "ğŸŒ Verificando conectividad..."
          if ping -c 3 pypi.org > /dev/null 2>&1; then
            echo "âœ… Conectividad con PyPI OK"
          else
            echo "âš ï¸  Problemas de conectividad con PyPI"
          fi
          
          if ping -c 3 github.com > /dev/null 2>&1; then
            echo "âœ… Conectividad con GitHub OK"
          else
            echo "âš ï¸  Problemas de conectividad con GitHub"
          fi
          
          echo "âœ… VerificaciÃ³n completada"

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          check-latest: false
        timeout-minutes: 15

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Verify and create requirements file
        run: |
          echo "ğŸ” Verificando y creando archivo requirements_python310.txt..."
          echo "ğŸ“‹ Archivos en el directorio actual:"
          ls -la
          echo "ğŸ“‹ Archivos .txt en el directorio:"
          ls -la *.txt || echo "No hay archivos .txt"
          echo "ğŸ“‹ Archivos requirements:"
          ls -la requirements*.txt || echo "No hay archivos requirements"
          
          # Ejecutar script de verificaciÃ³n de requirements
          if [ -f "verify_requirements.sh" ]; then
            echo "ğŸ”§ Ejecutando script de verificaciÃ³n de requirements..."
            chmod +x verify_requirements.sh
            ./verify_requirements.sh
          else
            echo "âš ï¸  Script verify_requirements.sh no encontrado, usando mÃ©todo manual..."
            
            if [ ! -f "requirements_python310.txt" ]; then
              echo "âŒ ERROR: requirements_python310.txt no encontrado"
              echo "ğŸ”§ Intentando crear el archivo desde requirements.txt..."
              
              if [ -f "requirements.txt" ]; then
                echo "ğŸ“‹ Copiando requirements.txt a requirements_python310.txt..."
                cp requirements.txt requirements_python310.txt
                echo "âœ… Archivo creado desde requirements.txt"
              else
                echo "âŒ ERROR: requirements.txt tampoco existe"
                echo "ğŸ”§ Creando archivo requirements_python310.txt bÃ¡sico..."
                echo "# Requirements para Python 3.10" > requirements_python310.txt
                echo "Flask==2.3.3" >> requirements_python310.txt
                echo "pymongo==4.5.0" >> requirements_python310.txt
                echo "boto3==1.28.44" >> requirements_python310.txt
                echo "pandas==2.0.3" >> requirements_python310.txt
                echo "openpyxl==3.1.2" >> requirements_python310.txt
                echo "python-dotenv==1.0.0" >> requirements_python310.txt
                echo "Werkzeug==2.3.7" >> requirements_python310.txt
                echo "âœ… Archivo requirements_python310.txt creado con dependencias bÃ¡sicas"
              fi
            fi
          fi
          
          echo "âœ… requirements_python310.txt verificado/creado"
          echo "ğŸ“ TamaÃ±o del archivo: $(wc -l < requirements_python310.txt) lÃ­neas"
          echo "ğŸ“‹ Primeras 5 lÃ­neas:"
          head -5 requirements_python310.txt

      - name: Install dependencies with retry
        run: |
          echo "ğŸ“¦ Instalando dependencias con reintentos..."
          
          # FunciÃ³n para instalar con reintentos
          install_with_retry() {
            local max_attempts=3
            local attempt=1
            
            while [ $attempt -le $max_attempts ]; do
              echo "ğŸ”„ Intento $attempt de $max_attempts..."
              
              if python -m pip install --upgrade pip; then
                echo "âœ… pip actualizado correctamente"
                break
              else
                echo "âŒ Error en intento $attempt"
                if [ $attempt -eq $max_attempts ]; then
                  echo "ğŸš« FallÃ³ despuÃ©s de $max_attempts intentos"
                  exit 1
                fi
                echo "â³ Esperando 10 segundos antes del siguiente intento..."
                sleep 10
                attempt=$((attempt + 1))
              fi
            done
          }
          
          # Actualizar pip con reintentos
          install_with_retry
          
          # Instalar requirements con reintentos
          echo "ğŸ“‹ Instalando desde requirements_python310.txt..."
          for attempt in 1 2 3; do
            echo "ğŸ”„ Intento $attempt de 3 para requirements..."
            if pip install -r requirements_python310.txt; then
              echo "âœ… Requirements instalados correctamente"
              break
            else
              echo "âŒ Error en intento $attempt"
              if [ $attempt -eq 3 ]; then
                echo "ğŸš« FallÃ³ despuÃ©s de 3 intentos"
                exit 1
              fi
              echo "â³ Esperando 15 segundos antes del siguiente intento..."
              sleep 15
            fi
          done
          
          # Instalar PyInstaller con reintentos
          echo "ğŸ”§ Instalando PyInstaller..."
          for attempt in 1 2 3; do
            echo "ğŸ”„ Intento $attempt de 3 para PyInstaller..."
            if pip install pyinstaller==6.15.0 pyinstaller-hooks-contrib==2025.8; then
              echo "âœ… PyInstaller instalado correctamente"
              break
            else
              echo "âŒ Error en intento $attempt"
              if [ $attempt -eq 3 ]; then
                echo "ğŸš« FallÃ³ despuÃ©s de 3 intentos"
                exit 1
              fi
              echo "â³ Esperando 10 segundos antes del siguiente intento..."
              sleep 10
            fi
          done
          
          # Instalar pywebview con reintentos
          echo "ğŸŒ Instalando pywebview..."
          for attempt in 1 2 3; do
            echo "ğŸ”„ Intento $attempt de 3 para pywebview..."
            if pip install pywebview; then
              echo "âœ… pywebview instalado correctamente"
              break
            else
              echo "âŒ Error en intento $attempt"
              if [ $attempt -eq 3 ]; then
                echo "ğŸš« FallÃ³ despuÃ©s de 3 intentos"
                exit 1
              fi
              echo "â³ Esperando 10 segundos antes del siguiente intento..."
              sleep 10
            fi
          done
          
          echo "âœ… Todas las dependencias instaladas correctamente"

      - name: Setup environment variables (non-sensitive)
        run: |
          echo "ğŸ”§ Configurando variables de entorno no sensibles..."
          cat > .env << EOF
          FLASK_ENV=production
          APP_VERSION=1.0.0
          BUILD_DATE=$(date +%Y-%m-%d)
          EOF
          echo "âœ… Variables de entorno no sensibles configuradas"

      - name: Create required directories for build
        run: |
          echo "ğŸ“ Creando directorios requeridos para el build..."
          
          # Crear directorio backups (requerido por PyInstaller)
          mkdir -p backups
          echo "âœ… Directorio backups creado"
          
          # Crear directorio flask_session (requerido por Flask-Session)
          mkdir -p flask_session
          echo "âœ… Directorio flask_session creado"
          
          # Crear otros directorios que puedan ser necesarios
          mkdir -p uploads
          mkdir -p static/uploads
          mkdir -p logs
          mkdir -p exportados
          mkdir -p spreadsheets
          mkdir -p imagenes
          mkdir -p instance
          
          echo "ğŸ“‹ Directorios creados:"
          ls -la | grep "^d"
          echo "âœ… Directorios requeridos creados"

      - name: Create placeholder credentials
        run: |
          echo "ğŸ“ Creando archivos de credenciales de ejemplo..."
          mkdir -p tools/db_utils
          cat > tools/db_utils/credentials.json.example << 'EOF'
          {
            "installed": {
              "client_id": "your-client-id.apps.googleusercontent.com",
              "project_id": "your-project-id",
              "auth_uri": "https://accounts.google.com/o/oauth2/auth",
              "token_uri": "https://oauth2.googleapis.com/token",
              "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
              "client_secret": "your-client-secret",
              "redirect_uris": ["http://localhost:8080/"]
            }
          }
          EOF
          echo "âœ… Archivos de ejemplo creados"

      - name: Clean previous builds and resolve PyInstaller conflicts
        run: |
          echo "ğŸ§¹ Limpiando builds anteriores y resolviendo conflictos de PyInstaller..."
          
          # Ejecutar limpieza manual (evitar scripts que sobrescriben .spec)
          echo "ğŸ§¹ Ejecutando limpieza manual para evitar conflictos..."
          rm -rf dist/ build/ || true
          find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
          find . -name "*.pyc" -delete 2>/dev/null || true
          find . -name ".mypy_cache" -type d -exec rm -rf {} + 2>/dev/null || true
          find . -name ".pytest_cache" -type d -exec rm -rf {} + 2>/dev/null || true
          
          # Eliminar archivos conflictivos especÃ­ficos
          rm -f tools 2>/dev/null || true
          rm -f dist/EDF_CatalogoDeTablas.app/Contents/Frameworks/tools 2>/dev/null || true
          
          # Buscar y eliminar archivos 'tools' conflictivos
          find . -name "tools" -type f -delete 2>/dev/null || true
          
          echo "âœ… Limpieza manual completada sin sobrescribir archivo .spec"
          
          echo "âœ… Limpieza completa y resoluciÃ³n de conflictos completada"
          
          # Verificar que el entorno estÃ¡ listo para el build
          if [ -f "verify_build_environment.sh" ]; then
            echo "ğŸ” Verificando que el entorno estÃ¡ listo para el build..."
            chmod +x verify_build_environment.sh
            ./verify_build_environment.sh
          fi
          
          # Verificar archivo .spec existente (no modificar si ya estÃ¡ correcto)
          if [ -f "EDF_CatalogoDeTablas_Native_WebSockets.spec" ]; then
            echo "âœ… EDF_CatalogoDeTablas_Native_WebSockets.spec encontrado y listo para usar"
            echo "ğŸ“ TamaÃ±o del archivo: $(wc -l < EDF_CatalogoDeTablas_Native_WebSockets.spec) lÃ­neas"
          else
            echo "âŒ ERROR: EDF_CatalogoDeTablas_Native_WebSockets.spec no encontrado"
            echo "ğŸ”§ Intentando crear archivo .spec bÃ¡sico..."
            # Crear archivo .spec bÃ¡sico si no existe usando echo
            echo "# -*- mode: python ; coding: utf-8 -*-" > EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "" >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "import os" >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "from pathlib import Path" >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "" >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "block_cipher = None" >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "" >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "def safe_data_paths():" >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    paths = []" >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    essential_paths = [" >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "        ('app/static', 'app/static')," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "        ('app/templates', 'app/templates')," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "        ('app/routes', 'app/routes')," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "        ('app/models', 'app/models')," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "        ('app/utils', 'app/utils')," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    ]" >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    for src, dst in essential_paths:" >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "        if os.path.exists(src):" >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "            paths.append((src, dst))" >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    return paths" >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "" >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "a = Analysis(" >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    ['run_server.py']," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    pathex=[]," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    binaries=[]," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    datas=safe_data_paths()," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    hiddenimports=['flask', 'pymongo', 'boto3']," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    hookspath=[]," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    hooksconfig={}," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    runtime_hooks=[]," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    excludes=[]," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    win_no_prefer_redirects=False," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    win_private_assemblies=False," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    cipher=block_cipher," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    noarchive=False," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo ")" >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "" >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)" >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "" >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "exe = EXE(" >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    pyz," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    a.scripts," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    []," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    exclude_binaries=True," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    name='EDF_CatalogoDeTablas'," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    debug=False," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    bootloader_ignore_signals=False," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    strip=False," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    upx=True," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    console=True," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    disable_windowed_traceback=False," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    argv_emulation=False," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    target_arch=None," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    codesign_identity=None," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    entitlements_file=None," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo ")" >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "" >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "coll = COLLECT(" >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    exe," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    a.binaries," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    a.zipfiles," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    a.datas," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    strip=False," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    upx=True," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    upx_exclude=[]," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "    name='EDF_CatalogoDeTablas'," >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo ")" >> EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "âœ… Archivo .spec bÃ¡sico creado"
          fi

      - name: Verify and create spec file
        run: |
          echo "ğŸ” Verificando y creando archivo .spec..."
          echo "ğŸ“‹ Archivos en el directorio actual:"
          ls -la
          echo "ğŸ“‹ Archivos .spec en el directorio:"
          ls -la *.spec || echo "No hay archivos .spec"
          
          # Verificar si el archivo principal existe
          if [ -f "EDF_CatalogoDeTablas_Native_WebSockets.spec" ]; then
            echo "âœ… EDF_CatalogoDeTablas_Native_WebSockets.spec encontrado"
            echo "ğŸ“ TamaÃ±o del archivo: $(wc -l < EDF_CatalogoDeTablas_Native_WebSockets.spec) lÃ­neas"
            echo "ğŸ“‹ Primeras 10 lÃ­neas:"
            head -10 EDF_CatalogoDeTablas_Native_WebSockets.spec
            echo "âœ… VerificaciÃ³n completada"
            exit 0
          fi
          
          # Si no existe, intentar ejecutar el script de verificaciÃ³n
          if [ -f "create_safe_spec.sh" ]; then
            echo "ğŸ”§ Ejecutando script de creaciÃ³n de .spec seguro..."
            chmod +x create_safe_spec.sh
            ./create_safe_spec.sh
          elif [ -f "verify_spec.sh" ]; then
            echo "ğŸ”§ Ejecutando script de verificaciÃ³n de spec..."
            chmod +x verify_spec.sh
            ./verify_spec.sh
          else
            echo "âš ï¸  Script verify_spec.sh no encontrado, creando archivo manualmente..."
            
            # Crear archivo .spec bÃ¡sico usando echo para evitar problemas de YAML
            echo "# -*- mode: python ; coding: utf-8 -*-" > "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "import os" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "from pathlib import Path" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "block_cipher = None" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "# FunciÃ³n para verificar si un directorio existe antes de incluirlo" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "def safe_data_paths():" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    paths = []" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    " >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    # Directorios esenciales que siempre deben estar" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    essential_paths = [" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('app/static', 'app/static')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('app/templates', 'app/templates')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('app/routes', 'app/routes')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('app/models', 'app/models')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('app/utils', 'app/utils')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('tools/db_utils', 'app_tools/db_utils')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('tools/utils', 'app_tools/utils')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('tools/maintenance', 'app_tools/maintenance')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('tools/monitoring', 'app_tools/monitoring')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('tools/Admin Utils', 'app_tools/Admin Utils')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('tools/Scripts Principales', 'app_tools/Scripts Principales')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('tools/Users Tools', 'app_tools/Users Tools')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('tools/Test Scripts', 'app_tools/Test Scripts')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('tools/testing', 'app_tools/testing')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('tools/image_utils', 'app_tools/image_utils')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('tools/local', 'app_tools/local')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('tools/macOS', 'app_tools/macOS')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('tools/production', 'app_tools/production')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('tools/system', 'app_tools/system')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('tools/src', 'app_tools/src')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    ]" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    " >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    # Agregar solo directorios que existen" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    for src, dst in essential_paths:" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        if os.path.exists(src):" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "            paths.append((src, dst))" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        else:" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "            print(f'âš ï¸  Directorio no encontrado: {src}')" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    " >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    # Archivos individuales esenciales" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    essential_files = [" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('.env', '.')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('config.py', '.')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('wsgi.py', '.')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('app/__init__.py', 'app')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('app/extensions.py', 'app')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('app/logging_unified.py', 'app')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('app/security_middleware.py', 'app')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        ('requirements_python310.txt', '.')," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    ]" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    " >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    for src, dst in essential_files:" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        if os.path.exists(src):" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "            paths.append((src, dst))" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        else:" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "            print(f'âš ï¸  Archivo no encontrado: {src}')" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    " >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    return paths" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "a = Analysis(" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    ['run_server.py']," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    pathex=[]," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    binaries=[]," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    datas=safe_data_paths()," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    hiddenimports=[" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        'flask'," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        'pymongo'," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        'boto3'," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        'pandas'," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        'openpyxl'," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        'dotenv'," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        'werkzeug'," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        'jinja2'," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        'markupsafe'," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        'itsdangerous'," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        'click'," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        'cryptography'," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        'PIL'," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        'psutil'," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "        'pywebview'," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    ]," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    hookspath=[]," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    hooksconfig={}," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    runtime_hooks=[]," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    excludes=[]," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    win_no_prefer_redirects=False," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    win_private_assemblies=False," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    cipher=block_cipher," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    noarchive=False," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo ")" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "exe = EXE(" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    pyz," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    a.scripts," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    []," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    exclude_binaries=True," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    name='EDF_CatalogoDeTablas'," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    debug=False," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    bootloader_ignore_signals=False," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    strip=False," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    upx=True," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    console=True," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    disable_windowed_traceback=False," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    argv_emulation=False," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    target_arch=None," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    codesign_identity=None," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    entitlements_file=None," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo ")" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "coll = COLLECT(" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    exe," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    a.binaries," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    a.zipfiles," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    a.datas," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    strip=False," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    upx=True," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    upx_exclude=[]," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo "    name='EDF_CatalogoDeTablas'," >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            echo ")" >> "EDF_CatalogoDeTablas_Native_WebSockets.spec"
            
            echo "âœ… Archivo EDF_CatalogoDeTablas_Native_WebSockets.spec creado manualmente"
            echo "ğŸ“ TamaÃ±o del archivo: $(wc -l < EDF_CatalogoDeTablas_Native_WebSockets.spec) lÃ­neas"
            echo "ğŸ“‹ Primeras 10 lÃ­neas:"
            head -10 EDF_CatalogoDeTablas_Native_WebSockets.spec
          fi
          
          echo "âœ… VerificaciÃ³n completada"
          
      - name: Verify requirements file
        run: |
          echo "ğŸ” Verificando archivo requirements..."
          ls -la requirements_python310.txt
          echo "ğŸ“‹ Contenido del archivo:"
          head -10 requirements_python310.txt
          echo "âœ… VerificaciÃ³n de requirements completada"

      - name: Build App
        run: |
          echo "ğŸ”¨ Iniciando construcciÃ³n de la aplicaciÃ³n..."
          
          # VerificaciÃ³n final antes del build
          if [ -f "pre_build_final_check.sh" ]; then
            echo "ğŸ” Ejecutando verificaciÃ³n final pre-build..."
            chmod +x pre_build_final_check.sh
            ./pre_build_final_check.sh
          fi
          
          # Intentar usar el script de build mejorado si existe
          if [ -f "build_macos_app.sh" ]; then
            echo "ğŸ”§ Usando script de build mejorado..."
            chmod +x build_macos_app.sh
            ./build_macos_app.sh
          else
            echo "âš ï¸  Script build_macos_app.sh no encontrado, usando PyInstaller directamente..."
            python -m PyInstaller EDF_CatalogoDeTablas_Native_WebSockets.spec --clean
          fi
          
          echo "âœ… ConstrucciÃ³n completada"

      - name: Verify build output
        run: |
          echo "Verificando salida de construcciÃ³n..."
          ls -la dist/
          ls -la dist/EDF_CatalogoDeTablas.app/Contents/MacOS/ || echo "AplicaciÃ³n no construida correctamente"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: EDF_CatalogoDeTablas.app
          path: dist/EDF_CatalogoDeTablas.app
          retention-days: 30

      - name: Upload build logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-logs
          path: |
            dist/
            build/
          retention-days: 7
