{% extends 'base.html' %}

{% block title %}Mantenimiento del Sistema{% endblock %}

{% block content %}
<div class="container mt-4 d-flex flex-column align-items-center">
    <h1>Panel de Mantenimiento</h1>
    
    <div class="d-flex justify-content-center align-items-center w-100" style="min-height: 60vh;">
      <div class="row w-100 justify-content-center">
  <div class="col-12 col-md-5 d-flex justify-content-center mb-4">
    <!-- Tarjeta 1: Herramientas de Mantenimiento (contenido original aquí) -->
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h4 class="card-title mb-0">Herramientas de Mantenimiento</h4>
      </div>
      <div class="card-body">
        <div class="list-group">
          <a href="{{ url_for('admin.system_status') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <div>
              <i class="bi bi-graph-up"></i> Estado del sistema
              <small class="d-block text-muted">Monitorear rendimiento y recursos</small>
            </div>
          </a>
          <a href="{{ url_for('admin.notification_settings') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <div>
              <i class="bi bi-bell"></i> Configuración de alertas
              <small class="d-block text-muted">Configurar notificaciones por email</small>
            </div>
            <span class="badge bg-primary rounded-pill">Ver</span>
          </a>
          <a href="{{ url_for('admin.backup_json') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <div>
              <i class="bi bi-download"></i> Exportar catálogo (JSON)
              <small class="d-block text-muted">Backup completo en formato JSON</small>
            </div>
            <span class="badge bg-success rounded-pill">Descargar</span>
          </a>
          <a href="{{ url_for('admin.backup_csv') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <div>
              <i class="bi bi-file-earmark-spreadsheet"></i> Exportar catálogo (CSV)
              <small class="d-block text-muted">Backup en formato CSV para hojas de cálculo</small>
            </div>
            <span class="badge bg-success rounded-pill">Descargar</span>
          </a>
          <a href="{{ url_for('admin.cleanup_resets') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <div>
              <i class="bi bi-trash"></i> Limpiar tokens de recuperación
              <small class="d-block text-muted">Eliminar tokens utilizados o caducados</small>
            </div>
          </a>
          <!-- ... resto de la lista ... -->
        </div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-5 d-flex justify-content-center mb-4">
    <!-- Tarjeta 2: Resumen de Estado (contenido original aquí) -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title mb-0">Herramientas de Mantenimiento</h4>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        <a href="{{ url_for('admin.system_status') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-graph-up"></i> Estado del sistema
                                <small class="d-block text-muted">Monitorear rendimiento y recursos</small>
                            </div>
                        </a>
                        <a href="{{ url_for('admin.notification_settings') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-bell"></i> Configuración de alertas
                                <small class="d-block text-muted">Configurar notificaciones por email</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">Ver</span>
                        </a>
                        <a href="{{ url_for('admin.backup_json') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-download"></i> Exportar catálogo (JSON)
                                <small class="d-block text-muted">Backup completo en formato JSON</small>
                            </div>
                            <span class="badge bg-success rounded-pill">Descargar</span>
                        </a>
                        <a href="{{ url_for('admin.backup_csv') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-file-earmark-spreadsheet"></i> Exportar catálogo (CSV)
                                <small class="d-block text-muted">Backup en formato CSV para hojas de cálculo</small>
                            </div>
                            <span class="badge bg-success rounded-pill">Descargar</span>
                        </a>
                        <a href="{{ url_for('admin.cleanup_resets') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-trash"></i> Limpiar tokens de recuperación
                                <small class="d-block text-muted">Eliminar tokens utilizados o caducados</small>
                            </div>
                            <span class="badge bg-warning rounded-pill">Limpiar</span>
                        </a>
                        <a href="{{ url_for('admin.verify_users') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-people"></i> Verificar usuarios y roles
                                <small class="d-block text-muted">Comprobar la configuración de cada usuario</small>
                            </div>
                            <span class="badge bg-info rounded-pill">Verificar</span>
                        </a>
                        <button id="cleanupTempBtn" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-trash"></i> Eliminar archivos temporales
                                <small class="d-block text-muted">Limpiar archivos con más de 2 días de antigüedad</small>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-md-5 d-flex justify-content-center mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title mb-0">Resumen de Estado</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-light mb-3">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Archivos temporales</h5>
                                    <p class="card-text fs-3">{{ data.temp_files.count }}</p>
                                    <p class="card-text text-muted">{{ data.temp_files.total_size_mb }} MB</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light mb-3">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Tasa de aciertos caché</h5>
                                    <p class="card-text fs-3">{{ data.cache.hit_rate }}%</p>
                                    <p class="card-text text-muted">{{ data.cache.hit_count }} aciertos / {{ data.cache.miss_count }} fallos</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h5>Espacio en disco</h5>
                        <div class="progress">
                            {% if data.disk.percent < 70 %}
                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ data.disk.percent }}%;" aria-valuenow="{{ data.disk.percent }}" aria-valuemin="0" aria-valuemax="100">{{ data.disk.percent }}%</div>
                            {% elif data.disk.percent < 85 %}
                            <div class="progress-bar bg-warning" role="progressbar" style="width: {{ data.disk.percent }}%;" aria-valuenow="{{ data.disk.percent }}" aria-valuemin="0" aria-valuemax="100">{{ data.disk.percent }}%</div>
                            {% else %}
                            <div class="progress-bar bg-danger" role="progressbar" style="width: {{ data.disk.percent }}%;" aria-valuenow="{{ data.disk.percent }}" aria-valuemin="0" aria-valuemax="100">{{ data.disk.percent }}%</div>
                            {% endif %}
                        </div>
                        <small class="text-muted">
                            {{ data.disk.used_gb }} GB de {{ data.disk.total_gb }} GB utilizados
                        </small>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <h5 class="alert-heading">Última actualización</h5>
                        <p class="mb-0">{{ data.timestamp }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cleanupBtn = document.getElementById('cleanupTempBtn');
        if (cleanupBtn) {
            cleanupBtn.addEventListener('click', function() {
                if (confirm('¿Seguro que deseas eliminar los archivos temporales con más de 2 días de antigüedad?')) {
                    fetch('/admin/api/cleanup-temp', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: 'days=7'
                    })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                        location.reload();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al limpiar archivos temporales');
                    });
                }
            });
        }
    });
</script>
{% endblock %}
