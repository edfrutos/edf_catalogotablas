{% extends "base.html" %}
{% block title %}Editar Fila{% endblock %}
{% block content %}
<div class="container mt-4">
    <h1>Editar Fila de "{{ catalog.name }}"</h1>
    <form method="post" enctype="multipart/form-data">
        {% for header in headers %}
        {% if header != 'Imagen' %}
        <div class="mb-3">
            <label for="{{ header }}" class="form-label">{{ header }}</label>
            <input type="text" class="form-control" id="{{ header }}" name="{{ header }}" value="{{ fila[header] }}">
        </div>
        {% endif %}
        {% endfor %}
        
        <!-- üÜï CAMPO ESPECIAL PARA URL DE IMAGEN EXTERNA -->
        <!-- DEBUG_SIMPLE: _imagen_externa = {{ fila._imagen_externa }} -->
        {% if fila._imagen_externa %}
        <div class="mb-3">
            <label for="Imagen" class="form-label">URL de Imagen Externa</label>
            <input type="url" class="form-control" id="Imagen" name="Imagen" value="{{ fila._imagen_externa }}" 
                   placeholder="https://images.unsplash.com/...">
            <div class="form-text">
                <i class="bi bi-info-circle"></i> Esta es una imagen externa (ej: Unsplash). 
                Puedes cambiar la URL o eliminarla borrando el campo.
            </div>
        </div>
        {% else %}
        <!-- DEBUG_SIMPLE: NO hay imagen externa, _imagen_externa = {{ fila._imagen_externa }} -->
        {% endif %}
        <div class="mb-3">
            <label for="imagenes" class="form-label">Im√°genes (opcional)</label>
            <input type="file" class="form-control" id="imagenes" name="imagenes" multiple accept="image/*">
            <div class="form-text">Puede seleccionar m√∫ltiples im√°genes. Las nuevas im√°genes se a√±adir√°n a las existentes.</div>
        </div>
        <!-- üî•üî•üî• USAR IM√ÅGENES PROCESADAS POR EL BACKEND üî•üî•üî• -->
        {% set imagenes_procesadas = fila._imagenes_unificadas if fila._imagenes_unificadas else [] %}
        {% set imagen_externa = fila._imagen_externa if fila._imagen_externa else None %}
        
        <!-- DEBUG - VERSI√ìN SEGURA CONTRA ERRORES DE GENERADOR -->
        {% set num_imagenes = imagenes_procesadas|list|length if imagenes_procesadas else 0 %}
        <!-- IM√ÅGENES PROCESADAS: {{ num_imagenes }} ‚Üí {{ imagenes_procesadas|list }} -->
        <!-- IMAGEN EXTERNA: {{ imagen_externa }} -->
        
        {% if (imagenes_procesadas and imagenes_procesadas|length > 0) or imagen_externa %}
        <div class="mb-3">
            <label class="form-label">Im√°genes actuales</label>
            <div class="d-flex flex-wrap gap-3">
                {% for img in imagenes_procesadas %}
                <div class="position-relative">
                    <!-- Usar fallback S3 ‚Üí Local ‚Üí Error -->
                    <a href="#" onclick="mostrarImagenModal('https://edf-catalogo-tablas.s3.eu-central-1.amazonaws.com/{{ img }}'); return false;">
                        <img src="https://edf-catalogo-tablas.s3.eu-central-1.amazonaws.com/{{ img }}" alt="Imagen" style="width: 100px; height: 100px; object-fit: cover; border-radius: 4px; border: 1px solid #ccc;" onerror="this.src='/static/uploads/{{ img }}'; this.onerror=function(){this.src='/static/img/image-error.svg'};">
                    </a>
                    <div class="mt-1 text-center">
                        <button type="button" class="btn btn-sm btn-danger" onclick="confirmarEliminarImagen('{{ img|e }}', {{ loop.index0 }})">Eliminar</button>
                    </div>
                </div>
                {% endfor %}
                
                <!-- üÜï MOSTRAR IMAGEN EXTERNA (UNSPLASH) SIN OPCI√ìN DE ELIMINAR -->
                {% if imagen_externa %}
                <div class="position-relative">
                    <img src="{{ imagen_externa }}" alt="Imagen externa" 
                         style="width:100px; height:100px; object-fit:cover; border-radius:8px;"
                         onclick="mostrarImagenModal('{{ imagen_externa }}')">
                    <div class="position-absolute bottom-0 start-0 bg-warning text-dark px-2 py-1 small rounded-top-end">
                        <i class="bi bi-cloud"></i> Externa
                    </div>
                </div>
                {% endif %}
            </div>
            <input type="hidden" id="imagenes_a_eliminar" name="imagenes_a_eliminar" value="">
        </div>
        {% endif %}
        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        <a href="{{ url_for('main.ver_tabla', table_id=catalog._id|string) }}?page={{ ((fila_index // 10) + 1) }}" class="btn btn-secondary">Cancelar</a>
    </form>
</div>

<!-- Modal para visualizar im√°genes -->
<div class="modal fade" id="imagenModal" tabindex="-1" aria-labelledby="imagenModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imagenModalLabel">Visualizar Imagen</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="imagenModalSrc" src="" alt="Imagen" style="max-width: 100%; max-height: 80vh;">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmaci√≥n para eliminar imagen -->
<div class="modal fade" id="eliminarImagenModal" tabindex="-1" aria-labelledby="eliminarImagenModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="eliminarImagenModalLabel">Confirmar Eliminaci√≥n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>¬øEst√° seguro que desea eliminar esta imagen? Esta acci√≥n no se puede deshacer.</p>
        <div class="text-center">
          <img id="imagenAEliminar" src="" alt="Imagen a eliminar" style="max-width: 200px; max-height: 200px; object-fit: contain;">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" id="btnConfirmarEliminar">Eliminar</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
let imagenesAEliminar = [];
let imagenActual = '';
let indiceActual = -1;

function mostrarImagenModal(imagenUrl) {
    console.log('üñºÔ∏è Mostrando imagen en editar:', imagenUrl);
    
    const modalElement = document.getElementById('imagenModal');
    const modalImg = document.getElementById('imagenModalSrc');
    
    if (!modalElement || !modalImg) {
        console.error('‚ùå Elementos del modal no encontrados en editar');
        window.open(imagenUrl, '_blank');
        return;
    }
    
    // Verificar si Bootstrap est√° disponible
    if (typeof bootstrap === 'undefined') {
        console.error('‚ùå Bootstrap no est√° disponible en editar');
        window.open(imagenUrl, '_blank');
        return;
    }
    
    // Intentar cargar la imagen original
    const img = new Image();
    
    img.onload = function() {
        console.log('‚úÖ Imagen cargada exitosamente en editar');
        modalImg.src = imagenUrl;
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    };
    
    img.onerror = function() {
        console.log('‚ùå Error cargando imagen original en editar, intentando alternativas...');
        verificarImagenAlternativaEdit(imagenUrl, modalImg, modalElement);
    };
    
    img.src = imagenUrl;
}

function verificarImagenAlternativaEdit(imagenUrlOriginal, modalImg, modalElement) {
    let nombreArchivo = imagenUrlOriginal.split('/').pop();
    
    if (imagenUrlOriginal.includes('amazonaws.com')) {
        console.log('üîÑ Intentando versi√≥n local en editar...');
        const urlLocal = `/static/uploads/${nombreArchivo}`;
        probarImagenEdit(urlLocal, modalImg, modalElement);
    } else if (imagenUrlOriginal.includes('/static/uploads/')) {
        console.log('üîÑ Intentando versi√≥n S3 en editar...');
        const urlS3 = `https://edf-catalogo-tablas.s3.eu-central-1.amazonaws.com/${nombreArchivo}`;
        probarImagenEdit(urlS3, modalImg, modalElement);
    } else {
        mostrarImagenErrorEdit(modalImg, modalElement);
    }
}

function probarImagenEdit(url, modalImg, modalElement) {
    const img = new Image();
    
    img.onload = function() {
        console.log('‚úÖ Imagen alternativa cargada en editar:', url);
        modalImg.src = url;
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    };
    
    img.onerror = function() {
        console.log('‚ùå Imagen alternativa tambi√©n fall√≥ en editar:', url);
        mostrarImagenErrorEdit(modalImg, modalElement);
    };
    
    img.src = url;
}

function mostrarImagenErrorEdit(modalImg, modalElement) {
    console.log('‚ùå Mostrando imagen de error en editar');
    modalImg.src = '/static/img/image-error.svg';
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
}

function confirmarEliminarImagen(imagen, indice) {
  imagenActual = imagen;
  indiceActual = indice;
  
  // Mostrar la imagen en el modal de confirmaci√≥n
  let rutaImagen;
  if (imagen.startsWith('http')) {
    rutaImagen = imagen;
  } else {
    rutaImagen = "/imagenes_subidas/" + imagen;
  }
  document.getElementById('imagenAEliminar').src = rutaImagen;
  
  // Configurar el bot√≥n de confirmaci√≥n
  document.getElementById('btnConfirmarEliminar').onclick = function() {
    eliminarImagen(imagen, indice);
    bootstrap.Modal.getInstance(document.getElementById('eliminarImagenModal')).hide();
  };
  
  // Mostrar el modal
  const modal = new bootstrap.Modal(document.getElementById('eliminarImagenModal'));
  modal.show();
}

function eliminarImagen(imagen, indice) {
  // Agregar la imagen al array de im√°genes a eliminar
  if (!imagenesAEliminar.includes(imagen)) {
    imagenesAEliminar.push(imagen);
  }
  
  // Actualizar el campo oculto con las im√°genes a eliminar
  document.getElementById('imagenes_a_eliminar').value = JSON.stringify(imagenesAEliminar);
  
  // Ocultar visualmente la imagen eliminada
  const contenedorImagen = document.querySelectorAll('.position-relative')[indice];
  if (contenedorImagen) {
    contenedorImagen.style.display = 'none';
  }
}
</script>
{% endblock %}