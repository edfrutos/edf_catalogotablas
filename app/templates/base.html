<!DOCTYPE html>
<!-- eslint-disable -->
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}EDF CatálogoDeTablas{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/overflow-fix.css') }}?v={{ range(1, 10000) | random }}">


    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        body { background: #f8f9fa; }
        .navbar { margin-bottom: 2rem; }
        
        /* Estilos para corregir problemas de desplazamiento después de cerrar modales */
        body:not(.modal-open) {
          overflow: auto !important;
          padding-right: 0 !important;
        }
        
        /* Estilos para el botón de emergencia */
        .restore-scroll-button {
          opacity: 0.8;
          border-radius: 4px;
          box-shadow: 0 2px 5px rgba(0,0,0,0.3);
          font-size: 12px;
        }
        
        .restore-scroll-button:hover {
          opacity: 1;
        }
        
        /* Prevenir que los modales Bootstrap bloqueen el desplazamiento de forma permanente */
        .modal-open {
          overflow: hidden;
          padding-right: 0 !important; /* Evitar desplazamiento de la página */
        }
        
        /* Asegurar que los modales no afecten el desplazamiento global cuando están cerrados */
        .modal:not(.show) {
          display: none !important;
        }
        
        /* Eliminar cualquier backdrop de modal residual */
        .modal-backdrop:not(.show) {
          display: none !important;
        }
        
        /* Estilos específicos para iOS */
        @supports (-webkit-overflow-scrolling: touch) {
          body {
            -webkit-overflow-scrolling: touch;
          }
          
          body:not(.modal-open) {
            position: static !important;
          }
        }
    </style>
</head>
<body>
<!-- Configuración de depuración - Cargar lo antes posible para optimizar rendimiento -->
<script src="{{ url_for('static', filename='js/debug-config.js') }}?v={{ range(1, 10000) | random }}"></script>
{% include 'navbar.html' %}
<div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% set message_count = messages|length %}
        {% if message_count > 3 %}
          <!-- Mostrar solo los últimos 3 mensajes para evitar spam -->
          {% set start_index = message_count - 3 %}
          {% for category, message in messages %}
            {% if loop.index > start_index %}
              <div class="alert alert-{{ 'warning' if category=='error' else category }} alert-dismissible fade show mt-2" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
              </div>
            {% endif %}
          {% endfor %}
          <div class="alert alert-info alert-dismissible fade show mt-2" role="alert">
            <small>Se han omitido {{ message_count - 3 }} mensajes anteriores. <button type="button" class="btn-link p-0 border-0 bg-transparent" onclick="clearAllMessages()">Limpiar todos</button></small>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
          </div>
        {% else %}
          <!-- Mensajes limitados (3 o menos) -->
          {% for category, message in messages %}
            <div class="alert alert-{{ 'warning' if category=='error' else category }} alert-dismissible fade show mt-2" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
</div>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Función para limpiar todos los mensajes flash
function clearAllMessages() {
    // Cerrar todos los alerts visibles
    document.querySelectorAll('.alert').forEach(alert => {
        const bsAlert = new bootstrap.Alert(alert);
        bsAlert.close();
    });
    
    // Limpiar mensajes flash del servidor
    fetch('/clear-flash-messages', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    }).then(response => response.json())
      .then(data => {
          console.log('Mensajes flash limpiados del servidor');
      })
      .catch(error => {
          console.log('Error limpiando mensajes flash:', error);
      });
}

// Función para auto-limpiar mensajes implementada de manera controlada
function setupAutoClear() {
    // Esta función puede activarse cuando sea necesario
}
</script>

{% block scripts %}{% endblock %}
<!-- Botón Ir Arriba -->
<button type="button" id="goTopBtn" class="btn btn-primary btn-lg rounded-circle" style="position:fixed;bottom:32px;right:32px;z-index:1050;display:none;"><i class="bi bi-arrow-up"></i></button>

<!-- Modal para Imágenes -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">
                    <i class="bi bi-image"></i> Imagen
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid" alt="">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="downloadImage()">
                    <i class="fas fa-download"></i> Descargar
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Documentos -->
<div class="modal fade" id="documentModal" tabindex="-1" aria-labelledby="documentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="documentModalLabel">
                    <i class="fas fa-file"></i> Documento
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div id="documentContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="downloadDocument()">
                    <i class="fas fa-download"></i> Descargar
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Multimedia -->
<div class="modal fade" id="multimediaModal" tabindex="-1" aria-labelledby="multimediaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="multimediaModalLabel">
                    <i class="fas fa-video"></i> Multimedia
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div id="multimediaContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="downloadMultimedia()">
                    <i class="fas fa-download"></i> Descargar
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para resultados de scripts -->
<div class="modal fade" id="scriptResultModal" tabindex="-1" aria-labelledby="scriptResultModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="scriptResultModalLabel">Resultado de Script/Test</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" style="max-height:60vh;overflow:auto;">
        <pre id="scriptResultContent" style="white-space:pre-wrap;"></pre>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
<script>
// Mostrar botón Ir Arriba al hacer scroll
window.addEventListener('scroll', function() {
  const btn = document.getElementById('goTopBtn');
  if (window.scrollY > 200) {
    btn.style.display = 'block';
  } else {
    btn.style.display = 'none';
  }
});
document.getElementById('goTopBtn').onclick = function() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
};
</script>

<!-- Scripts de Bootstrap y funcionalidades básicas -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- Script unificado de modales (cargado una sola vez globalmente) -->
<script src="{{ url_for('static', filename='js/modal-functions-UNIFIED.js') }}?v={{ range(1, 10000) | random }}&t={{ range(1, 100000) | random }}&ts={{ range(1, 999999) | random }}&force={{ range(1000000, 9999999) | random }}&fix=20251007modal"></script>
<!-- Script de respaldo para funciones de modal (en caso de error) -->
<script src="{{ url_for('static', filename='js/modal-fixes.js') }}?v={{ range(1, 10000) | random }}&t={{ range(1, 100000) | random }}&ts={{ range(1, 999999) | random }}&emergency=true"></script>
<!-- Script de solución específica para modales multimedia -->
<script src="{{ url_for('static', filename='js/multimedia-modal-fix.js') }}?v={{ range(1, 10000) | random }}&t={{ range(1, 100000) | random }}&ts={{ range(1, 999999) | random }}&fix=20251007multimedia"></script>
<!-- Script de solución para problemas de overflow -->
<script src="{{ url_for('static', filename='js/overflow-fix.js') }}?v={{ range(1, 10000) | random }}&t={{ range(1, 100000) | random }}&fix=20251008overflow"></script>
<!-- Scripts de solución de problemas MP4 (cargados globalmente para evitar duplicaciones) -->
<script>
// Verificar si los scripts ya fueron cargados para evitar duplicaciones
if (!window.mp4ProblemSolverLoaded) {
    window.mp4ProblemSolverLoaded = true;
    // Cargar scripts dinámicamente para evitar problemas de sintaxis
    const script1 = document.createElement('script');
    script1.src = "{{ url_for('static', filename='js/mp4-problem-solver.js') }}?v={{ range(1, 10000) | random }}";
    document.head.appendChild(script1);
    
    const script2 = document.createElement('script');
    script2.src = "{{ url_for('static', filename='js/mp4-debug-fila5.js') }}?v={{ range(1, 10000) | random }}";
    document.head.appendChild(script2);
}
</script>

<!-- Script de inicialización temprana para corrección de overflow -->
<script>
// Verificación inicial de overflow para casos donde la página se carga con un modal oculto
document.addEventListener('DOMContentLoaded', function() {
    // Verificar si ya hay un modal que se quedó abierto incorrectamente
    setTimeout(function() {
        const bodyStyle = window.getComputedStyle(document.body);
        const isOverflowHidden = bodyStyle.overflow === 'hidden';
        const hasModalOpenClass = document.body.classList.contains('modal-open');
        const hasVisibleModal = document.querySelector('.modal.show') !== null;
        
        if ((isOverflowHidden || hasModalOpenClass) && !hasVisibleModal) {
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            document.body.classList.remove('modal-open');
            
            // Eliminar backdrops residuales
            document.querySelectorAll('.modal-backdrop').forEach(function(el) {
                el.remove();
            });
        }
    }, 500);
});
</script>

</body>
</html>
