{% extends "admin/base.html" %} 
{% block title %}Testing y Validación{% endblock %} 
{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
          <i class="bi bi-bug me-2"></i>Testing y Validación
        </h1>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary" onclick="refreshTests()">
            <i class="bi bi-arrow-clockwise"></i> Actualizar
          </button>
          <button class="btn btn-success" onclick="runAllTests()">
            <i class="bi bi-play-circle"></i> Ejecutar Todos
          </button>
          <a
            href="{{ url_for('scripts.tools_dashboard') }}"
            class="btn btn-outline-secondary"
          >
            <i class="bi bi-tools"></i> Herramientas
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Botones de documentación y herramientas -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="d-flex flex-wrap gap-2">
            <a class="btn btn-outline-primary" href="https://docs.pytest.org/en/stable/" target="_blank">
              <i class="bi bi-book"></i> Pytest Docs
            </a>
            <a class="btn btn-outline-success" href="https://pymongo.readthedocs.io/en/stable/examples/tls.html" target="_blank">
              <i class="bi bi-database"></i> MongoDB Testing
            </a>
            <a class="btn btn-outline-secondary" href="/dev-template/readme">
              <i class="bi bi-file-earmark-text"></i> Ver README
            </a>
            <button class="btn btn-outline-warning" id="update-tests-readme-btn">
              <i class="bi bi-arrow-repeat"></i> Actualizar README de tests
            </button>
            <a class="btn btn-outline-info" href="/dev-template/report">
              <i class="bi bi-download"></i> Descargar último reporte HTML
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Generador de plantilla de test -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-magic me-2"></i>Generador de plantilla de test para modelo/endpoint
          </h5>
        </div>
        <div class="card-body">
          <form id="test-template-generator-form" class="row g-3">
            <div class="col-md-8">
              <label for="model-endpoint-name" class="form-label">Nombre del modelo o endpoint</label>
              <input type="text" class="form-control" id="model-endpoint-name" placeholder="usuarios, productos, /api/mi_endpoint..." required>
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-lightning"></i> Generar plantilla
              </button>
            </div>
          </form>
          <div id="generated-template-block" style="display:none;" class="mt-3">
            <label class="form-label">Código sugerido:</label>
            <pre><code id="generated-template-code" class="language-python"></code></pre>
            <button class="btn btn-outline-success btn-sm mt-2" id="copy-template-btn">
              <i class="bi bi-clipboard"></i> Copiar código
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Barra de búsqueda -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="input-group">
            <span class="input-group-text">
              <i class="bi bi-search"></i>
            </span>
            <input
              type="text"
              class="form-control"
              id="test-search"
              placeholder="Buscar tests..."
            />
            <button
              class="btn btn-outline-secondary"
              type="button"
              onclick="clearSearch()"
            >
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Contenido principal -->
  <div class="row">
    <!-- Menú lateral -->
    <div class="col-md-3">
      <!-- Selección de Entorno -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-list me-2"></i>Entorno
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush" id="environment-menu">
            <button class="list-group-item list-group-item-action active" id="local-env-btn" onclick="selectEnvironment('local')">
              <i class="bi bi-laptop me-2"></i>Local
            </button>
            <button class="list-group-item list-group-item-action" id="production-env-btn" onclick="selectEnvironment('produccion')">
              <i class="bi bi-server me-2"></i>Producción
            </button>
          </div>
        </div>
      </div>
      
      <!-- Categorías del Entorno Seleccionado -->
      <div class="card mt-3" id="categories-card" style="display: none;">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-funnel me-2"></i>Categorías
            <button class="btn btn-sm btn-outline-secondary float-end" onclick="backToEnvironments()">
              <i class="bi bi-arrow-left"></i>
            </button>
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush" id="category-menu">
            <!-- Se llena dinámicamente -->
          </div>
        </div>
      </div>
    </div>

    <!-- Contenido de tests -->
    <div class="col-md-9">
      <!-- Vista de Selección de Entorno -->
      <div id="environment-selection-view">
        <div class="card">
          <div class="card-header">
            <h4 class="mb-0">
              <i class="bi bi-gear me-2"></i>Selecciona un Entorno
            </h4>
          </div>
          <div class="card-body text-center py-5">
            <div class="row">
              <div class="col-md-6">
                <div class="card border-primary">
                  <div class="card-body">
                    <i class="bi bi-laptop display-4 text-primary mb-3"></i>
                    <h5>Tests Locales</h5>
                    <p class="text-muted">Scripts y tests para desarrollo local</p>
                    <button class="btn btn-primary" onclick="selectEnvironment('local')">
                      Seleccionar Local
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card border-success">
                  <div class="card-body">
                    <i class="bi bi-server display-4 text-success mb-3"></i>
                    <h5>Tests de Producción</h5>
                    <p class="text-muted">Scripts y tests para entorno de producción</p>
                    <button class="btn btn-success" onclick="selectEnvironment('produccion')">
                      Seleccionar Producción
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Vista de Categorías -->
      <div id="categories-view" style="display: none;">
        <div class="card">
          <div class="card-header">
            <h4 class="mb-0">
              <i class="bi bi-funnel me-2"></i>Categorías de <span id="current-environment">Local</span>
            </h4>
          </div>
          <div class="card-body">
            <div id="categories-content">
              <!-- Se llena dinámicamente -->
            </div>
          </div>
        </div>
      </div>

      <!-- Vista de Scripts de Categoría -->
      <div id="scripts-view" style="display: none;">
        <div class="card">
          <div class="card-header">
            <h4 class="mb-0">
              <i class="bi bi-file-code me-2"></i>Scripts de <span id="current-category">Categoría</span>
              <button class="btn btn-sm btn-outline-secondary float-end" onclick="backToCategories()">
                <i class="bi bi-arrow-left"></i> Volver a Categorías
              </button>
            </h4>
          </div>
          <div class="card-body">
            <div id="scripts-content">
              <!-- Se llena dinámicamente -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de ejecución -->
<div class="modal fade" id="executionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="executionModalTitle">
          <i class="bi bi-play-circle me-2"></i>Ejecutando Test
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div id="executionProgress" class="text-center">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Ejecutando...</span>
          </div>
          <p class="mb-0">Ejecutando test...</p>
        </div>
        <div id="executionResult" style="display: none">
          <div class="mb-3">
            <h6>Resultado:</h6>
            <div id="executionStatus" class="alert"></div>
          </div>
          <div class="mb-3">
            <h6>Salida estándar:</h6>
            <pre id="executionStdout" class="bg-light p-3 rounded"></pre>
          </div>
          <div class="mb-3">
            <h6>Errores:</h6>
            <pre id="executionStderr" class="bg-light p-3 rounded"></pre>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de ejecución de todos los tests -->
<div class="modal fade" id="runAllModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-play-circle me-2"></i>Ejecutando Todos los Tests
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div id="runAllProgress" class="text-center">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Ejecutando...</span>
          </div>
          <p class="mb-0">Ejecutando todos los tests del proyecto...</p>
          <small class="text-muted">Esto puede tomar varios minutos</small>
        </div>
        <div id="runAllResult" style="display: none">
          <div class="mb-3">
            <h6>Resultado:</h6>
            <div id="runAllStatus" class="alert"></div>
          </div>
          <div class="mb-3">
            <h6>Salida completa:</h6>
            <pre
              id="runAllOutput"
              class="bg-light p-3 rounded"
              style="max-height: 400px; overflow-y: auto"
            ></pre>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para parámetros -->
<div class="modal fade" id="paramsModal" tabindex="-1" aria-labelledby="paramsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="paramsModalLabel">Ejecutar test con parámetros</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2"><strong id="paramsScriptName"></strong></div>
        <div class="mb-2 text-secondary small" id="paramsHelpBlock"></div>
        <input type="text" class="form-control" id="paramsInput" placeholder="Introduce parámetros, ej: --help" autocomplete="off">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="runWithParamsBtn">Ejecutar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %} 

{% block scripts %}
<script>
  let testsData = { local: [], produccion: [] };
  let currentEnvironment = null;
  let currentCategory = null;
  let currentTestPath = "";

  // Cargar tests al iniciar
  document.addEventListener("DOMContentLoaded", function () {
    loadTests();
    setupEventListeners();
  });

  // Función para cargar tests
  async function loadTests() {
    try {
      const response = await fetch("/dev-template/testing/api/tests_metadata", {
        credentials: "same-origin",
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      testsData = await response.json();
      showEnvironmentSelection();
    } catch (error) {
      console.error("Error cargando tests:", error);
      showNotification("Error", "No se pudieron cargar los tests", "error");
      // Cargar datos de ejemplo para mostrar la interfaz
      testsData = {
        local: [
          {
            categoria: "Integration Tests",
            tests: [
              {
                nombre: "test_admin_api.py",
                descripcion: "Tests de integración para la API de administración",
                path: "app/templates/dev_template/tests/integration/test_admin_api.py",
                tipo: "python",
                entorno: "local"
              }
            ]
          }
        ],
        produccion: [
          {
            categoria: "Production Maintenance",
            tests: [
              {
                nombre: "maintenance.sh",
                descripcion: "Script de mantenimiento de producción",
                path: "scripts/production/maintenance/maintenance.sh",
                tipo: "bash",
                entorno: "produccion"
              }
            ]
          }
        ]
      };
      showEnvironmentSelection();
    }
  }

  // Función para seleccionar entorno
  function selectEnvironment(environment) {
    currentEnvironment = environment;
    
    // Actualizar botones del menú lateral
    document.getElementById('local-env-btn').classList.remove('active');
    document.getElementById('production-env-btn').classList.remove('active');
    document.getElementById(environment === 'local' ? 'local-env-btn' : 'production-env-btn').classList.add('active');
    
    // Mostrar categorías del entorno seleccionado
    showCategories(environment);
  }

  // Función para mostrar categorías del entorno seleccionado
  function showCategories(environment) {
    // Ocultar vista de selección de entorno
    document.getElementById('environment-selection-view').style.display = 'none';
    
    // Mostrar menú de categorías
    document.getElementById('categories-card').style.display = 'block';
    
    // Mostrar vista de categorías
    document.getElementById('categories-view').style.display = 'block';
    document.getElementById('scripts-view').style.display = 'none';
    
    // Actualizar título del entorno
    document.getElementById('current-environment').textContent = 
      environment === 'local' ? 'Local' : 'Producción';
    
    // Renderizar categorías
    renderCategories(environment);
  }

  // Función para renderizar categorías
  function renderCategories(environment) {
    const categoriesContent = document.getElementById('categories-content');
    const categoryMenu = document.getElementById('category-menu');
    
    const environmentData = testsData[environment] || [];
    
    if (environmentData.length === 0) {
      categoriesContent.innerHTML = `
        <div class="alert alert-info">
          <h5><i class="bi bi-info-circle me-2"></i>No hay categorías disponibles</h5>
          <p class="mb-0">No se encontraron categorías en el entorno <strong>${environment === 'local' ? 'Local' : 'Producción'}</strong>.</p>
        </div>`;
      categoryMenu.innerHTML = '';
      return;
    }

    // Limpiar menú de categorías
    categoryMenu.innerHTML = '';
    
    // Crear contenido de categorías
    let html = '<div class="row">';
    
    environmentData.forEach((category, index) => {
      const testCount = category.tests ? category.tests.length : 0;
      
      html += `
        <div class="col-md-6 col-lg-4 mb-3">
          <div class="card h-100 border-primary">
            <div class="card-body text-center">
              <i class="bi bi-folder display-6 text-primary mb-3"></i>
              <h5 class="card-title">${category.categoria}</h5>
              <p class="card-text text-muted">${testCount} script${testCount !== 1 ? 's' : ''}</p>
              <button class="btn btn-primary" onclick="selectCategory('${category.categoria}')">
                Ver Scripts
              </button>
            </div>
          </div>
        </div>
      `;
      
      // Agregar al menú lateral
      const menuItem = document.createElement('button');
      menuItem.className = 'list-group-item list-group-item-action';
      menuItem.onclick = () => selectCategory(category.categoria);
      menuItem.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <span>${category.categoria}</span>
          <span class="badge bg-primary rounded-pill">${testCount}</span>
        </div>
      `;
      categoryMenu.appendChild(menuItem);
    });
    
    html += '</div>';
    categoriesContent.innerHTML = html;
  }

  // Función para seleccionar categoría
  function selectCategory(categoryName) {
    currentCategory = categoryName;
    
    // Ocultar vista de categorías
    document.getElementById('categories-view').style.display = 'none';
    
    // Mostrar vista de scripts
    document.getElementById('scripts-view').style.display = 'block';
    
    // Actualizar título de la categoría
    document.getElementById('current-category').textContent = categoryName;
    
    // Renderizar scripts de la categoría
    renderScripts(categoryName);
  }

  // Función para renderizar scripts de una categoría
  function renderScripts(categoryName) {
    const scriptsContent = document.getElementById('scripts-content');
    const environmentData = testsData[currentEnvironment] || [];
    
    const category = environmentData.find(cat => cat.categoria === categoryName);
    
    if (!category || !category.tests || category.tests.length === 0) {
      scriptsContent.innerHTML = `
        <div class="alert alert-info">
          <h5><i class="bi bi-info-circle me-2"></i>No hay scripts disponibles</h5>
          <p class="mb-0">No se encontraron scripts en la categoría <strong>${categoryName}</strong>.</p>
        </div>`;
      return;
    }

    let html = `
      <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center">
          <h5>${category.tests.length} script${category.tests.length !== 1 ? 's' : ''} encontrado${category.tests.length !== 1 ? 's' : ''}</h5>
          <div class="btn-group" role="group">
            <button class="btn btn-outline-primary btn-sm" onclick="runAllScriptsInCategory()">
              <i class="bi bi-play-circle me-1"></i>Ejecutar Todos
            </button>
          </div>
        </div>
      </div>
      <div class="list-group">
    `;

    category.tests.forEach((script) => {
      const tipoIcon = script.tipo === 'bash' ? 'bi-terminal' : 'bi-file-code';
      const tipoColor = script.tipo === 'bash' ? 'success' : 'info';
      
      html += `
        <div class="list-group-item d-flex justify-content-between align-items-start">
          <div class="ms-2 me-auto">
            <div class="fw-bold">
              <i class="bi ${tipoIcon} me-2"></i>
              ${script.nombre}
            </div>
            <div class="text-muted small">${script.descripcion}</div>
            <div class="mt-1">
              <span class="badge bg-${tipoColor} me-1">${script.tipo}</span>
              <span class="badge bg-secondary">${script.path}</span>
            </div>
          </div>
          <div class="btn-group" role="group">
            <button class="btn btn-outline-primary btn-sm" onclick="runScript('${script.path}')">
              <i class="bi bi-play me-1"></i>Ejecutar
            </button>
            <button class="btn btn-outline-info btn-sm" onclick="viewScriptDetails('${script.path}')">
              <i class="bi bi-eye me-1"></i>Ver
            </button>
          </div>
        </div>
      `;
    });

    html += '</div>';
    scriptsContent.innerHTML = html;
  }

  // Función para volver a la selección de entornos
  function backToEnvironments() {
    currentEnvironment = null;
    currentCategory = null;
    
    // Ocultar todas las vistas
    document.getElementById('environment-selection-view').style.display = 'block';
    document.getElementById('categories-view').style.display = 'none';
    document.getElementById('scripts-view').style.display = 'none';
    document.getElementById('categories-card').style.display = 'none';
    
    // Resetear botones
    document.getElementById('local-env-btn').classList.remove('active');
    document.getElementById('production-env-btn').classList.remove('active');
  }

  // Función para volver a las categorías
  function backToCategories() {
    currentCategory = null;
    
    // Ocultar vista de scripts
    document.getElementById('scripts-view').style.display = 'none';
    
    // Mostrar vista de categorías
    document.getElementById('categories-view').style.display = 'block';
  }

  // Función para mostrar la selección de entorno (vista inicial)
  function showEnvironmentSelection() {
    document.getElementById('environment-selection-view').style.display = 'block';
    document.getElementById('categories-view').style.display = 'none';
    document.getElementById('scripts-view').style.display = 'none';
    document.getElementById('categories-card').style.display = 'none';
  }

  // Función para ejecutar un script individual
  function runScript(scriptPath) {
    const executionModal = new bootstrap.Modal(document.getElementById('executionModal'));
    const executionTitle = document.getElementById('executionModalTitle');
    const executionProgress = document.getElementById('executionProgress');
    const executionResult = document.getElementById('executionResult');
    
    executionTitle.innerHTML = `<i class="bi bi-play-circle me-2"></i>Ejecutando: ${scriptPath.split('/').pop()}`;
    executionProgress.style.display = 'block';
    executionResult.style.display = 'none';
    executionModal.show();
    
    // Simular ejecución (aquí se conectaría con la API real)
    setTimeout(() => {
      executionProgress.style.display = 'none';
      executionResult.style.display = 'block';
      
      document.getElementById('executionStatus').innerHTML = `
        <div class="alert alert-success">
          <i class="bi bi-check-circle me-2"></i>Script ejecutado correctamente
        </div>
      `;
      
      document.getElementById('executionStdout').textContent = `Ejecutando: ${scriptPath}\nResultado: Éxito\nTiempo: 1.2s`;
      document.getElementById('executionStderr').textContent = '';
    }, 2000);
  }

  // Función para ejecutar todos los scripts de una categoría
  function runAllScriptsInCategory() {
    const runAllModal = new bootstrap.Modal(document.getElementById('runAllModal'));
    const runAllProgress = document.getElementById('runAllProgress');
    const runAllResult = document.getElementById('runAllResult');
    
    runAllProgress.style.display = 'block';
    runAllResult.style.display = 'none';
    runAllModal.show();
    
    // Simular ejecución de todos los scripts
    setTimeout(() => {
      runAllProgress.style.display = 'none';
      runAllResult.style.display = 'block';
      
      document.getElementById('runAllStatus').innerHTML = `
        <div class="alert alert-success">
          <i class="bi bi-check-circle me-2"></i>Todos los scripts ejecutados correctamente
        </div>
      `;
      
      const environmentData = testsData[currentEnvironment] || [];
      const category = environmentData.find(cat => cat.categoria === currentCategory);
      const output = category ? category.tests.map(script => 
        `[✓] ${script.nombre}: Ejecutado correctamente`
      ).join('\n') : 'No se encontraron scripts';
      
      document.getElementById('runAllOutput').textContent = output;
    }, 3000);
  }

  // Función para ver detalles de un script
  function viewScriptDetails(scriptPath) {
    const environmentData = testsData[currentEnvironment] || [];
    let script = null;
    
    // Buscar el script en todas las categorías del entorno actual
    for (const category of environmentData) {
      script = category.tests.find(s => s.path === scriptPath);
      if (script) break;
    }
    
    if (!script) {
      showNotification("Error", "No se encontró el script", "error");
      return;
    }
    
    // Mostrar detalles en un modal o alerta
    const details = `
      <strong>Nombre:</strong> ${script.nombre}
      <br><strong>Descripción:</strong> ${script.descripcion}
      <br><strong>Tipo:</strong> ${script.tipo}
      <br><strong>Ruta:</strong> ${script.path}
      <br><strong>Entorno:</strong> ${script.entorno}
    `;
    
    showNotification("Detalles del Script", details, "info");
  }

  // Función para mostrar notificaciones
  function showNotification(title, message, type = 'info') {
    const alertClass = type === 'error' ? 'alert-danger' : 
                      type === 'success' ? 'alert-success' : 
                      type === 'warning' ? 'alert-warning' : 'alert-info';
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
      <strong>${title}</strong><br>
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remover después de 5 segundos
    setTimeout(() => {
      if (notification.parentNode) {
        notification.remove();
      }
    }, 5000);
  }

  // Función para ejecutar todos los tests
  async function runAllTests() {
    const modal = new bootstrap.Modal(document.getElementById("runAllModal"));
    const progress = document.getElementById("runAllProgress");
    const result = document.getElementById("runAllResult");
    const status = document.getElementById("runAllStatus");
    const output = document.getElementById("runAllOutput");

    // Mostrar modal
    progress.style.display = "block";
    result.style.display = "none";
    modal.show();

    try {
      const response = await fetch("/dev-template/testing/run-all", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Requested-With": "XMLHttpRequest",
        },
        credentials: "same-origin",
      });

      const data = await response.json();

      // Ocultar progreso y mostrar resultado
      progress.style.display = "none";
      result.style.display = "block";

      // Configurar estado
      if (data.status === "success") {
        status.className = "alert alert-success";
        status.innerHTML = `<i class="bi bi-check-circle me-2"></i>${data.message}`;
      } else {
        status.className = "alert alert-danger";
        status.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>${data.message || data.error}`;
      }

      // Mostrar salida
      const fullOutput = (data.stdout || "") + (data.stderr || "");
      output.textContent = fullOutput || "(Sin salida)";
    } catch (error) {
      progress.style.display = "none";
      result.style.display = "block";

      status.className = "alert alert-danger";
      status.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>Error de conexión: ${error.message}`;
      output.textContent = "(Error de conexión)";
    }
  }

  // Función para limpiar búsqueda
  function clearSearch() {
    const searchInput = document.getElementById("test-search");
    if (searchInput) {
      searchInput.value = "";
      searchInput.dispatchEvent(new Event("input"));
    }
  }

  // Función para refrescar tests
  function refreshTests() {
    loadTests();
  }

  // Configurar event listeners
  function setupEventListeners() {
    // Actualizar README de tests
    const updateTestsReadmeBtn = document.getElementById("update-tests-readme-btn");
    if (updateTestsReadmeBtn) {
      updateTestsReadmeBtn.addEventListener("click", async function() {
        try {
          const response = await fetch("/dev-template/api/update-tests-readme", {
            method: "POST",
            headers: { "Content-Type": "application/json" }
          });
          const data = await response.json();
          
          if (data.success) {
            showNotification("Éxito", "README de tests actualizado correctamente", "success");
          } else {
            showNotification("Error", data.error || "Error al actualizar README", "error");
          }
        } catch (error) {
          showNotification("Error", "Error de conexión al actualizar README", "error");
        }
      });
    }

    // Generador de plantilla de test
    const testTemplateGeneratorForm = document.getElementById("test-template-generator-form");
    if (testTemplateGeneratorForm) {
      testTemplateGeneratorForm.addEventListener("submit", async function(e) {
        e.preventDefault();
        
        const name = document.getElementById("model-endpoint-name").value.trim();
        if (!name) {
          showNotification("Error", "Por favor ingresa un nombre", "error");
          return;
        }

        try {
          const response = await fetch("/dev-template/generate-test-template", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: name })
          });
          const data = await response.json();
          
          if (data.success) {
            document.getElementById("generated-template-code").textContent = data.code;
            document.getElementById("generated-template-block").style.display = "block";
            showNotification("Éxito", "Plantilla generada correctamente", "success");
          } else {
            showNotification("Error", data.error || "Error al generar plantilla", "error");
          }
        } catch (error) {
          showNotification("Error", "Error de conexión al generar plantilla", "error");
        }
      });
    }

    // Copiar código generado
    const copyTemplateBtn = document.getElementById("copy-template-btn");
    if (copyTemplateBtn) {
      copyTemplateBtn.addEventListener("click", function() {
        const code = document.getElementById("generated-template-code").textContent;
        navigator.clipboard.writeText(code).then(() => {
          showNotification("Éxito", "Código copiado al portapapeles", "success");
        }).catch(() => {
          showNotification("Error", "No se pudo copiar el código", "error");
        });
      });
    }

    // Ejecutar test con parámetros
    const runWithParamsBtn = document.getElementById("runWithParamsBtn");
    if (runWithParamsBtn) {
      runWithParamsBtn.addEventListener("click", async function() {
        const params = document.getElementById("paramsInput").value.trim();
        
        try {
          const response = await fetch("/dev-template/run-test", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              test_file: currentTestPath,
              params: params
            })
          });
          const data = await response.json();
          
          // Cerrar modal
          bootstrap.Modal.getInstance(document.getElementById("paramsModal")).hide();
          
          // Mostrar resultado
          showNotification("Test ejecutado", "Revisa la consola para ver el resultado", "info");
          console.log("Resultado del test:", data);
          
        } catch (error) {
          showNotification("Error", "Error al ejecutar test con parámetros", "error");
        }
      });
    }

    // Búsqueda de tests
    const testSearch = document.getElementById("test-search");
    if (testSearch) {
      testSearch.addEventListener("input", function (e) {
        const searchTerm = e.target.value.toLowerCase();
        // Implementar lógica de búsqueda si es necesario
      });
    }
  }

  // Función para mostrar modal de parámetros
  function showParamsModal(testPath, testName) {
    currentTestPath = testPath;
    document.getElementById("paramsScriptName").textContent = testName;
    document.getElementById("paramsInput").value = "";
    document.getElementById("paramsHelpBlock").textContent = "Ingresa parámetros adicionales para el test (opcional)";
    
    const modal = new bootstrap.Modal(document.getElementById("paramsModal"));
    modal.show();
  }
</script>
{% endblock %}
