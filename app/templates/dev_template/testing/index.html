{% extends "admin/base.html" %} {% block title %}Testing y Validación{% endblock
%} {% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
          <i class="bi bi-bug me-2"></i>Testing y Validación
        </h1>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary" onclick="refreshTests()">
            <i class="bi bi-arrow-clockwise"></i> Actualizar
          </button>
          <button class="btn btn-success" onclick="runAllTests()">
            <i class="bi bi-play-circle"></i> Ejecutar Todos
          </button>
          <a
            href="{{ url_for('scripts.tools_dashboard') }}"
            class="btn btn-outline-secondary"
          >
            <i class="bi bi-tools"></i> Herramientas
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Barra de búsqueda -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="input-group">
            <span class="input-group-text">
              <i class="bi bi-search"></i>
            </span>
            <input
              type="text"
              class="form-control"
              id="test-search"
              placeholder="Buscar tests..."
            />
            <button
              class="btn btn-outline-secondary"
              type="button"
              onclick="clearSearch()"
            >
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Contenido principal -->
  <div class="row">
    <!-- Menú lateral -->
    <div class="col-md-3">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-list me-2"></i>Entornos de Tests
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush" id="environment-menu">
            <a href="#local-tests" class="list-group-item list-group-item-action active" data-bs-toggle="list">
              <i class="bi bi-laptop me-2"></i>Tests Locales
            </a>
            <a href="#production-tests" class="list-group-item list-group-item-action" data-bs-toggle="list">
              <i class="bi bi-server me-2"></i>Tests de Producción
            </a>
          </div>
        </div>
      </div>
      
      <div class="card mt-3">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-funnel me-2"></i>Categorías
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush" id="category-menu">
            <!-- Se llena dinámicamente -->
          </div>
        </div>
      </div>
    </div>

    <!-- Contenido de tests -->
    <div class="col-md-9">
      <div id="tests-content">
        <!-- Pestaña de Tests Locales -->
        <div class="tab-pane fade show active" id="local-tests">
          <div class="card">
            <div class="card-header">
              <h4 class="mb-0">
                <i class="bi bi-laptop me-2"></i>Tests Locales
              </h4>
            </div>
            <div class="card-body">
              <div id="local-tests-content">
                <!-- Se llena dinámicamente -->
              </div>
            </div>
          </div>
        </div>
        
        <!-- Pestaña de Tests de Producción -->
        <div class="tab-pane fade" id="production-tests">
          <div class="card">
            <div class="card-header">
              <h4 class="mb-0">
                <i class="bi bi-server me-2"></i>Tests de Producción
              </h4>
            </div>
            <div class="card-body">
              <div id="production-tests-content">
                <!-- Se llena dinámicamente -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de ejecución -->
<div class="modal fade" id="executionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="executionModalTitle">
          <i class="bi bi-play-circle me-2"></i>Ejecutando Test
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div id="executionProgress" class="text-center">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Ejecutando...</span>
          </div>
          <p class="mb-0">Ejecutando test...</p>
        </div>
        <div id="executionResult" style="display: none">
          <div class="mb-3">
            <h6>Resultado:</h6>
            <div id="executionStatus" class="alert"></div>
          </div>
          <div class="mb-3">
            <h6>Salida estándar:</h6>
            <pre id="executionStdout" class="bg-light p-3 rounded"></pre>
          </div>
          <div class="mb-3">
            <h6>Errores:</h6>
            <pre id="executionStderr" class="bg-light p-3 rounded"></pre>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de ejecución de todos los tests -->
<div class="modal fade" id="runAllModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-play-circle me-2"></i>Ejecutando Todos los Tests
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div id="runAllProgress" class="text-center">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Ejecutando...</span>
          </div>
          <p class="mb-0">Ejecutando todos los tests del proyecto...</p>
          <small class="text-muted">Esto puede tomar varios minutos</small>
        </div>
        <div id="runAllResult" style="display: none">
          <div class="mb-3">
            <h6>Resultado:</h6>
            <div id="runAllStatus" class="alert"></div>
          </div>
          <div class="mb-3">
            <h6>Salida completa:</h6>
            <pre
              id="runAllOutput"
              class="bg-light p-3 rounded"
              style="max-height: 400px; overflow-y: auto"
            ></pre>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  let testsData = { local: [], produccion: [] };

  // Cargar tests al iniciar
  document.addEventListener("DOMContentLoaded", function () {
    loadTests();
  });

  // Función para cargar tests
  async function loadTests() {
    try {
      const response = await fetch("/dev-template/testing/api/tests_metadata", {
        credentials: "same-origin",
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      testsData = await response.json();
      renderTests();
    } catch (error) {
      console.error("Error cargando tests:", error);
      showNotification("Error", "No se pudieron cargar los tests", "error");
    }
  }

  // Función para renderizar tests
  function renderTests() {
    const categoryMenu = document.getElementById("category-menu");
    const localTestsContent = document.getElementById("local-tests-content");
    const productionTestsContent = document.getElementById("production-tests-content");

    // Limpiar contenido
    categoryMenu.innerHTML = "";
    localTestsContent.innerHTML = "";
    productionTestsContent.innerHTML = "";

    // Obtener todas las categorías únicas
    const allCategories = new Set();
    testsData.local.forEach(cat => allCategories.add(cat.categoria));
    testsData.produccion.forEach(cat => allCategories.add(cat.categoria));

    // Crear menú de categorías
    Array.from(allCategories).forEach((category, index) => {
      const menuItem = document.createElement("a");
      menuItem.href = `#cat-${index}`;
      menuItem.className = `list-group-item list-group-item-action ${index === 0 ? "active" : ""}`;
      menuItem.setAttribute("data-bs-toggle", "list");
      menuItem.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <span>${category}</span>
                <span class="badge bg-primary rounded-pill">${getTestCountForCategory(category)}</span>
            </div>
        `;
      categoryMenu.appendChild(menuItem);
    });

    // Renderizar tests locales
    renderEnvironmentTests(localTestsContent, testsData.local, "local");
    
    // Renderizar tests de producción
    renderEnvironmentTests(productionTestsContent, testsData.produccion, "produccion");
  }

  // Función para obtener el conteo de tests por categoría
  function getTestCountForCategory(category) {
    let count = 0;
    testsData.local.forEach(cat => {
      if (cat.categoria === category) count += cat.tests.length;
    });
    testsData.produccion.forEach(cat => {
      if (cat.categoria === category) count += cat.tests.length;
    });
    return count;
  }

  // Función para renderizar tests de un entorno específico
  function renderEnvironmentTests(container, tests, environment) {
    if (tests.length === 0) {
      container.innerHTML = '<div class="alert alert-info">No hay tests disponibles en este entorno.</div>';
      return;
    }

    let html = "";
    tests.forEach((category) => {
      if (category.tests && category.tests.length > 0) {
        html += `
          <div class="mb-4">
            <h5 class="text-primary">
              <i class="bi bi-folder me-2"></i>${category.categoria}
            </h5>
            <div class="list-group">
        `;

        category.tests.forEach((test) => {
          html += `
            <div class="list-group-item d-flex justify-content-between align-items-start">
              <div class="ms-2 me-auto">
                <div class="fw-bold">
                  <i class="bi bi-file-code me-2"></i>
                  ${test.nombre}
                </div>
                <div class="text-muted small">${test.descripcion}</div>
                <div class="mt-1">
                  <span class="badge bg-info me-1">${test.tipo}</span>
                  <span class="badge bg-secondary">${test.entorno}</span>
                </div>
              </div>
              <div class="btn-group" role="group">
                <button type="button" class="btn btn-primary btn-sm" onclick="executeTest('${test.path}')">
                  <i class="bi bi-play"></i> Ejecutar
                </button>
              </div>
            </div>
          `;
        });

        html += `
            </div>
          </div>
        `;
      }
    });

    container.innerHTML = html;
  }

  // Función para ejecutar test individual
  async function executeTest(testPath) {
    const modal = new bootstrap.Modal(
      document.getElementById("executionModal")
    );
    const title = document.getElementById("executionModalTitle");
    const progress = document.getElementById("executionProgress");
    const result = document.getElementById("executionResult");
    const status = document.getElementById("executionStatus");
    const stdout = document.getElementById("executionStdout");
    const stderr = document.getElementById("executionStderr");

    // Mostrar modal
    title.innerHTML = `<i class="bi bi-play-circle me-2"></i>Ejecutando: ${testPath.split("/").pop()}`;
    progress.style.display = "block";
    result.style.display = "none";
    modal.show();

    try {
      const response = await fetch(
        `/dev-template/testing/run/${encodeURIComponent(testPath)}`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest",
          },
          credentials: "same-origin",
        }
      );

      const data = await response.json();

      // Ocultar progreso y mostrar resultado
      progress.style.display = "none";
      result.style.display = "block";

      // Configurar estado
      if (data.status === "success") {
        status.className = "alert alert-success";
        status.innerHTML = `<i class="bi bi-check-circle me-2"></i>${data.message}`;
      } else {
        status.className = "alert alert-danger";
        status.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>${data.message || data.error}`;
      }

      // Mostrar salida
      stdout.textContent = data.stdout || "(Sin salida)";
      stderr.textContent = data.stderr || "(Sin errores)";
    } catch (error) {
      progress.style.display = "none";
      result.style.display = "block";

      status.className = "alert alert-danger";
      status.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>Error de conexión: ${error.message}`;
      stdout.textContent = "(Error de conexión)";
      stderr.textContent = error.message;
    }
  }

  // Función para ejecutar todos los tests
  async function runAllTests() {
    const modal = new bootstrap.Modal(document.getElementById("runAllModal"));
    const progress = document.getElementById("runAllProgress");
    const result = document.getElementById("runAllResult");
    const status = document.getElementById("runAllStatus");
    const output = document.getElementById("runAllOutput");

    // Mostrar modal
    progress.style.display = "block";
    result.style.display = "none";
    modal.show();

    try {
      const response = await fetch("/dev-template/testing/run-all", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Requested-With": "XMLHttpRequest",
        },
        credentials: "same-origin",
      });

      const data = await response.json();

      // Ocultar progreso y mostrar resultado
      progress.style.display = "none";
      result.style.display = "block";

      // Configurar estado
      if (data.status === "success") {
        status.className = "alert alert-success";
        status.innerHTML = `<i class="bi bi-check-circle me-2"></i>${data.message}`;
      } else {
        status.className = "alert alert-danger";
        status.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>${data.message || data.error}`;
      }

      // Mostrar salida
      const fullOutput = (data.stdout || "") + (data.stderr || "");
      output.textContent = fullOutput || "(Sin salida)";
    } catch (error) {
      progress.style.display = "none";
      result.style.display = "block";

      status.className = "alert alert-danger";
      status.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>Error de conexión: ${error.message}`;
      output.textContent = "(Error de conexión)";
    }
  }

  // Función para buscar tests
  document
    .getElementById("test-search")
    .addEventListener("input", function (e) {
      const searchTerm = e.target.value.toLowerCase();

      // Filtrar categorías
      const allCategories = new Set();
      testsData.local.forEach(cat => allCategories.add(cat.categoria));
      testsData.produccion.forEach(cat => allCategories.add(cat.categoria));

      Array.from(allCategories).forEach((category, categoryIndex) => {
        const categoryContent = document.getElementById(`cat-${categoryIndex}`);
        const menuItem = document.querySelector(
          `[href="#cat-${categoryIndex}"]`
        );

        const visibleTests = [];
        testsData.local.forEach(cat => {
          if (cat.categoria === category) {
            visibleTests.push(...cat.tests.filter(test =>
              test.nombre.toLowerCase().includes(searchTerm) ||
              test.descripcion.toLowerCase().includes(searchTerm)
            ));
          }
        });
        testsData.produccion.forEach(cat => {
          if (cat.categoria === category) {
            visibleTests.push(...cat.tests.filter(test =>
              test.nombre.toLowerCase().includes(searchTerm) ||
              test.descripcion.toLowerCase().includes(searchTerm)
            ));
          }
        });

        if (visibleTests.length > 0) {
          categoryContent.style.display = "block";
          menuItem.style.display = "block";

          // Actualizar contador
          const badge = menuItem.querySelector(".badge");
          badge.textContent = visibleTests.length;
        } else {
          categoryContent.style.display = "none";
          menuItem.style.display = "none";
        }
      });
    });

  // Función para limpiar búsqueda
  function clearSearch() {
    document.getElementById("test-search").value = "";
    document.getElementById("test-search").dispatchEvent(new Event("input"));
  }

  // Función para refrescar tests
  function refreshTests() {
    loadTests();
  }

  // Función para mostrar notificaciones
  function showNotification(title, message, type = "info") {
    const alertClass =
      type === "success"
        ? "alert-success"
        : type === "error"
          ? "alert-danger"
          : type === "warning"
            ? "alert-warning"
            : "alert-info";

    const alert = document.createElement("div");
    alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    alert.style.cssText =
      "top: 20px; right: 20px; z-index: 9999; min-width: 300px;";
    alert.innerHTML = `
        <strong>${title}</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alert);

    // Auto-remover después de 5 segundos
    setTimeout(() => {
      if (alert.parentNode) {
        alert.remove();
      }
    }, 5000);
  }
</script>
{% endblock %}
