{% extends 'base.html' %} {% block title %}Mantenimiento del Sistema{% endblock
%} {% block content %}
<div class="container mt-4">
  <h1>Panel de Mantenimiento</h1>

  <div class="row">
    <div class="col-md-6 mb-4">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h4 class="card-title mb-0">Herramientas de Mantenimiento</h4>
        </div>
        <div class="card-body">
          <div class="list-group">
            <a
              href="{{ url_for('admin.system_status') }}"
              class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
            >
              <div>
                <i class="bi bi-graph-up"></i> Estado del sistema
                <small class="d-block text-muted"
                  >Monitorear rendimiento y recursos</small
                >
              </div>
            </a>
            <a
              href="{{ url_for('admin.notification_settings') }}"
              class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
            >
              <div>
                <i class="bi bi-bell"></i> Configuración de alertas
                <small class="d-block text-muted"
                  >Configurar notificaciones por email</small
                >
              </div>
              <span class="badge bg-primary rounded-pill">Ver</span>
            </a>
            <a
              href="{{ url_for('admin.backup_json') }}"
              class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
            >
              <div>
                <i class="bi bi-download"></i> Exportar catálogo (JSON)
                <small class="d-block text-muted"
                  >Backup completo en formato JSON</small
                >
              </div>
              <span class="badge bg-success rounded-pill">Descargar</span>
            </a>
            <a
              href="{{ url_for('admin.backup_csv') }}"
              class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
            >
              <div>
                <i class="bi bi-file-earmark-spreadsheet"></i> Exportar catálogo
                (CSV)
                <small class="d-block text-muted"
                  >Backup en formato CSV para hojas de cálculo</small
                >
              </div>
              <span class="badge bg-success rounded-pill">Descargar</span>
            </a>
            <a
              href="{{ url_for('admin.cleanup_resets') }}"
              class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
            >
              <div>
                <i class="bi bi-trash"></i> Limpiar tokens de recuperación
                <small class="d-block text-muted"
                  >Eliminar tokens utilizados o caducados</small
                >
              </div>
              <span class="badge bg-warning rounded-pill">Limpiar</span>
            </a>
            <a
              href="{{ url_for('admin.verify_users') }}"
              class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
            >
              <div>
                <i class="bi bi-people"></i> Verificar usuarios y roles
                <small class="d-block text-muted"
                  >Comprobar la configuración de cada usuario</small
                >
              </div>
              <span class="badge bg-info rounded-pill">Verificar</span>
            </a>
            <a
              href="{{ url_for('admin.backups_list') }}"
              class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
            >
              <div>
                <i class="bi bi-hdd-stack"></i> Gestionar backups existentes
                <small class="d-block text-muted"
                  >Descargar o eliminar backups manualmente</small
                >
              </div>
              <span class="badge bg-secondary rounded-pill">Gestionar</span>
            </a>
            <button
              id="cleanupTempBtn"
              class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
            >
              <div>
                <i class="bi bi-trash"></i> Eliminar archivos temporales
                <small class="d-block text-muted"
                  >Limpiar archivos con más de 2 días de antigüedad</small
                >
              </div>
              <span class="badge bg-danger rounded-pill">Ejecutar</span>
            </button>
            <div class="list-group-item">
              <form
                action="{{ url_for('admin.cleanup_old_backups') }}"
                method="post"
                class="row g-2 align-items-end"
              >
                <div class="col-auto">
                  <label for="days" class="form-label mb-0"
                    >Eliminar backups con más de</label
                  >
                </div>
                <div class="col-auto">
                  <input
                    type="number"
                    min="1"
                    max="365"
                    class="form-control"
                    id="days"
                    name="days"
                    value="30"
                    style="width: 5em"
                  />
                </div>
                <div class="col-auto">
                  <label class="form-label mb-0">días</label>
                </div>
                <div class="col-auto">
                  <label for="max_files" class="form-label mb-0"
                    >o mantener máximo</label
                  >
                </div>
                <div class="col-auto">
                  <input
                    type="number"
                    min="1"
                    max="100"
                    class="form-control"
                    id="max_files"
                    name="max_files"
                    value="20"
                    style="width: 5em"
                  />
                </div>
                <div class="col-auto">
                  <label class="form-label mb-0">archivos</label>
                </div>
                <div class="col-auto">
                  <button type="submit" class="btn btn-danger">
                    Limpiar backups antiguos
                  </button>
                </div>
              </form>
              <div class="mt-2 small text-muted">
                <i class="bi bi-info-circle"></i> Se eliminarán los backups más
                antiguos según los criterios indicados. Los archivos recientes
                se mantienen.
              </div>
            </div>
            <form
              action="{{ url_for('admin.reset_gdrive_token_route') }}"
              method="post"
              class="mt-2"
            >
              <button
                type="submit"
                class="list-group-item list-group-item-action d-flex justify-content-between align-items-center text-danger"
              >
                <div>
                  <i class="bi bi-google"></i> Resetear token de Google Drive
                  <small class="d-block text-muted"
                    >Borrar y regenerar el refresh_token para backups en
                    Drive</small
                  >
                </div>
                <span class="badge bg-danger rounded-pill">Reset</span>
              </button>
            </form>
            <!-- Botón para abrir el modal de subida de prueba a Google Drive -->
            <button
              type="button"
              class="list-group-item list-group-item-action d-flex justify-content-between align-items-center text-primary"
              data-bs-toggle="modal"
              data-bs-target="#gdriveUploadModal"
            >
              <div>
                <i class="bi bi-cloud-upload"></i> Subida de prueba a Google
                Drive
                <small class="d-block text-muted"
                  >Selecciona uno o varios archivos para probar la subida</small
                >
              </div>
              <span class="badge bg-primary rounded-pill">Test</span>
            </button>
            <div class="list-group-item mt-3">
              <form action="{{ url_for('admin.truncate_log_route') }}" method="post" class="row g-2 align-items-end">
                <div class="col-auto">
                  <label for="log_file" class="form-label mb-0">Archivo de log:</label>
                </div>
                <div class="col-auto">
                  <input type="text" class="form-control" id="log_file" name="log_file" value="logs/flask_debug.log" style="width: 18em" required />
                </div>
                <div class="col-auto">
                  <label for="lines" class="form-label mb-0">Últimas</label>
                </div>
                <div class="col-auto">
                  <input type="number" min="10" max="100000" class="form-control" id="lines" name="lines" placeholder="N líneas" style="width: 7em" />
                </div>
                <div class="col-auto">
                  <label class="form-label mb-0">o desde fecha</label>
                </div>
                <div class="col-auto">
                  <input type="date" class="form-control" id="date" name="date" style="width: 12em" />
                </div>
                <div class="col-auto">
                  <button type="submit" class="btn btn-warning">Truncar log</button>
                </div>
              </form>
              <div class="mt-2 small text-muted">
                <i class="bi bi-info-circle"></i> Puedes truncar el log a las últimas N líneas o desde una fecha concreta (YYYY-MM-DD).
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6 mb-4">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h4 class="card-title mb-0">Resumen de Estado</h4>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="card bg-light mb-3">
                <div class="card-body text-center">
                  <h5 class="card-title">Archivos temporales</h5>
                  <p class="card-text fs-3">{{ data.temp_files.count }}</p>
                  <p class="card-text text-muted">
                    {{ data.temp_files.total_size_mb }} MB
                  </p>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card bg-light mb-3">
                <div class="card-body text-center">
                  <h5 class="card-title">Tasa de aciertos caché</h5>
                  <p class="card-text fs-3">{{ data.cache.hit_rate }}%</p>
                  <p class="card-text text-muted">
                    {{ data.cache.hit_count }} aciertos / {{
                    data.cache.miss_count }} fallos
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <h5>Espacio en disco</h5>
            <div class="progress">
              {% if data.disk.percent < 70 %}
              <div
                class="progress-bar bg-success"
                role="progressbar"
                style="width: {{ data.disk.percent }}%;"
                aria-valuenow="{{ data.disk.percent }}"
                aria-valuemin="0"
                aria-valuemax="100"
              >
                {{ data.disk.percent }}%
              </div>
              {% elif data.disk.percent < 85 %}
              <div
                class="progress-bar bg-warning"
                role="progressbar"
                style="width: {{ data.disk.percent }}%;"
                aria-valuenow="{{ data.disk.percent }}"
                aria-valuemin="0"
                aria-valuemax="100"
              >
                {{ data.disk.percent }}%
              </div>
              {% else %}
              <div
                class="progress-bar bg-danger"
                role="progressbar"
                style="width: {{ data.disk.percent }}%;"
                aria-valuenow="{{ data.disk.percent }}"
                aria-valuemin="0"
                aria-valuemax="100"
              >
                {{ data.disk.percent }}%
              </div>
              {% endif %}
            </div>
            <small class="text-muted">
              {{ data.disk.used_gb }} GB de {{ data.disk.total_gb }} GB
              utilizados
            </small>
          </div>

          <div class="alert alert-info mt-3">
            <h5 class="alert-heading">Última actualización</h5>
            <p class="mb-0">{{ data.timestamp }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de subida de archivos a Google Drive -->
<div
  class="modal fade"
  id="gdriveUploadModal"
  tabindex="-1"
  aria-labelledby="gdriveUploadModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <form
        action="{{ url_for('admin.gdrive_upload_test') }}"
        method="post"
        enctype="multipart/form-data"
      >
        <div class="modal-header">
          <h5 class="modal-title" id="gdriveUploadModalLabel">
            Subida de prueba a Google Drive
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Cerrar"
          ></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="test_files" class="form-label"
              >Selecciona uno o varios archivos:</label
            >
            <input
              class="form-control"
              type="file"
              id="test_files"
              name="test_files"
              multiple
              required
            />
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary">
            Subir a Google Drive
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const cleanupBtn = document.getElementById("cleanupTempBtn");
    if (cleanupBtn) {
      cleanupBtn.addEventListener("click", function () {
        if (
          confirm(
            "¿Seguro que deseas eliminar los archivos temporales con más de 2 días de antigüedad?"
          )
        ) {
          fetch("/admin/api/cleanup-temp", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: "days=7",
          })
            .then((response) => response.json())
            .then((data) => {
              alert(data.message);
              location.reload();
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("Error al limpiar archivos temporales");
            });
        }
      });
    }
  });
</script>
{% endblock %}
