{% extends 'admin/base.html' %}

{% block title %}Mantenimiento del Sistema{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Panel de Mantenimiento</h1>
    
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title mb-0">Normalización de usuarios en la base de datos</h4>
                </div>
                <div class="card-body">
                    {% if applied %}
                        <div class="alert alert-success">Normalización aplicada correctamente.</div>
                        <p>Backup previo: <code>{{ backup_file }}</code></p>
                        <p>Usuarios totales: {{ summary.total_users }}</p>
                        <p>Usuarios modificados: {{ summary.users_changed }}</p>
                        {% if summary.changes %}
                            <h4>Ejemplos de cambios:</h4>
                            <pre style="max-height:300px;overflow:auto;">{{ summary.changes|tojson(indent=2) }}</pre>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-warning">
                            <b>Advertencia:</b> Esta acción modificará los datos de usuarios en la base de datos, eliminando espacios y unificando mayúsculas/minúsculas.<br>
                            Se realizará un backup automático antes de aplicar los cambios.
                        </div>
                        <p>Usuarios totales: {{ summary.total_users }}</p>
                        <p>Usuarios que serían modificados: {{ summary.users_changed }}</p>
                        {% if summary.changes %}
                            <h4>Ejemplos de cambios:</h4>
                            <pre style="max-height:300px;overflow:auto;">{{ summary.changes|tojson(indent=2) }}</pre>
                        {% endif %}
                        <form method="post">
                            <button type="submit" class="btn btn-danger">Aplicar normalización</button>
                            <a href="{{ url_for('admin.dashboard_admin') }}" class="btn btn-secondary">Cancelar</a>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title mb-0">Herramientas de Mantenimiento</h4>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        <a href="{{ url_for('admin.system_status') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-graph-up"></i> Estado del sistema
                                <small class="d-block text-muted">Monitorear rendimiento y recursos</small>
                            </div>
                        </a>
                        <a href="{{ url_for('admin.notification_settings') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-bell"></i> Configuración de alertas
                                <small class="d-block text-muted">Configurar notificaciones por email</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">Ver</span>
                        </a>
                        <a href="{{ url_for('admin.backup_json') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-download"></i> Exportar catálogo (JSON)
                                <small class="d-block text-muted">Backup completo en formato JSON</small>
                            </div>
                            <span class="badge bg-success rounded-pill">Descargar</span>
                        </a>
                        <a href="{{ url_for('admin.backup_csv') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-file-earmark-spreadsheet"></i> Exportar catálogo (CSV)
                                <small class="d-block text-muted">Backup en formato CSV para hojas de cálculo</small>
                            </div>
                            <span class="badge bg-success rounded-pill">Descargar</span>
                        </a>
                        <a href="{{ url_for('admin.cleanup_resets') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-trash"></i> Limpiar tokens de recuperación
                                <small class="d-block text-muted">Eliminar tokens utilizados o caducados</small>
                            </div>
                            <span class="badge bg-warning rounded-pill">Limpiar</span>
                        </a>
                        <a href="{{ url_for('admin.verify_users') }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-people"></i> Verificar usuarios y roles
                                <small class="d-block text-muted">Comprobar la configuración de cada usuario</small>
                            </div>
                            <span class="badge bg-info rounded-pill">Verificar</span>
                        </a>
                        <form id="cleanupTempForm" class="list-group-item list-group-item-action d-flex flex-column gap-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-trash"></i> Eliminar archivos temporales
                                    <small class="d-block text-muted">Selecciona un rango de fechas y horas para eliminar archivos temporales.</small>
                                </div>
                            </div>
                            <div class="row g-2 align-items-end">
                                <div class="col">
                                    <label for="startDatetime" class="form-label mb-0">Desde</label>
                                    <input type="datetime-local" class="form-control" id="startDatetime" name="start_datetime">
                                </div>
                                <div class="col">
                                    <label for="endDatetime" class="form-label mb-0">Hasta</label>
                                    <input type="datetime-local" class="form-control" id="endDatetime" name="end_datetime">
                                </div>
                                <div class="col-auto">
                                    <button type="submit" class="btn btn-danger">Eliminar</button>
                                </div>
                            </div>
                            <div id="cleanupTempMsg" class="mt-2"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title mb-0">Resumen de Estado</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-light mb-3">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Archivos temporales</h5>
                                    <p class="card-text fs-3">{{ data.temp_files.count }}</p>
                                    <p class="card-text text-muted">{{ data.temp_files.total_size_mb }} MB</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light mb-3">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Tasa de aciertos caché</h5>
                                    <p class="card-text fs-3">{{ data.cache.hit_rate }}%</p>
                                    <p class="card-text text-muted">{{ data.cache.hit_count }} aciertos / {{ data.cache.miss_count }} fallos</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h5>Espacio en disco</h5>
                        <div class="progress">
                            {% if data.disk.percent < 70 %}
                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ data.disk.percent }}%;" aria-valuenow="{{ data.disk.percent }}" aria-valuemin="0" aria-valuemax="100">{{ data.disk.percent }}%</div>
                            {% elif data.disk.percent < 85 %}
                            <div class="progress-bar bg-warning" role="progressbar" style="width: {{ data.disk.percent }}%;" aria-valuenow="{{ data.disk.percent }}" aria-valuemin="0" aria-valuemax="100">{{ data.disk.percent }}%</div>
                            {% else %}
                            <div class="progress-bar bg-danger" role="progressbar" style="width: {{ data.disk.percent }}%;" aria-valuenow="{{ data.disk.percent }}" aria-valuemin="0" aria-valuemax="100">{{ data.disk.percent }}%</div>
                            {% endif %}
                        </div>
                        <small class="text-muted">
                            {{ data.disk.used_gb }} GB de {{ data.disk.total_gb }} GB utilizados
                        </small>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <h5 class="alert-heading">Última actualización</h5>
                        <p class="mb-0">{{ data.timestamp }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cleanupBtn = document.getElementById('cleanupTempBtn');
        if (cleanupBtn) {
            cleanupBtn.addEventListener('click', function() {
                if (confirm('¿Seguro que deseas eliminar los archivos temporales con más de 2 días de antigüedad?')) {
                    fetch('/admin/api/cleanup-temp', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: 'days=7'
                    })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                        location.reload();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al limpiar archivos temporales');
                    });
                }
            });
        }
    });
</script>
{% endblock %}
