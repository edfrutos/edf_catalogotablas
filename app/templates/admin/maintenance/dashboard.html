{% extends "admin/base.html" %}
{% block title %}Mantenimiento del Sistema{% endblock %}

{% block content %}
<div class="container">
    <!-- Encabezado y menú de navegación -->
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="bi bi-tools"></i> Panel de Mantenimiento</h2>
                <p class="lead mb-0">Herramientas para el mantenimiento del sistema</p>
            </div>
            <div>
                <div class="dropdown">
                    <button class="btn btn-primary dropdown-toggle" type="button" id="mantenimientoDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-wrench"></i> Mantenimiento
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="mantenimientoDropdown">
  <li><a class="dropdown-item" href="#systemStatusSection">Estado del Sistema</a></li>
  <li><a class="dropdown-item" href="#cleanupSection">Limpieza de Logs</a></li>
  <li><a class="dropdown-item" href="#tasksSection">Tareas Programadas</a></li>
  <li><a class="dropdown-item" href="#backupSection">Backup y restauración</a></li>
  <li><a class="dropdown-item" href="#logsSection">Ver Logs</a></li>
</ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Tarjeta de Estado del Sistema -->
    <div id="systemStatusSection" class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-speedometer2"></i> Estado del Sistema</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-end mb-2">
                        <button class="btn btn-outline-secondary btn-sm" id="exportSystemStatusBtn">
                            <i class="bi bi-download"></i> Exportar a CSV
                        </button>
                    </div>
                    <div id="systemStatus" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Cargando información del sistema...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tarjeta de Limpieza de Logs -->
    <div id="cleanupSection" class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-trash"></i> Limpieza de Logs</h5>
                </div>
                <div class="card-body">
                    <form id="cleanupForm">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="daysToKeep" class="form-label">Mantener logs de los últimos (días):</label>
                                <input type="number" class="form-control" id="daysToKeep" value="30" min="1">
                            </div>
                            <div class="col-md-8 d-flex align-items-end">
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary" id="runCleanupBtn" style="background-color: #0d6efd; border-color: #0d6efd;">
                                <i class="bi bi-play"></i> Ejecutar Limpieza
                            </button>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <input type="datetime-local" class="form-control me-2" id="startDate" disabled>
                            <input type="datetime-local" class="form-control" id="endDate" disabled>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Tarjeta de Tareas Programadas -->
    <div id="tasksSection" class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Tareas Programadas</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Descripción</th>
                                    <th>Programación</th>
                                    <th>Última Ejecución</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="scheduledTasks">
                                <tr>
                                    <td>Limpieza de Logs</td>
                                    <td>Domingos 2:00 AM</td>
                                    <td id="lastCleanupRun">-</td>
                                    <td><span class="badge bg-secondary">Desconocido</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary run-task" data-task="cleanup">
                                            <i class="bi bi-play"></i> Ejecutar Ahora
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Verificación MongoDB</td>
                                    <td>Diario 3:00 AM</td>
                                    <td id="lastMongoCheck">-</td>
                                    <td><span class="badge bg-secondary">Desconocido</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary run-task" data-task="mongo">
                                            <i class="bi bi-play"></i> Ejecutar Ahora
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Verificación Disco</td>
                                    <td>Domingos 1:00 AM</td>
                                    <td id="lastDiskCheck">-</td>
                                    <td><span class="badge bg-secondary">Desconocido</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary run-task" data-task="disk">
                                            <i class="bi bi-play"></i> Ejecutar Ahora
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Alerta de resultado de tarea -->
    <div id="taskResult" style="display:none;"></div>
</div>

<!-- Sección de Backup y restauración -->
<div id="backupSection" class="row mb-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="bi bi-cloud-arrow-up"></i> Backup y restauración</h5>
      </div>
      <div class="card-body">
        <p>Desde aquí puedes realizar copias de seguridad y restaurar datos del sistema.</p>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-success" id="backupBtn">
            <i class="bi bi-cloud-arrow-up"></i> Realizar Backup
          </button>
          <button class="btn btn-outline-secondary" id="restoreBtn">
            <i class="bi bi-arrow-counterclockwise"></i> Restaurar Backup
          </button>
        </div>
        <div id="backupResult" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<div id="logsSection"></div>
<!-- Modal para logs -->
<div class="modal fade" id="logsModal" tabindex="-1" aria-labelledby="logsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logsModalLabel">Registros de Mantenimiento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary" data-log-type="today">Hoy</button>
                        <button type="button" class="btn btn-outline-primary" data-log-type="yesterday">Ayer</button>
                        <button type="button" class="btn btn-outline-primary" data-log-type="week">Esta semana</button>
                    </div>
                </div>
                <div class="mb-2">
                        <label for="logFileSelect" class="form-label">Archivo de log:</label>
                        <select id="logFileSelect" class="form-select form-select-sm mb-2"></select>
                    </div>
                    <pre id="logContent" class="bg-dark text-light p-3 rounded" style="max-height: 60vh; overflow-y: auto;">
                    Cargando registros...
                </pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="refreshLogs">
                    <i class="bi bi-arrow-clockwise"></i> Actualizar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    $(document).ready(function() {
        // Cargar estado del sistema al inicio
        loadSystemStatus();
        // Refrescar automáticamente cada 10 segundos
        setInterval(function() {
            loadSystemStatus(true); // true = refresh automático
        }, 10000);
        // Habilitar/deshabilitar campos de fecha/hora según el checkbox
        $('#useDateRange').on('change', function() {
            if ($(this).is(':checked')) {
                $('#startDate, #endDate').prop('disabled', false);
                $('#daysToKeep').prop('disabled', true);
            } else {
                $('#startDate, #endDate').prop('disabled', true);
                $('#daysToKeep').prop('disabled', false);
            }
        });
        // Cargar lista de logs disponibles al abrir el modal
        $('#viewLogsBtn').on('click', function() {
            $.get('/admin/logs/list', function(data) {
                if (data.status === 'success') {
                    const select = $('#logFileSelect');
                    select.empty();
                    data.files.forEach(function(file) {
                        select.append(`<option value="${file}">${file}</option>`);
                    });
                }
            });
        });
        // Configurar evento del formulario de limpieza
        $('#cleanupForm').on('submit', function(e) {
            e.preventDefault();
            runCleanup();
        });
        // Botón para ver logs
        // Al hacer clic en Ver Logs, cargar lista y mostrar el primer log por defecto
        $('#viewLogsBtn').click(function() {
            $.get('/admin/logs/list', function(data) {
                if (data.status === 'success') {
                    const select = $('#logFileSelect');
                    select.empty();
                    if (data.files.length === 0) {
                        select.append('<option value="">(No hay archivos de log)</option>');
                        $('#logContent').text('No hay archivos de log disponibles.');
                        return;
                    }
                    data.files.forEach(function(file) {
                        select.append(`<option value="${file}">${file}</option>`);
                    });
                    // Seleccionar el primer archivo y cargarlo
                    select.val(data.files[0]);
                    loadSelectedLog();
                } else {
                    $('#logContent').text('Error al cargar la lista de logs.');
                }
            });
            $('#logsModal').modal('show');
        });
        // Botón de actualizar logs
        $('#refreshLogs').click(function() {
            loadSelectedLog();
        });
        // Eliminar pestañas: desactivar el cambio de pestaña y cargar por selección
        $('[data-log-type]').off('click');
        // Cargar log al cambiar selección
        $('#logFileSelect').on('change', function() {
            loadSelectedLog();
        });
        // Ejecutar tareas programadas manualmente
        $('.run-task').click(function() {
            const task = $(this).data('task');
            runTask(task);
        });
        // Exportar estado del sistema a CSV
        $(document).on('click', '#exportSystemStatusBtn', function() {
            const data = window.__lastSystemStatusData;
            if (!data) {
                showToast('No hay datos para exportar', 'danger');
                return;
            }
            let csv = 'Métrica,Valor\n';
            csv += `SO,${data.system?.sistema_operativo || ''}\n`;
            csv += `Arquitectura,${data.system?.arquitectura || ''}\n`;
            csv += `Usuario,${data.system?.usuario || ''}\n`;
            csv += `Hora,${data.system?.hora_actual || ''}\n`;
            csv += `CPU (%),${data.cpu?.uso_porcentual || ''}\n`;
            csv += `Núcleos,${data.cpu?.nucleos || ''}\n`;
            csv += `Memoria Total (GB),${data.memoria?.total_gb || ''}\n`;
            csv += `Memoria Disponible (GB),${data.memoria?.disponible_gb || ''}\n`;
            csv += `Memoria Uso (%),${data.memoria?.uso_porcentual || ''}\n`;
            csv += `Disco Total (GB),${data.disco?.total_gb || ''}\n`;
            csv += `Disco Usado (GB),${data.disco?.usado_gb || ''}\n`;
            csv += `Disco Libre (GB),${data.disco?.libre_gb || ''}\n`;
            csv += `Disco Uso (%),${data.disco?.uso_porcentual || ''}\n`;
            csv += `SWAP Total (GB),${data.memoria?.swap_total_gb || ''}\n`;
            csv += `SWAP Usado (GB),${data.memoria?.swap_usado_gb || ''}\n`;
            // Descargar CSV
            const blob = new Blob([csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `estado_sistema_${(new Date()).toISOString().replace(/[:.]/g, '-')}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Exportación a CSV completada');
        });
    });


function loadSystemStatus(isAutoRefresh = false) {
    $.get('{{ url_for("maintenance.system_status") }}', function(response) {
        if (response.status === 'success') {
            const data = response.data;
            window.__lastSystemStatusData = data; // Guardar para exportación
            let html = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="card bg-light mb-3">
                            <div class="card-header">Sistema</div>
                            <div class="card-body">
                                <p class="card-text">
                                    <strong>SO:</strong> ${data.system?.sistema_operativo || 'N/A'}<br>
                                    <strong>Arquitectura:</strong> ${data.system?.arquitectura || 'N/A'}<br>
                                    <strong>Usuario:</strong> ${data.system?.usuario || 'N/A'}<br>
                                    <strong>Hora:</strong> ${data.system?.hora_actual || 'N/A'}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light mb-3">
                            <div class="card-header">CPU</div>
                            <div class="card-body text-center">
                                <div class="progress mb-2" style="height: 25px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" 
                                         style="width: ${data.cpu?.uso_porcentual || 0}%">
                                        ${data.cpu?.uso_porcentual || 0}%
                                    </div>
                                </div>
                                <p class="card-text mb-0">
                                    <strong>Núcleos:</strong> ${data.cpu?.nucleos || 'N/A'}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light mb-3">
                            <div class="card-header">Memoria</div>
                            <div class="card-body">
                                <div class="progress mb-2" style="height: 25px;">
                                    <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" 
                                         role="progressbar" 
                                         style="width: ${data.memoria?.uso_porcentual || 0}%">
                                        ${Math.round(data.memoria?.uso_porcentual || 0)}%
                                    </div>
                                </div>
                                <p class="card-text mb-1">
                                    <strong>Total:</strong> ${data.memoria?.total_gb || 0} GB<br>
                                    <strong>Disponible:</strong> ${data.memoria?.disponible_gb || 0} GB
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card bg-light mb-3">
                            <div class="card-header">Disco Principal</div>
                            <div class="card-body">
                                <div class="progress mb-2" style="height: 25px;">
                                    <div class="progress-bar bg-warning text-dark progress-bar-striped progress-bar-animated" 
                                         role="progressbar" 
                                         style="width: ${data.disco?.uso_porcentual || 0}%">
                                        ${Math.round(data.disco?.uso_porcentual || 0)}%
                                    </div>
                                </div>
                                <p class="card-text mb-1">
                                    <strong>Total:</strong> ${data.disco?.total_gb || 0} GB<br>
                                    <strong>Usado:</strong> ${data.disco?.usado_gb || 0} GB<br>
                                    <strong>Libre:</strong> ${data.disco?.libre_gb || 0} GB
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light mb-3">
                            <div class="card-header">Memoria SWAP</div>
                            <div class="card-body">
                                <div class="progress mb-2" style="height: 25px;">
                                    <div class="progress-bar bg-info text-dark progress-bar-striped progress-bar-animated" 
                                         role="progressbar" 
                                         style="width: ${(data.memoria?.swap_usado_gb / data.memoria?.swap_total_gb * 100 || 0).toFixed(1)}%">
                                        ${(data.memoria?.swap_usado_gb / data.memoria?.swap_total_gb * 100 || 0).toFixed(1)}%
                                    </div>
                                </div>
                                <p class="card-text mb-1">
                                    <strong>Total:</strong> ${data.memoria?.swap_total_gb || 0} GB<br>
                                    <strong>Usado:</strong> ${data.memoria?.swap_usado_gb || 0} GB
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            $('#systemStatus').html(html);
            if (!isAutoRefresh) showToast('¡Estado del sistema actualizado!', 'success');
        } else {
            $('#systemStatus').html(`
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill"></i> 
                    Error al cargar el estado del sistema: ${response.message || 'Error desconocido'}
                </div>
            `);
            if (!isAutoRefresh) showToast('Error al cargar el estado del sistema', 'danger');
        }
    }).fail(function() {
        $('#systemStatus').html(`
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle-fill"></i> 
                No se pudo conectar al servidor para obtener el estado del sistema.
            </div>
        `);
        if (!isAutoRefresh) showToast('No se pudo conectar al servidor', 'danger');
    });
}

function runCleanup() {
    const btn = $('#runCleanupBtn');
    const originalText = btn.html();
    const days = $('#daysToKeep').val();
    const useDateRange = $('#useDateRange').is(':checked');
    const startDate = $('#startDate').val();
    const endDate = $('#endDate').val();

    btn.prop('disabled', true).html(`
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Ejecutando...
    `);

    $('#cleanupResult').hide();

    let dataToSend = {

    };
    if (useDateRange) {
        dataToSend['start_datetime'] = startDate;
        dataToSend['end_datetime'] = endDate;
    } else {
        dataToSend['days'] = days;
    }

    $.ajax({
        url: '{{ url_for("maintenance.cleanup_temp_files") }}',
        method: 'POST',
        data: dataToSend,
        success: function(response) {
            if (response.status === 'success') {
                $('#cleanupAlert')
                    .removeClass('alert-danger')
                    .addClass('alert-success')
                    .html(`
                        <h5><i class="bi bi-check-circle-fill"></i> Limpieza completada exitosamente</h5>
                        <pre class="mt-2 mb-0">${response.output || 'No hay salida'}</pre>
                    `);
                
                // Actualizar última ejecución
                const now = new Date();
                $('#lastCleanupRun').text(now.toLocaleString());
                $('td:contains("Limpieza de Logs")').next().next().find('.badge')
                    .removeClass('bg-secondary bg-danger')
                    .addClass('bg-success')
                    .text('Completado');
            } else {
                showError('Error en la limpieza', response.message || 'Error desconocido');
            }
            
            $('#cleanupResult').show();
        },
        error: function(xhr) {
            let errorMsg = 'Error al conectar con el servidor';
            try {
                const errorData = JSON.parse(xhr.responseText);
                errorMsg = errorData.message || errorMsg;
            } catch (e) {
                errorMsg = xhr.statusText || errorMsg;
            }
            showError('Error', errorMsg);
            $('#cleanupResult').show();
        },
        complete: function() {
            btn.prop('disabled', false).html(originalText);
        }
    });
}

// Nueva función: cargar el log seleccionado en el dropdown
function loadSelectedLog() {
    const logFile = $('#logFileSelect').val();
    if (!logFile) {
        $('#logContent').text('Por favor selecciona un archivo de log.');
        return;
    }
    $('#logContent').text('Cargando registros...');
    $.get(`/admin/logs/view?file=${encodeURIComponent(logFile)}`, function(data) {
        if (data.status === 'success') {
            $('#logContent').text(data.content || 'El archivo de log está vacío');
        } else {
            $('#logContent').text(`Error al cargar el archivo de log: ${data.message || 'Error desconocido'}`);
        }
    }).fail(function() {
        $('#logContent').text('No se pudo cargar el archivo de log');
    });
}
// (Obsoleta) function loadLogs(logType) { ... }

function getLogFileName(logType) {
    const now = new Date();
    let logFile = '';
    
    switch(logType) {
        case 'yesterday':
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            logFile = `maintenance_${yesterday.toISOString().split('T')[0].replace(/-/g, '')}.log`;
            break;
        case 'week':
            logFile = 'maintenance_week.log';
            break;
        case 'today':
        default:
            logFile = `maintenance_${now.toISOString().split('T')[0].replace(/-/g, '')}.log`;
    }
    
    return logFile;
}

function getTaskCellId(task) {
    switch(task) {
        case 'cleanup': return 'lastCleanupRun';
        case 'mongo': return 'lastMongoCheck';
        case 'disk': return 'lastDiskCheck';
        default: return '';
    }
}

function runTask(task) {
    const btn = $(`.run-task[data-task="${task}"]`);
    const originalText = btn.html();
    const cellId = getTaskCellId(task);

    btn.prop('disabled', true).html(`
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Ejecutando...
    `);

    // Actualizar estado
    if (cellId) {
        $(`#${cellId}`).text('Ejecutando...');
    }

    // Simular ejecución (en una implementación real, esto sería una llamada AJAX)
    setTimeout(function() {
        const now = new Date();
        if (cellId) {
            $(`#${cellId}`).text(now.toLocaleString());
        }
        // Actualizar estado
        $(`td:contains("${getTaskName(task)}")`).next().next().find('.badge')
            .removeClass('bg-secondary bg-danger')
            .addClass('bg-success')
            .text('Completado');
        btn.html(originalText).prop('disabled', false);

        // Mensaje personalizado
        let customMsg = '';
        if (task === 'mongo') {
            customMsg = `<strong>Verificación MongoDB completada exitosamente</strong> (${now.toLocaleString()})`;
        } else if (task === 'disk') {
            customMsg = `<strong>Verificación Disco completada exitosamente</strong> (${now.toLocaleString()})`;
        } else {
            customMsg = `Tarea "${getTaskName(task)}" ejecutada correctamente (${now.toLocaleString()})`;
        }
        $('#taskResult').html(`
            <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
                ${customMsg}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
            </div>
        `).show();
    }, 2000);
}


function getTaskName(task) {
    const tasks = {
        'cleanup': 'Limpieza de Logs',
        'mongo': 'Verificación MongoDB',
        'disk': 'Verificación Disco'
    };
    return tasks[task] || task;
}

function showError(title, message) {
    $('#cleanupAlert')
        .removeClass('alert-success')
        .addClass('alert-danger')
        .html(`
            <h5><i class="bi bi-exclamation-triangle-fill"></i> ${title}</h5>
            <p class="mb-0">${message}</p>
        `);
}

function showAlert(message, type = 'success') {
    const alert = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
        </div>
    `;
    
    // Insertar al principio del contenedor
    $('.container').prepend(alert);
    
    // Eliminar después de 5 segundos
    setTimeout(function() {
        $('.alert').alert('close');
    }, 5000);
}
</script>
{% endblock %}
