{% extends 'admin/base.html' %} 
{% block title %}Gesti√≥n de Respaldo de Base de Datos{% endblock %} 

{% block head %}
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />

<style>
  /* Mejorar scroll de la tabla */
  .table-responsive {
    max-height: 70vh;
    overflow-y: auto;
  }
  
  /* Mantener el header de la tabla fijo */
  .table-responsive thead th {
    position: sticky;
    top: 0;
    background: white;
    z-index: 10;
  }
  
  /* Barra de paginaci√≥n flotante */
  .floating-pagination {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255, 255, 255, 0.98);
    border: 2px solid #007bff;
    border-radius: 12px;
    padding: 15px 25px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    z-index: 1000;
    display: none;
    min-width: 400px;
    backdrop-filter: blur(15px);
    transition: all 0.3s ease;
  }
  
  .floating-pagination.show {
    display: block !important;
  }
  
  /* Hacer la paginaci√≥n flotante m√°s visible */
  .floating-pagination .pagination {
    margin: 0;
  }
  
  .floating-pagination .page-link {
    border-radius: 6px;
    margin: 0 2px;
  }
  
  /* Estilos para selecci√≥n m√∫ltiple */
  .backup-checkbox {
    cursor: pointer;
  }
  
  .table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.1);
  }
  
  /* Responsive para la paginaci√≥n flotante */
  @media (max-width: 768px) {
    .floating-pagination {
      bottom: 70px;
      left: 10px;
      right: 10px;
      transform: none;
      min-width: auto;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-database-check me-2"></i>Gesti√≥n de Respaldo</h2>
    <div>
      <button
        id="createBackupToDrive"
        class="btn btn-warning me-2"
        title="Crear backup y subir directamente a Google Drive"
      >
        <i class="bi bi-cloud-upload"></i> Crear Backup Directo
      </button>

      <button class="btn btn-outline-success ms-2" id="restoreDriveBtn" data-bs-toggle="modal" data-bs-target="#restoreDriveModal">
        <i class="bi bi-google"></i> Google Drive
      </button>
      <button
        id="refreshBtn"
        class="btn btn-outline-secondary"
        title="Actualizar lista de respaldos"
      >
        <i class="bi bi-arrow-repeat"></i> Actualizar
      </button>
    </div>
  </div>

  <!-- Tarjeta de resumen de Google Drive -->
  <!-- <div class="row mb-4">
    <div class="col-md-6">
      <div class="card border-left-primary shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div
                class="text-xs font-weight-bold text-primary text-uppercase mb-1"
              >
                Respaldo en Google Drive
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">
                {{ drive_backups_count }} respaldos almacenados
              </div>
            </div>
            <div class="col-auto">
              <i class="bi bi-google fa-2x text-gray-300"></i>
            </div>
          </div>
          <div class="mt-2">
            <a href="{{ url_for('admin.list_drive_backups') }}" class="text-xs">
              Ver todos los respaldos <i class="bi bi-arrow-right"></i>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Panel de acciones -->
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-primary text-white">
          <i class="bi bi-database-down me-2"></i>Crear Respaldo Local
        </div>
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-8">
              <p class="mb-0">
                Crea un nuevo respaldo local completo de la base de datos en el
                directorio <code>backups/</code>. Se recomienda realizar esta
                acci√≥n antes de actualizaciones importantes.
              </p>
            </div>
            <div class="col-md-4 text-end">
              <button
                id="createBackupBtn"
                type="button"
                class="btn btn-primary"
              >
                <i class="bi bi-download me-2"></i>Crear Respaldo Local
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Lista de respaldos locales -->
  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div
          class="card-header bg-white d-flex justify-content-between align-items-center"
        >
          <h5 class="mb-0"><i class="bi bi-hdd me-2"></i>Respaldos Locales</h5>
          <span class="badge bg-primary rounded-pill"
            >{{ total_backups }} respaldos</span
          >
        </div>
        <div class="card-body p-0">
          {% if backups %}
          <!-- Botones de acciones masivas -->
          <div class="mb-3 p-3 border-bottom">
            <button id="deleteSelectedBackups" class="btn btn-danger btn-sm" disabled>
              <i class="bi bi-trash"></i> Eliminar Seleccionados
            </button>
            <span id="selectedCount" class="ms-2 text-muted">0 elementos seleccionados</span>
          </div>
          
          <div class="table-responsive">
            <table class="table table-hover mb-0" id="backupsTable" width="100%" cellspacing="0">
              <thead class="table-dark">
                <tr>
                  <th width="50">
                    <input type="checkbox" id="selectAll" class="form-check-input" />
                  </th>
                  <th class="sortable" data-column="name" style="cursor: pointer;">
                    Nombre del Archivo
                    <span class="sort-icon">‚Üï</span>
                  </th>
                  <th class="sortable" data-column="size" style="cursor: pointer;">
                    Tama√±o
                    <span class="sort-icon">‚Üï</span>
                  </th>
                  <th class="sortable" data-column="modified" style="cursor: pointer;">
                    Fecha de Creaci√≥n
                    <span class="sort-icon">‚Üï</span>
                  </th>
                  <th class="sortable" data-column="status" style="cursor: pointer;">
                    Estado
                    <span class="sort-icon">‚Üï</span>
                  </th>
                  <th class="text-end">Acciones</th>
                </tr>
              </thead>
              <tbody id="backupsTableBody">
                {% for backup in backups %}
                <tr>
                  <td>
                    <input type="checkbox" class="form-check-input backup-checkbox" data-backup-name="{{ backup.name }}" />
                  </td>
                  <td class="align-middle">
                    <i
                      class="bi bi-file-earmark-zip-fill text-primary me-2"
                    ></i>
                    {{ backup.name }}
                  </td>
                  <td class="align-middle">
                    {{ backup.size }}
                  </td>
                  <td class="align-middle">
                    {{ backup.modified }}
                  </td>
                  <td class="align-middle">
                    {% if backup.name is string and backup.name.startswith('backup_') %}
                    <span class="badge bg-success">JSON</span>
                    {% else %}
                    <span class="badge bg-warning">Otro</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    <div class="btn-group" role="group">
                      <a
                        href="{{ url_for('admin.download_backup', filename=backup.name) }}"
                        class="btn btn-sm btn-outline-primary"
                        title="Descargar"
                      >
                        <i class="bi bi-download"></i>
                      </a>
                      {% if backup.name is string and backup.name.startswith('backup_') %}
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-warning"
                        onclick="restoreLocalBackup('{{ backup.name }}')"
                        title="Restaurar desde este backup"
                      >
                        <i class="bi bi-arrow-counterclockwise"></i>
                      </button>
                      {% else %}
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-secondary"
                        disabled
                        title="Solo se pueden restaurar backups JSON"
                      >
                        <i class="bi bi-arrow-counterclockwise"></i>
                      </button>
                      {% endif %}
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-success"
                        onclick="uploadToDrive('{{ backup.name }}')"
                        title="Subir a Google Drive"
                      >
                        <i class="bi bi-cloud-upload"></i>
                      </button>
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-danger"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteBackupModal"
                        data-backup="{{ backup.name }}"
                        title="Eliminar local"
                      >
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center p-5">
            <i class="bi bi-inbox text-muted" style="font-size: 3rem"></i>
            <p class="mt-3 mb-0 text-muted">No hay respaldos disponibles</p>
          </div>
          {% endif %}
        </div>
        <!-- DataTables manejar√° la paginaci√≥n autom√°ticamente -->
      </div>
    </div>
  </div>
</div>

<!-- DataTables manejar√° toda la paginaci√≥n autom√°ticamente -->

<!-- Modal de confirmaci√≥n para eliminar respaldo -->
<div class="modal fade" id="deleteBackupModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar Eliminaci√≥n</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Cerrar"
        ></button>
      </div>
      <div class="modal-body">
        <p>
          ¬øEst√°s seguro de que deseas eliminar el respaldo
          <strong id="backupToDelete"></strong>?
        </p>
        <p class="text-danger">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>Esta acci√≥n no se
          puede deshacer.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancelar
        </button>
        <button
          type="button"
          class="btn btn-danger"
          onclick="deleteLocalBackup()"
        >
          <i class="bi bi-trash me-2"></i>Eliminar
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} 

{% block scripts %}
<!-- DataTables JS -->
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

<script>
  // Funci√≥n simple para crear backup
  // Funci√≥n para mostrar notificaciones emergentes
  function showNotification(title, message, type = "info", duration = 5000) {
    // Crear el modal de notificaci√≥n
    const modalHtml = `
      <div class="modal fade" id="notificationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header ${type === "success" ? "bg-success text-white" : type === "error" ? "bg-danger text-white" : "bg-info text-white"}">
              <h5 class="modal-title">
                ${type === "success" ? "‚úÖ" : type === "error" ? "‚ùå" : "‚ÑπÔ∏è"} ${title}
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <p class="mb-0">${message}</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
          </div>
        </div>
      </div>
    `;

    // Remover modal anterior si existe
    const existingModal = document.getElementById("notificationModal");
    if (existingModal) {
      existingModal.remove();
    }

    // Agregar nuevo modal al body
    document.body.insertAdjacentHTML("beforeend", modalHtml);

    // Mostrar modal
    const modal = new bootstrap.Modal(
      document.getElementById("notificationModal")
    );
    modal.show();

    // Auto-cerrar despu√©s del tiempo especificado
    if (duration > 0) {
      setTimeout(() => {
        modal.hide();
      }, duration);
    }
  }

  // Funci√≥n para mostrar progreso
  function showProgress(title, message) {
    const progressHtml = `
      <div class="modal fade" id="progressModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title">üîÑ ${title}</h5>
            </div>
            <div class="modal-body text-center">
              <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Procesando...</span>
              </div>
              <p class="mb-0">${message}</p>
            </div>
          </div>
        </div>
      </div>
    `;

    // Remover modal anterior si existe
    const existingModal = document.getElementById("progressModal");
    if (existingModal) {
      existingModal.remove();
    }

    // Agregar nuevo modal al body
    document.body.insertAdjacentHTML("beforeend", progressHtml);

    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById("progressModal"));
    modal.show();
    return modal;
  }

  function createLocalBackup() {
    const button = document.getElementById("createBackupBtn");
    if (!button) {
      showNotification("Error", "No se encontr√≥ el bot√≥n de backup", "error");
      return;
    }

    // Deshabilitar bot√≥n
    button.disabled = true;
    button.innerHTML =
      '<span class="spinner-border spinner-border-sm me-2"></span>Creando respaldo...';

    // Mostrar progreso
    const progressModal = showProgress(
      "Creando Respaldo Local",
      "Generando backup de la base de datos..."
    );

    // Realizar petici√≥n POST
    fetch("/admin/db/backup", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Requested-With": "XMLHttpRequest",
      },
      credentials: "same-origin",
    })
      .then((response) => {
        console.log("Response status:", response.status);
        console.log("Response headers:", response.headers);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        return response.json();
      })
      .then((data) => {
        console.log("Response data:", data);
        progressModal.hide();

        if (data.status === "success") {
          showNotification(
            "√âxito",
            "‚úÖ Respaldo local creado exitosamente!",
            "success"
          );
          setTimeout(() => window.location.reload(), 2000);
        } else {
          throw new Error(data.message || "Error desconocido");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        progressModal.hide();
        showNotification(
          "Error",
          "‚ùå Error al crear respaldo: " + error.message,
          "error"
        );
      })
      .finally(() => {
        // Restaurar bot√≥n
        button.disabled = false;
        button.innerHTML =
          '<i class="bi bi-download me-2"></i>Crear Respaldo Local';
      });
  }

  // Variable global para almacenar el archivo a eliminar
  let backupToDelete = null;

  // Configurar modal de eliminaci√≥n
  document.addEventListener("DOMContentLoaded", function () {
    const backupBtn = document.getElementById("createBackupBtn");
    if (backupBtn) {
      backupBtn.addEventListener("click", createLocalBackup);
    }

    // Configurar modal de eliminaci√≥n
    const deleteModal = document.getElementById("deleteBackupModal");
    if (deleteModal) {
      deleteModal.addEventListener("show.bs.modal", function (event) {
        const button = event.relatedTarget;
        const backup = button.getAttribute("data-backup");
        backupToDelete = backup;

        const backupNameElement = document.getElementById("backupToDelete");
        if (backupNameElement) {
          backupNameElement.textContent = backup;
        }
      });
    }
  });

  // Funci√≥n para restaurar backup
  function restoreLocalBackup(filename) {
    if (!confirm("¬øRestaurar desde " + filename + "?")) {
      return;
    }

    // Mostrar progreso
    const progressModal = showProgress(
      "Restaurando Backup",
      "Restaurando datos desde " + filename + "..."
    );

    fetch("/admin/restore-local-backup", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Requested-With": "XMLHttpRequest",
      },
      credentials: "same-origin",
      body: JSON.stringify({ filename: filename }),
    })
      .then((response) => response.json())
      .then((data) => {
        progressModal.hide();

        if (data.success) {
          showNotification(
            "√âxito",
            "‚úÖ Backup restaurado exitosamente!",
            "success"
          );
          setTimeout(() => window.location.reload(), 2000);
        } else {
          throw new Error(data.error || "Error desconocido");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        progressModal.hide();
        showNotification(
          "Error",
          "‚ùå Error al restaurar: " + error.message,
          "error"
        );
      });
  }

  // Funci√≥n para subir a Google Drive
  function uploadToDrive(filename) {
    if (!confirm("¬øSubir " + filename + " a Google Drive?")) {
      return;
    }

    // Mostrar progreso
    const progressModal = showProgress(
      "Subiendo a Google Drive",
      "Subiendo " + filename + " a Google Drive..."
    );

    fetch("/admin/backup/upload-to-drive/" + encodeURIComponent(filename), {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Requested-With": "XMLHttpRequest",
      },
      credentials: "same-origin",
    })
      .then((response) => response.json())
      .then((data) => {
        progressModal.hide();

        if (data.success) {
          showNotification(
            "√âxito",
            "‚úÖ Backup subido a Google Drive exitosamente!",
            "success"
          );
          setTimeout(() => window.location.reload(), 2000);
        } else {
          throw new Error(data.error || "Error desconocido");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        progressModal.hide();
        showNotification(
          "Error",
          "‚ùå Error al subir a Google Drive: " + error.message,
          "error"
        );
      });
  }

  // Funci√≥n para eliminar backup local
  function deleteLocalBackup() {
    if (!backupToDelete) {
      showNotification("Error", "No se especific√≥ archivo a eliminar", "error");
      return;
    }

    // Cerrar modal
    const modal = bootstrap.Modal.getInstance(
      document.getElementById("deleteBackupModal")
    );
    if (modal) {
      modal.hide();
    }

    // Mostrar progreso
    const progressModal = showProgress(
      "Eliminando Backup",
      "Eliminando " + backupToDelete + "..."
    );

    fetch("/admin/backup/delete-local/" + encodeURIComponent(backupToDelete), {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
        "X-Requested-With": "XMLHttpRequest",
      },
      credentials: "same-origin",
    })
      .then((response) => response.json())
      .then((data) => {
        progressModal.hide();

        if (data.success) {
          showNotification(
            "√âxito",
            "‚úÖ Backup eliminado exitosamente!",
            "success"
          );
          setTimeout(() => window.location.reload(), 2000);
        } else {
          throw new Error(data.error || "Error desconocido");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        progressModal.hide();
        showNotification(
          "Error",
          "‚ùå Error al eliminar backup: " + error.message,
          "error"
        );
      });
  }

  // Configuraci√≥n b√°sica cuando el DOM est√© listo
  document.addEventListener('DOMContentLoaded', function() {
    // Configurar bot√≥n de actualizar
    const refreshBtn = document.getElementById('refreshBtn');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', function() {
        // Mostrar indicador de carga
        this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Actualizando...';
        this.disabled = true;
        
        // Recargar la p√°gina despu√©s de un breve delay
        setTimeout(() => {
          window.location.reload();
        }, 500);
      });
    }
    
    // Manejar el bot√≥n volver arriba del template base
    function handleScroll() {
      const scrollY = window.pageYOffset;
      const goTopBtn = document.getElementById('goTopBtn');
      if (goTopBtn) {
        if (scrollY > 200) {
          goTopBtn.style.display = 'block';
        } else {
          goTopBtn.style.display = 'none';
        }
      }
    }
    
    // Configurar el evento de scroll
    window.addEventListener('scroll', handleScroll);
    
    // Ejecutar handleScroll una vez para configurar el estado inicial
    handleScroll();
  });

  // Inicializar DataTable si hay backups
  {% if backups %}
  $(document).ready(function() {
    var table = $('#backupsTable').DataTable({
      "order": [[3, "desc"]], // Ordenar por fecha (columna 3)
      "language": {
        "url": "//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
      },
      "columnDefs": [
        { "orderable": false, "targets": [0, 5] }, // Deshabilitar ordenaci√≥n en checkbox y acciones
        { "searchable": false, "targets": [0, 5] } // No buscar en checkbox y acciones
      ],
      "pageLength": 25, // Mostrar 25 elementos por p√°gina por defecto
      "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]], // Opciones de elementos por p√°gina
      "responsive": true,
      "dom": '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
             '<"row"<"col-sm-12"tr>>' +
             '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>'
    });

    // Manejar selecci√≥n de todos los checkboxes
    $('#selectAll').change(function() {
      $('.backup-checkbox').prop('checked', $(this).is(':checked'));
      updateSelectedCount();
      updateActionButtons();
    });

    // Manejar selecci√≥n individual de checkboxes
    $(document).on('change', '.backup-checkbox', function() {
      updateSelectedCount();
      updateActionButtons();

      // Actualizar estado del checkbox "Seleccionar todo"
      var totalCheckboxes = $('.backup-checkbox').length;
      var checkedCheckboxes = $('.backup-checkbox:checked').length;
      $('#selectAll').prop('checked', totalCheckboxes === checkedCheckboxes);
      $('#selectAll').prop('indeterminate', checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes);
    });

    // Actualizar contador de elementos seleccionados
    function updateSelectedCount() {
      var count = $('.backup-checkbox:checked').length;
      $('#selectedCount').text(count + ' elemento' + (count !== 1 ? 's' : '') + ' seleccionado' + (count !== 1 ? 's' : ''));
    }

    // Actualizar estado de botones de acci√≥n
    function updateActionButtons() {
      var hasSelected = $('.backup-checkbox:checked').length > 0;
      $('#deleteSelectedBackups').prop('disabled', !hasSelected);
    }

    // Bot√≥n de eliminar seleccionados
    $('#deleteSelectedBackups').click(function() {
      var selectedBackups = [];
      $('.backup-checkbox:checked').each(function() {
        selectedBackups.push({
          name: $(this).data('backup-name')
        });
      });

      if (selectedBackups.length === 0) {
        showAlert('warning', 'No hay backups seleccionados');
        return;
      }

      var confirmMsg = '¬øEst√° seguro de que desea eliminar ' + selectedBackups.length + ' backup(s) seleccionado(s)?';
      if (confirm(confirmMsg)) {
        deleteMultipleBackups(selectedBackups);
      }
    });

    // Funci√≥n para eliminar m√∫ltiples backups
    function deleteMultipleBackups(backups) {
      $('#deleteSelectedBackups').prop('disabled', true).html('<i class="bi bi-arrow-clockwise"></i> Eliminando...');

      var promises = [];
      var successCount = 0;
      var errorCount = 0;
      var processedRows = [];

      backups.forEach(function(backup) {
        var promise = fetch("/admin/backup/delete-local/" + encodeURIComponent(backup.name), {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest",
          },
          credentials: "same-origin",
        }).then(response => response.json()).then(function(response) {
          if (response.success === true) {
            successCount++;
            // Marcar fila para eliminaci√≥n
            var row = $('.backup-checkbox[data-backup-name="' + backup.name + '"]').closest('tr');
            processedRows.push({row: row, success: true});
          } else {
            errorCount++;
          }
        }).catch(function() {
          errorCount++;
        });

        promises.push(promise);
      });

      Promise.all(promises.map(p => p.catch(e => e))).then(function() {
        // Eliminar filas exitosas
        processedRows.forEach(function(item) {
          if (item.success) {
            table.row(item.row).remove();
          }
        });

        table.draw();

        var message = '';
        if (successCount > 0) {
          message += successCount + ' backup(s) eliminado(s) exitosamente';
        }
        if (errorCount > 0) {
          if (message) message += '. ';
          message += errorCount + ' backup(s) no pudieron ser eliminados';
        }

        showAlert(errorCount === 0 ? 'success' : 'warning', message);

        // Resetear selecciones
        $('#selectAll').prop('checked', false);
        $('.backup-checkbox').prop('checked', false);
        updateSelectedCount();
        updateActionButtons();

        $('#deleteSelectedBackups').prop('disabled', false).html('<i class="bi bi-trash"></i> Eliminar Seleccionados');
      });
    }
  });
  {% endif %}

  // Funci√≥n para mostrar alertas mejorada
  function showAlert(type, message) {
    // Mapear tipos de alerta a clases de Bootstrap 5
    var alertClass = 'alert-' + type;

    var alertHtml = '<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
                   '<div class="d-flex align-items-center">' +
                   '<i class="bi ' + getAlertIcon(type) + ' me-2"></i>' +
                   '<div>' + message + '</div>' +
                   '</div>' +
                   '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>' +
                   '</div>';

    // Remover alertas existentes
    $('.alert').not('.alert-permanent').remove();

    // Insertar alerta al principio del contenido
    $('.container-fluid h2').after(alertHtml);

    // Auto-remover despu√©s de 5 segundos para alertas de √©xito
    if (type === 'success') {
      setTimeout(function() {
        $('.alert-' + type).fadeOut();
      }, 5000);
    }
  }

  // Funci√≥n para obtener iconos seg√∫n el tipo de alerta
  function getAlertIcon(type) {
    switch(type) {
      case 'success': return 'bi-check-circle-fill';
      case 'danger': return 'bi-exclamation-triangle-fill';
      case 'warning': return 'bi-exclamation-triangle-fill';
      case 'info': return 'bi-info-circle-fill';
      default: return 'bi-info-circle-fill';
    }
  }

  // Funci√≥n para crear backup directo a Google Drive
  function createBackupToDrive() {
    console.log("=== INICIO FUNCI√ìN createBackupToDrive ===");
    console.log("Funci√≥n createBackupToDrive ejecutada");

    const button = document.getElementById("createBackupToDrive");
    if (!button) {
      console.error("No se encontr√≥ el bot√≥n createBackupToDrive");
      showNotification("Error", "No se encontr√≥ el bot√≥n de backup", "error");
      return;
    }

    console.log("Bot√≥n encontrado, solicitando confirmaci√≥n");
    if (!confirm("¬øCrear backup y subirlo directamente a Google Drive?")) {
      console.log("Usuario cancel√≥ la operaci√≥n");
      return;
    }

    console.log("Usuario confirm√≥, iniciando proceso");
    // Deshabilitar bot√≥n
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creando...';

    // Mostrar progreso
    const progressModal = showProgress("Creando Backup Directo", "Generando backup y subiendo a Google Drive...");

    console.log("Enviando petici√≥n a /admin/backup/create-and-upload");
    // Crear backup y subir a Google Drive
    fetch("/admin/backup/create-and-upload", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Requested-With": "XMLHttpRequest",
      },
      credentials: "same-origin",
    })
      .then((response) => {
        console.log("Response status:", response.status);
        console.log("Response headers:", response.headers);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        return response.json();
      })
      .then((data) => {
        console.log("Response data:", data);
        progressModal.hide();

        if (data.success) {
          showNotification("√âxito", "‚úÖ Backup creado y subido a Google Drive exitosamente!", "success");
          setTimeout(() => window.location.reload(), 2000);
        } else {
          throw new Error(data.error || "Error desconocido");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        progressModal.hide();
        showNotification("Error", "‚ùå Error al crear backup directo: " + error.message, "error");
      })
      .finally(() => {
        // Restaurar bot√≥n
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-cloud-upload"></i> Crear Backup Directo';
        console.log("=== FIN FUNCI√ìN createBackupToDrive ===");
      });
  }

  // Configurar bot√≥n de crear backup directo
  document.addEventListener('DOMContentLoaded', function() {
    const createBackupToDriveBtn = document.getElementById('createBackupToDrive');
    if (createBackupToDriveBtn) {
      createBackupToDriveBtn.addEventListener('click', createBackupToDrive);
    }
  });
</script>

<!-- Modal de Google Drive -->
<div class="modal fade" id="restoreDriveModal" tabindex="-1" aria-labelledby="restoreDriveModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content" style="border: 5px solid #ff0000; box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="restoreDriveModalLabel">
          <i class="bi bi-google me-2"></i>Respaldo en Google Drive - MODAL PRINCIPAL
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Estilos para ordenamiento -->
        <style>
          .table-dark th {
            color: white !important;
            background-color: #343a40 !important;
          }
          .sortable {
            position: relative;
            user-select: none;
            transition: background-color 0.2s ease;
            color: white !important;
          }
          .sortable:hover {
            background-color: rgba(255, 193, 7, 0.2) !important;
            color: white !important;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
          }
          .sort-icon {
            font-size: 12px;
            opacity: 0.7;
            transition: all 0.2s ease;
            margin-left: 5px;
            display: inline-block;
            color: white;
          }
          .sortable:hover .sort-icon {
            opacity: 1;
            transform: scale(1.1);
            color: white;
          }
          .sortable.active .sort-icon {
            opacity: 1;
            color: #ffc107;
            font-weight: bold;
          }
          .backup-checkbox {
            cursor: pointer;
          }
          .backup-checkbox:hover {
            transform: scale(1.1);
          }
          #selectAllCheckbox {
            cursor: pointer;
          }
        </style>
        
        <!-- Controles de eliminaci√≥n masiva -->
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="selectAllBackups">
              <label class="form-check-label" for="selectAllBackups">
                <strong>Seleccionar todos</strong>
              </label>
            </div>
          </div>
          <div class="col-md-6 text-end">
            <button type="button" class="btn btn-danger btn-sm" id="bulkDeleteBtn" disabled>
              <i class="bi bi-trash"></i> Eliminar Seleccionados
            </button>
          </div>
        </div>
        
        <div id="driveBackupsContent">
          <div class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Cargando respaldos de Google Drive...</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-primary" id="refreshDriveBackups">
          <i class="bi bi-arrow-repeat"></i> Actualizar
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Funci√≥n para cargar contenido de Google Drive en el modal
// Variables globales para ordenamiento
let currentSortColumn = null;
let currentSortDirection = 'asc';
let allBackups = [];

function loadDriveBackups() {
  console.log('üîµ [DEBUG] loadDriveBackups() iniciada');
  const contentDiv = document.getElementById('driveBackupsContent');
  console.log('üîµ [DEBUG] contentDiv encontrado:', contentDiv);
  
  contentDiv.innerHTML = `
    <div class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-2">Cargando respaldos de Google Drive...</p>
    </div>
  `;

  console.log('üîµ [DEBUG] Iniciando fetch a /admin/maintenance/drive/backups');
  fetch('/admin/maintenance/drive/backups', {
    method: 'GET',
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
      'Accept': 'application/json'
    }
  })
  .then(response => {
    console.log('üîµ [DEBUG] Respuesta recibida:', response);
    return response.json();
  })
  .then(data => {
    console.log('üîµ [DEBUG] Datos recibidos:', data);
    if (data.success === true && data.backups) {
      console.log('üîµ [DEBUG] √âxito - renderizando tabla con', data.backups.length, 'backups');
      // Siempre renderizar la tabla, incluso si no hay backups
      allBackups = data.backups || [];
      renderBackupsTable(allBackups);
    } else {
      console.log('üîµ [DEBUG] Error - renderizando tabla con mensaje de error');
      // En caso de error, tambi√©n renderizar la tabla con mensaje de error
      allBackups = [{
        _id: 'error',
        error_message: 'Error al cargar los respaldos de Google Drive.'
      }];
      renderBackupsTable(allBackups);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    // En caso de error de red, tambi√©n renderizar la tabla con mensaje de error
    allBackups = [{
      _id: 'error',
      error_message: `Error de conexi√≥n al cargar los respaldos de Google Drive: ${error.message}`
    }];
    renderBackupsTable(allBackups);
  });
}

// Funci√≥n para renderizar la tabla de backups
function renderBackupsTable(backups) {
  const contentDiv = document.getElementById('driveBackupsContent');
  
  let tableHtml = `
    <div class="table-responsive">
      <table class="table table-striped table-hover" id="backupsTable">
        <thead class="table-dark">
          <tr>
            <th width="50" class="text-center">
              <input type="checkbox" id="selectAllCheckbox" class="form-check-input">
            </th>
            <th class="sortable" data-column="filename" style="cursor: pointer;">
              Nombre del Archivo
              <span class="sort-icon">‚Üï</span>
            </th>
            <th width="120" class="sortable text-center" data-column="file_size" style="cursor: pointer;">
              Tama√±o
              <span class="sort-icon">‚Üï</span>
            </th>
            <th width="150" class="sortable text-center" data-column="uploaded_at" style="cursor: pointer;">
              Subido el
              <span class="sort-icon">‚Üï</span>
            </th>
            <th width="120" class="sortable text-center" data-column="uploaded_by" style="cursor: pointer;">
              Subido por
              <span class="sort-icon">‚Üï</span>
            </th>
            <th width="150" class="text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  // Verificar si hay backups o errores
  if (backups && backups.length > 0) {
    // Verificar si es un error de configuraci√≥n
    const firstBackup = backups[0];
    if (firstBackup._id === 'no-credentials') {
      tableHtml += `
        <tr>
          <td colspan="6" class="text-center py-4">
            <div class="alert alert-warning d-flex align-items-center" role="alert">
              <i class="bi bi-exclamation-triangle me-2"></i>
              <div>Google Drive no configurado. Las credenciales de Google Drive no est√°n configuradas. Contacta al administrador para configurar el acceso a Google Drive.</div>
            </div>
          </td>
        </tr>
      `;
    } else if (firstBackup._id === 'error') {
      tableHtml += `
        <tr>
          <td colspan="6" class="text-center py-4">
            <div class="alert alert-danger d-flex align-items-center" role="alert">
              <i class="bi bi-exclamation-triangle me-2"></i>
              <div>${firstBackup.error_message || 'Error al acceder a Google Drive. Verifica la configuraci√≥n.'}</div>
            </div>
          </td>
        </tr>
      `;
    } else {
      // Renderizar backups normales
      backups.forEach(backup => {
        const fileSize = backup.file_size ? (backup.file_size / (1024 * 1024)).toFixed(2) : '0';
        const uploadedAt = backup.uploaded_at ? 
          (typeof backup.uploaded_at === 'string' ? backup.uploaded_at.substring(0, 10) : backup.uploaded_at.strftime('%d/%m/%Y')) : 
          'N/A';
        
        tableHtml += `
          <tr>
            <td class="text-center">
              <input type="checkbox" class="form-check-input backup-checkbox" value="${backup._id}">
            </td>
            <td><strong>${backup.filename}</strong></td>
            <td class="text-center"><span class="badge bg-info">${fileSize} MB</span></td>
            <td class="text-center"><small>${uploadedAt}</small></td>
            <td class="text-center"><span class="badge bg-secondary">${backup.uploaded_by_name || 'Sistema'}</span></td>
            <td class="text-center">
              <div class="btn-group" role="group">
                <a href="${backup.download_url}" class="btn btn-primary btn-sm" title="Descargar" target="_blank">
                  <i class="bi bi-download"></i>
                </a>
                <button class="btn btn-danger btn-sm" title="Eliminar" onclick="deleteDriveBackup('${backup._id}')">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      });
    }
  } else {
    // Mostrar mensaje cuando no hay backups
    tableHtml += `
      <tr>
        <td colspan="6" class="text-center py-4">
          <i class="bi bi-inbox text-muted" style="font-size: 2rem"></i>
          <p class="mt-2 mb-0 text-muted">No hay respaldos en Google Drive</p>
        </td>
      </tr>
    `;
  }
  
  tableHtml += `
        </tbody>
      </table>
    </div>
  `;
  
  contentDiv.innerHTML = tableHtml;
  
  // Inicializar eventos de ordenamiento y checkboxes
  initializeTableEvents();
}

// Funci√≥n para inicializar eventos de la tabla
function initializeTableEvents() {
  console.log('Inicializando eventos de la tabla...');
  
  // Eventos de ordenamiento - usar delegaci√≥n de eventos
  document.addEventListener('click', function(e) {
    if (e.target.closest('.sortable')) {
      e.preventDefault();
      e.stopPropagation();
      const header = e.target.closest('.sortable');
      const column = header.dataset.column;
      console.log(`Click en header ordenable: ${column}`);
      sortTable(column);
    }
  });
  
  // Eventos de checkboxes
  initializeCheckboxEvents();
  
  // Bot√≥n de eliminaci√≥n masiva
  const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
  if (bulkDeleteBtn) {
    bulkDeleteBtn.addEventListener('click', function() {
      const backupCheckboxes = document.querySelectorAll('.backup-checkbox');
      const selectedIds = Array.from(backupCheckboxes)
        .filter(checkbox => checkbox.checked)
        .map(checkbox => checkbox.value);
      
      if (selectedIds.length > 0) {
        if (confirm(`¬øEst√°s seguro de que quieres eliminar ${selectedIds.length} respaldo(s) seleccionado(s)?`)) {
          bulkDeleteBackups(selectedIds);
        }
      }
    });
  }
  
  console.log('Eventos de la tabla inicializados correctamente');
}

// Funci√≥n para ordenar la tabla
function sortTable(column) {
  console.log(`Ordenando por columna: ${column}`);
  
  // TEST VISUAL INMEDIATO - AGREGAR ALERTA AZUL
  const testAlert = document.createElement('div');
  testAlert.innerHTML = `
    <div class="alert alert-info text-center mb-0" style="background-color: #0dcaf0; color: white; font-weight: bold; font-size: 18px; z-index: 9999; position: relative;">
      üîµ CLICK DETECTADO - ORDENANDO POR ${column.toUpperCase()} üîµ
    </div>
  `;
  const modalBody = document.querySelector('.modal-body');
  if (modalBody) {
    modalBody.insertBefore(testAlert, modalBody.firstChild);
    setTimeout(() => testAlert.remove(), 2000);
  }
  
  // Toggle direcci√≥n de ordenamiento
  if (currentSortColumn === column) {
    currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
  } else {
    currentSortColumn = column;
    currentSortDirection = 'asc';
  }
  
  console.log(`Ordenando por ${column} (${currentSortDirection})`);
  
  // DETECTAR SI ESTAMOS EN EL MODAL DE GOOGLE DRIVE O EN LA TABLA DE RESPALDOS LOCALES
  const driveModal = document.querySelector('#restoreDriveModal .modal-body table tbody');
  const localTable = document.getElementById('backupsTableBody');
  
  if (driveModal) {
    // ORDENAMIENTO PARA MODAL DE GOOGLE DRIVE
    console.log('Ordenando tabla de Google Drive');
    sortDriveTable(column, driveModal);
  } else if (localTable) {
    // ORDENAMIENTO PARA TABLA DE RESPALDOS LOCALES
    console.log('Ordenando tabla de respaldos locales');
    sortLocalTable(column, localTable);
  } else {
    console.error('No se encontr√≥ ninguna tabla para ordenar');
    return;
  }
  
  // Actualizar iconos de ordenamiento
  updateSortIcons(column);
  
  console.log('Tabla ordenada exitosamente');
}

// Funci√≥n espec√≠fica para ordenar tabla de Google Drive
function sortDriveTable(column, tbody) {
  const rows = Array.from(tbody.querySelectorAll('tr'));
  console.log(`Encontradas ${rows.length} filas de Google Drive para ordenar`);
  
  // Ordenar filas
  rows.sort((a, b) => {
    let aVal, bVal;
    
    switch (column) {
      case 'filename':
        aVal = a.cells[1].textContent.trim();
        bVal = b.cells[1].textContent.trim();
        break;
      case 'file_size':
        aVal = a.cells[2].textContent.trim();
        bVal = b.cells[2].textContent.trim();
        // Convertir tama√±os a n√∫meros para ordenar correctamente
        aVal = parseFloat(aVal.replace(/[^\d.]/g, '')) || 0;
        bVal = parseFloat(bVal.replace(/[^\d.]/g, '')) || 0;
        break;
      case 'uploaded_at':
        aVal = a.cells[3].textContent.trim();
        bVal = b.cells[3].textContent.trim();
        break;
      case 'uploaded_by':
        aVal = a.cells[4].textContent.trim();
        bVal = b.cells[4].textContent.trim();
        break;
      default:
        aVal = a.cells[1].textContent.trim();
        bVal = b.cells[1].textContent.trim();
    }
    
    if (typeof aVal === 'string') {
      aVal = aVal.toLowerCase();
      bVal = bVal.toLowerCase();
    }
    
    if (aVal < bVal) return currentSortDirection === 'asc' ? -1 : 1;
    if (aVal > bVal) return currentSortDirection === 'asc' ? 1 : -1;
    return 0;
  });
  
  // Limpiar tbody y agregar filas ordenadas
  tbody.innerHTML = '';
  rows.forEach(row => tbody.appendChild(row));
}

// Funci√≥n espec√≠fica para ordenar tabla de respaldos locales
function sortLocalTable(column, tbody) {
  const rows = Array.from(tbody.querySelectorAll('tr'));
  console.log(`Encontradas ${rows.length} filas de respaldos locales para ordenar`);
  
  // Ordenar filas
  rows.sort((a, b) => {
    let aVal, bVal;
    
    switch (column) {
      case 'name':
        aVal = a.cells[1].textContent.trim();
        bVal = b.cells[1].textContent.trim();
        break;
      case 'size':
        aVal = a.cells[2].textContent.trim();
        bVal = b.cells[2].textContent.trim();
        // Convertir tama√±os a n√∫meros para ordenar correctamente
        aVal = parseFloat(aVal.replace(/[^\d.]/g, '')) || 0;
        bVal = parseFloat(bVal.replace(/[^\d.]/g, '')) || 0;
        break;
      case 'modified':
        aVal = a.cells[3].textContent.trim();
        bVal = b.cells[3].textContent.trim();
        break;
      case 'status':
        aVal = a.cells[4].textContent.trim();
        bVal = b.cells[4].textContent.trim();
        break;
      default:
        aVal = a.cells[1].textContent.trim();
        bVal = b.cells[1].textContent.trim();
    }
    
    if (typeof aVal === 'string') {
      aVal = aVal.toLowerCase();
      bVal = bVal.toLowerCase();
    }
    
    if (aVal < bVal) return currentSortDirection === 'asc' ? -1 : 1;
    if (aVal > bVal) return currentSortDirection === 'asc' ? 1 : -1;
    return 0;
  });
  
  // Limpiar tbody y agregar filas ordenadas
  tbody.innerHTML = '';
  rows.forEach(row => tbody.appendChild(row));
}

// Funci√≥n para actualizar solo las filas de la tabla
function updateTableRows(backups) {
  console.log(`Actualizando ${backups.length} filas de la tabla`);
  
  const tbody = document.querySelector('#backupsTable tbody');
  if (!tbody) {
    console.error('No se encontr√≥ el tbody de la tabla');
    return;
  }
  
  console.log('tbody encontrado, limpiando filas existentes...');
  
  // TEST VISUAL INMEDIATO - AGREGAR ALERTA ROJA
  const testAlert = document.createElement('div');
  testAlert.innerHTML = `
    <div class="alert alert-danger text-center mb-0" style="background-color: #dc3545; color: white; font-weight: bold; font-size: 18px; z-index: 9999; position: relative;">
      üö® TEST VISUAL - ORDENAMIENTO FUNCIONANDO üö®
    </div>
  `;
  tbody.parentNode.insertBefore(testAlert, tbody);
  
  // Agregar indicador visual MUY FUERTE
  tbody.style.backgroundColor = '#ff6b6b';
  tbody.style.border = '3px solid #ff0000';
  tbody.style.transition = 'all 0.5s ease';
  
  // Agregar mensaje temporal de ordenamiento
  const tempMessage = document.createElement('div');
  tempMessage.innerHTML = `
    <div class="alert alert-warning text-center mb-0" style="background-color: #ffc107; color: #000; font-weight: bold; font-size: 16px;">
      üîÑ ORDENANDO TABLA... ${currentSortDirection.toUpperCase()}
    </div>
  `;
  tbody.parentNode.insertBefore(tempMessage, tbody);
  
  // Limpiar filas existentes
  tbody.innerHTML = '';
  
  console.log('Agregando nuevas filas...');
  
  // Agregar nuevas filas
  backups.forEach((backup, index) => {
    const fileSize = backup.file_size ? (backup.file_size / (1024 * 1024)).toFixed(2) : '0';
    const uploadedAt = backup.uploaded_at ? 
      (typeof backup.uploaded_at === 'string' ? backup.uploaded_at.substring(0, 10) : backup.uploaded_at.strftime('%d/%m/%Y')) : 
      'N/A';
    
    const row = document.createElement('tr');
    
    // Destacar las primeras 3 filas para mostrar el ordenamiento
    const highlightClass = index < 3 ? 'table-warning' : '';
    const highlightStyle = index < 3 ? 'background-color: #fff3cd !important; font-weight: bold;' : '';
    
    row.innerHTML = `
      <td class="text-center ${highlightClass}" style="${highlightStyle}">
        <input type="checkbox" class="form-check-input backup-checkbox" value="${backup._id}">
      </td>
      <td class="${highlightClass}" style="${highlightStyle}"><strong>${backup.filename}</strong></td>
      <td class="text-center ${highlightClass}" style="${highlightStyle}"><span class="badge bg-info">${fileSize} MB</span></td>
      <td class="text-center ${highlightClass}" style="${highlightStyle}"><small>${uploadedAt}</small></td>
      <td class="text-center ${highlightClass}" style="${highlightStyle}"><span class="badge bg-secondary">${backup.uploaded_by_name || 'Sistema'}</span></td>
      <td class="text-center ${highlightClass}" style="${highlightStyle}">
        <div class="btn-group" role="group">
          <a href="${backup.download_url}" class="btn btn-primary btn-sm" title="Descargar" target="_blank">
            <i class="bi bi-download"></i>
          </a>
          <button class="btn btn-danger btn-sm" title="Eliminar" onclick="deleteDriveBackup('${backup._id}')">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </td>
    `;
    tbody.appendChild(row);
    
    if (index < 3) {
      console.log(`Fila ${index + 1} agregada: ${backup.filename}`);
    }
  });
  
  console.log(`Todas las ${backups.length} filas agregadas correctamente`);
  
  // Scroll autom√°tico al inicio de la tabla
  tbody.scrollIntoView({ behavior: 'smooth', block: 'start' });
  
  // Quitar indicador visual despu√©s de un momento
  setTimeout(() => {
    tbody.style.backgroundColor = '';
    tbody.style.border = '';
    if (tempMessage && tempMessage.parentNode) {
      tempMessage.parentNode.removeChild(tempMessage);
    }
    if (testAlert && testAlert.parentNode) {
      testAlert.parentNode.removeChild(testAlert);
    }
    
    // Quitar el highlight de las primeras filas despu√©s de 3 segundos
    setTimeout(() => {
      const highlightedRows = tbody.querySelectorAll('.table-warning');
      highlightedRows.forEach(row => {
        row.classList.remove('table-warning');
        const cells = row.querySelectorAll('td');
        cells.forEach(cell => {
          cell.style.backgroundColor = '';
          cell.style.fontWeight = '';
        });
      });
    }, 3000);
  }, 1500);
  
  // Re-inicializar eventos de checkboxes
  initializeCheckboxEvents();
}

// Funci√≥n para actualizar iconos de ordenamiento
function updateSortIcons(column) {
  console.log(`Actualizando iconos para columna: ${column}, direcci√≥n: ${currentSortDirection}`);
  
  // Resetear todos los iconos
  document.querySelectorAll('.sortable').forEach(header => {
    header.classList.remove('active');
    const icon = header.querySelector('.sort-icon');
    if (icon) {
      icon.textContent = '‚Üï';
    }
  });
  
  // Activar el header actual
  const currentHeader = document.querySelector(`[data-column="${column}"]`);
  if (currentHeader) {
    currentHeader.classList.add('active');
    const icon = currentHeader.querySelector('.sort-icon');
    if (icon) {
      icon.textContent = currentSortDirection === 'asc' ? '‚Üë' : '‚Üì';
      console.log(`Icono actualizado a: ${icon.textContent}`);
    } else {
      console.error('No se encontr√≥ el icono en el header');
    }
  } else {
    console.error(`No se encontr√≥ el header para la columna: ${column}`);
  }
}

// Funci√≥n para inicializar eventos de checkboxes
function initializeCheckboxEvents() {
  const selectAllCheckbox = document.getElementById('selectAllCheckbox');
  const backupCheckboxes = document.querySelectorAll('.backup-checkbox');
  
  if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', function() {
      backupCheckboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
      });
      updateBulkDeleteButton();
    });
  }
  
  backupCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      updateBulkDeleteButton();
      updateSelectAllCheckbox();
    });
  });
}

// Funci√≥n para actualizar el bot√≥n de eliminaci√≥n masiva
function updateBulkDeleteButton() {
  const selectedCount = document.querySelectorAll('.backup-checkbox:checked').length;
  const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
  
  if (selectedCount > 0) {
    bulkDeleteBtn.disabled = false;
    bulkDeleteBtn.innerHTML = `<i class="bi bi-trash"></i> Eliminar (${selectedCount})`;
  } else {
    bulkDeleteBtn.disabled = true;
    bulkDeleteBtn.innerHTML = `<i class="bi bi-trash"></i> Eliminar Seleccionados`;
  }
}

// Funci√≥n para actualizar el checkbox "Seleccionar todos"
function updateSelectAllCheckbox() {
  const selectAllCheckbox = document.getElementById('selectAllCheckbox');
  const backupCheckboxes = document.querySelectorAll('.backup-checkbox');
  const checkedCount = document.querySelectorAll('.backup-checkbox:checked').length;
  
  if (checkedCount === 0) {
    selectAllCheckbox.indeterminate = false;
    selectAllCheckbox.checked = false;
  } else if (checkedCount === backupCheckboxes.length) {
    selectAllCheckbox.indeterminate = false;
    selectAllCheckbox.checked = true;
  } else {
    selectAllCheckbox.indeterminate = true;
  }
}

// Funci√≥n para eliminaci√≥n masiva
function bulkDeleteBackups(backupIds) {
  const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
  const originalText = bulkDeleteBtn.innerHTML;
  
  bulkDeleteBtn.disabled = true;
  bulkDeleteBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Eliminando...';
  
  // Eliminar uno por uno (puedes optimizar esto con una llamada masiva al backend)
  let completed = 0;
  const total = backupIds.length;
  
  backupIds.forEach((id, index) => {
    setTimeout(() => {
      deleteDriveBackup(id, false); // false = no mostrar confirmaci√≥n individual
      completed++;
      
      if (completed === total) {
        // Recargar la tabla despu√©s de eliminar todos
        setTimeout(() => {
          loadDriveBackups();
          bulkDeleteBtn.innerHTML = originalText;
        }, 1000);
      }
    }, index * 500); // Espaciar las eliminaciones
  });
}

// Funci√≥n para eliminar backup de Google Drive
function deleteDriveBackup(backupId, showConfirm = true) {
  if (showConfirm && !confirm('¬øEst√° seguro de que desea eliminar este backup?')) {
    return;
  }
  
  fetch(`/admin/maintenance/drive/delete/${backupId}`, {
    method: 'DELETE',
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showNotification('√âxito', 'Backup eliminado exitosamente', 'success');
      loadDriveBackups(); // Recargar la lista
    } else {
      showNotification('Error', 'Error al eliminar backup: ' + (data.message || 'Error desconocido'), 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('Error', 'Error al eliminar backup: ' + error.message, 'error');
  });
}

// Configurar eventos del modal
document.addEventListener('DOMContentLoaded', function() {
  const restoreDriveBtn = document.getElementById('restoreDriveBtn');
  const refreshDriveBackupsBtn = document.getElementById('refreshDriveBackups');
  
  if (restoreDriveBtn) {
    restoreDriveBtn.addEventListener('click', function() {
      // Cargar contenido cuando se abre el modal
      setTimeout(loadDriveBackups, 100);
    });
  }
  
  if (refreshDriveBackupsBtn) {
    refreshDriveBackupsBtn.addEventListener('click', loadDriveBackups);
  }
  
  // Cargar contenido cuando el modal se muestra
  const restoreDriveModal = document.getElementById('restoreDriveModal');
  if (restoreDriveModal) {
    restoreDriveModal.addEventListener('shown.bs.modal', loadDriveBackups);
  }
});
</script>
{% endblock %}
