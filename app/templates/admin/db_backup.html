{% extends 'admin/base.html' %} 
{% block title %}Gestión de Respaldo de Base de Datos{% endblock %} 

{% block head %}
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />

<style>
  /* Mejorar scroll de la tabla */
  .table-responsive {
    max-height: 70vh;
    overflow-y: auto;
  }
  
  /* Mantener el header de la tabla fijo */
  .table-responsive thead th {
    position: sticky;
    top: 0;
    background: white;
    z-index: 10;
  }
  
  /* Barra de paginación flotante */
  .floating-pagination {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255, 255, 255, 0.98);
    border: 2px solid #007bff;
    border-radius: 12px;
    padding: 15px 25px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    z-index: 1000;
    display: none;
    min-width: 400px;
    backdrop-filter: blur(15px);
    transition: all 0.3s ease;
  }
  
  .floating-pagination.show {
    display: block !important;
  }
  
  /* Hacer la paginación flotante más visible */
  .floating-pagination .pagination {
    margin: 0;
  }
  
  .floating-pagination .page-link {
    border-radius: 6px;
    margin: 0 2px;
  }
  
  /* Estilos para selección múltiple */
  .backup-checkbox {
    cursor: pointer;
  }
  
  .table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.1);
  }
  
  /* Responsive para la paginación flotante */
  @media (max-width: 768px) {
    .floating-pagination {
      bottom: 70px;
      left: 10px;
      right: 10px;
      transform: none;
      min-width: auto;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-database-check me-2"></i>Gestión de Respaldo</h2>
    <div>
      <button
        id="createBackupToDrive"
        class="btn btn-warning me-2"
        title="Crear backup y subir directamente a Google Drive"
      >
        <i class="bi bi-cloud-upload"></i> Crear Backup Directo
      </button>

      <a
        href="{{ url_for('admin.list_drive_backups') }}"
        class="btn btn-outline-primary me-2"
      >
        <i class="bi bi-google me-1"></i> Ver en Google Drive
      </a>
      <button
        id="refreshBtn"
        class="btn btn-outline-secondary"
        title="Actualizar lista de respaldos"
      >
        <i class="bi bi-arrow-repeat"></i> Actualizar
      </button>
    </div>
  </div>

  <!-- Tarjeta de resumen de Google Drive -->
  <!-- <div class="row mb-4">
    <div class="col-md-6">
      <div class="card border-left-primary shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div
                class="text-xs font-weight-bold text-primary text-uppercase mb-1"
              >
                Respaldo en Google Drive
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">
                {{ drive_backups_count }} respaldos almacenados
              </div>
            </div>
            <div class="col-auto">
              <i class="bi bi-google fa-2x text-gray-300"></i>
            </div>
          </div>
          <div class="mt-2">
            <a href="{{ url_for('admin.list_drive_backups') }}" class="text-xs">
              Ver todos los respaldos <i class="bi bi-arrow-right"></i>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Panel de acciones -->
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-primary text-white">
          <i class="bi bi-database-down me-2"></i>Crear Respaldo Local
        </div>
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-8">
              <p class="mb-0">
                Crea un nuevo respaldo local completo de la base de datos en el
                directorio <code>backups/</code>. Se recomienda realizar esta
                acción antes de actualizaciones importantes.
              </p>
            </div>
            <div class="col-md-4 text-end">
              <button
                id="createBackupBtn"
                type="button"
                class="btn btn-primary"
              >
                <i class="bi bi-download me-2"></i>Crear Respaldo Local
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Lista de respaldos locales -->
  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div
          class="card-header bg-white d-flex justify-content-between align-items-center"
        >
          <h5 class="mb-0"><i class="bi bi-hdd me-2"></i>Respaldos Locales</h5>
          <span class="badge bg-primary rounded-pill"
            >{{ total_backups }} respaldos</span
          >
        </div>
        <div class="card-body p-0">
          {% if backups %}
          <!-- Botones de acciones masivas -->
          <div class="mb-3 p-3 border-bottom">
            <button id="deleteSelectedBackups" class="btn btn-danger btn-sm" disabled>
              <i class="bi bi-trash"></i> Eliminar Seleccionados
            </button>
            <span id="selectedCount" class="ms-2 text-muted">0 elementos seleccionados</span>
          </div>
          
          <div class="table-responsive">
            <table class="table table-hover mb-0" id="backupsTable" width="100%" cellspacing="0">
              <thead class="table-light">
                <tr>
                  <th width="50">
                    <input type="checkbox" id="selectAll" class="form-check-input" />
                  </th>
                  <th>Nombre del Archivo</th>
                  <th>Tamaño</th>
                  <th>Fecha de Creación</th>
                  <th>Estado</th>
                  <th class="text-end">Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for backup in backups %}
                <tr>
                  <td>
                    <input type="checkbox" class="form-check-input backup-checkbox" data-backup-name="{{ backup.name }}" />
                  </td>
                  <td class="align-middle">
                    <i
                      class="bi bi-file-earmark-zip-fill text-primary me-2"
                    ></i>
                    {{ backup.name }}
                  </td>
                  <td class="align-middle">
                    {{ backup.size }}
                  </td>
                  <td class="align-middle">
                    {{ backup.modified }}
                  </td>
                  <td class="align-middle">
                    {% if backup.name.startswith('backup_') %}
                    <span class="badge bg-success">JSON</span>
                    {% else %}
                    <span class="badge bg-warning">Otro</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    <div class="btn-group" role="group">
                      <a
                        href="{{ url_for('admin.download_backup', filename=backup.name) }}"
                        class="btn btn-sm btn-outline-primary"
                        title="Descargar"
                      >
                        <i class="bi bi-download"></i>
                      </a>
                      {% if backup.name.startswith('backup_') %}
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-warning"
                        onclick="restoreLocalBackup('{{ backup.name }}')"
                        title="Restaurar desde este backup"
                      >
                        <i class="bi bi-arrow-counterclockwise"></i>
                      </button>
                      {% else %}
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-secondary"
                        disabled
                        title="Solo se pueden restaurar backups JSON"
                      >
                        <i class="bi bi-arrow-counterclockwise"></i>
                      </button>
                      {% endif %}
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-success"
                        onclick="uploadToDrive('{{ backup.name }}')"
                        title="Subir a Google Drive"
                      >
                        <i class="bi bi-cloud-upload"></i>
                      </button>
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-danger"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteBackupModal"
                        data-backup="{{ backup.name }}"
                        title="Eliminar local"
                      >
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center p-5">
            <i class="bi bi-inbox text-muted" style="font-size: 3rem"></i>
            <p class="mt-3 mb-0 text-muted">No hay respaldos disponibles</p>
          </div>
          {% endif %}
        </div>
        <!-- DataTables manejará la paginación automáticamente -->
      </div>
    </div>
  </div>
</div>

<!-- DataTables manejará toda la paginación automáticamente -->

<!-- Modal de confirmación para eliminar respaldo -->
<div class="modal fade" id="deleteBackupModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar Eliminación</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Cerrar"
        ></button>
      </div>
      <div class="modal-body">
        <p>
          ¿Estás seguro de que deseas eliminar el respaldo
          <strong id="backupToDelete"></strong>?
        </p>
        <p class="text-danger">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>Esta acción no se
          puede deshacer.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancelar
        </button>
        <button
          type="button"
          class="btn btn-danger"
          onclick="deleteLocalBackup()"
        >
          <i class="bi bi-trash me-2"></i>Eliminar
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} 

{% block scripts %}
<!-- DataTables JS -->
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

<script>
  // Función simple para crear backup
  // Función para mostrar notificaciones emergentes
  function showNotification(title, message, type = "info", duration = 5000) {
    // Crear el modal de notificación
    const modalHtml = `
      <div class="modal fade" id="notificationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header ${type === "success" ? "bg-success text-white" : type === "error" ? "bg-danger text-white" : "bg-info text-white"}">
              <h5 class="modal-title">
                ${type === "success" ? "✅" : type === "error" ? "❌" : "ℹ️"} ${title}
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <p class="mb-0">${message}</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
          </div>
        </div>
      </div>
    `;

    // Remover modal anterior si existe
    const existingModal = document.getElementById("notificationModal");
    if (existingModal) {
      existingModal.remove();
    }

    // Agregar nuevo modal al body
    document.body.insertAdjacentHTML("beforeend", modalHtml);

    // Mostrar modal
    const modal = new bootstrap.Modal(
      document.getElementById("notificationModal")
    );
    modal.show();

    // Auto-cerrar después del tiempo especificado
    if (duration > 0) {
      setTimeout(() => {
        modal.hide();
      }, duration);
    }
  }

  // Función para mostrar progreso
  function showProgress(title, message) {
    const progressHtml = `
      <div class="modal fade" id="progressModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title">🔄 ${title}</h5>
            </div>
            <div class="modal-body text-center">
              <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Procesando...</span>
              </div>
              <p class="mb-0">${message}</p>
            </div>
          </div>
        </div>
      </div>
    `;

    // Remover modal anterior si existe
    const existingModal = document.getElementById("progressModal");
    if (existingModal) {
      existingModal.remove();
    }

    // Agregar nuevo modal al body
    document.body.insertAdjacentHTML("beforeend", progressHtml);

    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById("progressModal"));
    modal.show();
    return modal;
  }

  function createLocalBackup() {
    const button = document.getElementById("createBackupBtn");
    if (!button) {
      showNotification("Error", "No se encontró el botón de backup", "error");
      return;
    }

    // Deshabilitar botón
    button.disabled = true;
    button.innerHTML =
      '<span class="spinner-border spinner-border-sm me-2"></span>Creando respaldo...';

    // Mostrar progreso
    const progressModal = showProgress(
      "Creando Respaldo Local",
      "Generando backup de la base de datos..."
    );

    // Realizar petición POST
    fetch("/admin/db/backup", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Requested-With": "XMLHttpRequest",
      },
      credentials: "same-origin",
    })
      .then((response) => {
        console.log("Response status:", response.status);
        console.log("Response headers:", response.headers);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        return response.json();
      })
      .then((data) => {
        console.log("Response data:", data);
        progressModal.hide();

        if (data.status === "success") {
          showNotification(
            "Éxito",
            "✅ Respaldo local creado exitosamente!",
            "success"
          );
          setTimeout(() => window.location.reload(), 2000);
        } else {
          throw new Error(data.message || "Error desconocido");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        progressModal.hide();
        showNotification(
          "Error",
          "❌ Error al crear respaldo: " + error.message,
          "error"
        );
      })
      .finally(() => {
        // Restaurar botón
        button.disabled = false;
        button.innerHTML =
          '<i class="bi bi-download me-2"></i>Crear Respaldo Local';
      });
  }

  // Variable global para almacenar el archivo a eliminar
  let backupToDelete = null;

  // Configurar modal de eliminación
  document.addEventListener("DOMContentLoaded", function () {
    const backupBtn = document.getElementById("createBackupBtn");
    if (backupBtn) {
      backupBtn.addEventListener("click", createLocalBackup);
    }

    // Configurar modal de eliminación
    const deleteModal = document.getElementById("deleteBackupModal");
    if (deleteModal) {
      deleteModal.addEventListener("show.bs.modal", function (event) {
        const button = event.relatedTarget;
        const backup = button.getAttribute("data-backup");
        backupToDelete = backup;

        const backupNameElement = document.getElementById("backupToDelete");
        if (backupNameElement) {
          backupNameElement.textContent = backup;
        }
      });
    }
  });

  // Función para restaurar backup
  function restoreLocalBackup(filename) {
    if (!confirm("¿Restaurar desde " + filename + "?")) {
      return;
    }

    // Mostrar progreso
    const progressModal = showProgress(
      "Restaurando Backup",
      "Restaurando datos desde " + filename + "..."
    );

    fetch("/admin/restore-local-backup", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Requested-With": "XMLHttpRequest",
      },
      credentials: "same-origin",
      body: JSON.stringify({ filename: filename }),
    })
      .then((response) => response.json())
      .then((data) => {
        progressModal.hide();

        if (data.success) {
          showNotification(
            "Éxito",
            "✅ Backup restaurado exitosamente!",
            "success"
          );
          setTimeout(() => window.location.reload(), 2000);
        } else {
          throw new Error(data.error || "Error desconocido");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        progressModal.hide();
        showNotification(
          "Error",
          "❌ Error al restaurar: " + error.message,
          "error"
        );
      });
  }

  // Función para subir a Google Drive
  function uploadToDrive(filename) {
    if (!confirm("¿Subir " + filename + " a Google Drive?")) {
      return;
    }

    // Mostrar progreso
    const progressModal = showProgress(
      "Subiendo a Google Drive",
      "Subiendo " + filename + " a Google Drive..."
    );

    fetch("/admin/backup/upload-to-drive/" + encodeURIComponent(filename), {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Requested-With": "XMLHttpRequest",
      },
      credentials: "same-origin",
    })
      .then((response) => response.json())
      .then((data) => {
        progressModal.hide();

        if (data.success) {
          showNotification(
            "Éxito",
            "✅ Backup subido a Google Drive exitosamente!",
            "success"
          );
          setTimeout(() => window.location.reload(), 2000);
        } else {
          throw new Error(data.error || "Error desconocido");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        progressModal.hide();
        showNotification(
          "Error",
          "❌ Error al subir a Google Drive: " + error.message,
          "error"
        );
      });
  }

  // Función para eliminar backup local
  function deleteLocalBackup() {
    if (!backupToDelete) {
      showNotification("Error", "No se especificó archivo a eliminar", "error");
      return;
    }

    // Cerrar modal
    const modal = bootstrap.Modal.getInstance(
      document.getElementById("deleteBackupModal")
    );
    if (modal) {
      modal.hide();
    }

    // Mostrar progreso
    const progressModal = showProgress(
      "Eliminando Backup",
      "Eliminando " + backupToDelete + "..."
    );

    fetch("/admin/backup/delete-local/" + encodeURIComponent(backupToDelete), {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
        "X-Requested-With": "XMLHttpRequest",
      },
      credentials: "same-origin",
    })
      .then((response) => response.json())
      .then((data) => {
        progressModal.hide();

        if (data.success) {
          showNotification(
            "Éxito",
            "✅ Backup eliminado exitosamente!",
            "success"
          );
          setTimeout(() => window.location.reload(), 2000);
        } else {
          throw new Error(data.error || "Error desconocido");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        progressModal.hide();
        showNotification(
          "Error",
          "❌ Error al eliminar backup: " + error.message,
          "error"
        );
      });
  }

  // Configuración básica cuando el DOM esté listo
  document.addEventListener('DOMContentLoaded', function() {
    // Configurar botón de actualizar
    const refreshBtn = document.getElementById('refreshBtn');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', function() {
        // Mostrar indicador de carga
        this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Actualizando...';
        this.disabled = true;
        
        // Recargar la página después de un breve delay
        setTimeout(() => {
          window.location.reload();
        }, 500);
      });
    }
    
    // Manejar el botón volver arriba del template base
    function handleScroll() {
      const scrollY = window.pageYOffset;
      const goTopBtn = document.getElementById('goTopBtn');
      if (goTopBtn) {
        if (scrollY > 200) {
          goTopBtn.style.display = 'block';
        } else {
          goTopBtn.style.display = 'none';
        }
      }
    }
    
    // Configurar el evento de scroll
    window.addEventListener('scroll', handleScroll);
    
    // Ejecutar handleScroll una vez para configurar el estado inicial
    handleScroll();
  });

  // Inicializar DataTable si hay backups
  {% if backups %}
  $(document).ready(function() {
    var table = $('#backupsTable').DataTable({
      "order": [[3, "desc"]], // Ordenar por fecha (columna 3)
      "language": {
        "url": "//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
      },
      "columnDefs": [
        { "orderable": false, "targets": [0, 5] }, // Deshabilitar ordenación en checkbox y acciones
        { "searchable": false, "targets": [0, 5] } // No buscar en checkbox y acciones
      ],
      "pageLength": 25, // Mostrar 25 elementos por página por defecto
      "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]], // Opciones de elementos por página
      "responsive": true,
      "dom": '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
             '<"row"<"col-sm-12"tr>>' +
             '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>'
    });

    // Manejar selección de todos los checkboxes
    $('#selectAll').change(function() {
      $('.backup-checkbox').prop('checked', $(this).is(':checked'));
      updateSelectedCount();
      updateActionButtons();
    });

    // Manejar selección individual de checkboxes
    $(document).on('change', '.backup-checkbox', function() {
      updateSelectedCount();
      updateActionButtons();

      // Actualizar estado del checkbox "Seleccionar todo"
      var totalCheckboxes = $('.backup-checkbox').length;
      var checkedCheckboxes = $('.backup-checkbox:checked').length;
      $('#selectAll').prop('checked', totalCheckboxes === checkedCheckboxes);
      $('#selectAll').prop('indeterminate', checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes);
    });

    // Actualizar contador de elementos seleccionados
    function updateSelectedCount() {
      var count = $('.backup-checkbox:checked').length;
      $('#selectedCount').text(count + ' elemento' + (count !== 1 ? 's' : '') + ' seleccionado' + (count !== 1 ? 's' : ''));
    }

    // Actualizar estado de botones de acción
    function updateActionButtons() {
      var hasSelected = $('.backup-checkbox:checked').length > 0;
      $('#deleteSelectedBackups').prop('disabled', !hasSelected);
    }

    // Botón de eliminar seleccionados
    $('#deleteSelectedBackups').click(function() {
      var selectedBackups = [];
      $('.backup-checkbox:checked').each(function() {
        selectedBackups.push({
          name: $(this).data('backup-name')
        });
      });

      if (selectedBackups.length === 0) {
        showAlert('warning', 'No hay backups seleccionados');
        return;
      }

      var confirmMsg = '¿Está seguro de que desea eliminar ' + selectedBackups.length + ' backup(s) seleccionado(s)?';
      if (confirm(confirmMsg)) {
        deleteMultipleBackups(selectedBackups);
      }
    });

    // Función para eliminar múltiples backups
    function deleteMultipleBackups(backups) {
      $('#deleteSelectedBackups').prop('disabled', true).html('<i class="bi bi-arrow-clockwise"></i> Eliminando...');

      var promises = [];
      var successCount = 0;
      var errorCount = 0;
      var processedRows = [];

      backups.forEach(function(backup) {
        var promise = fetch("/admin/backup/delete-local/" + encodeURIComponent(backup.name), {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest",
          },
          credentials: "same-origin",
        }).then(response => response.json()).then(function(response) {
          if (response.success === true) {
            successCount++;
            // Marcar fila para eliminación
            var row = $('.backup-checkbox[data-backup-name="' + backup.name + '"]').closest('tr');
            processedRows.push({row: row, success: true});
          } else {
            errorCount++;
          }
        }).catch(function() {
          errorCount++;
        });

        promises.push(promise);
      });

      Promise.all(promises.map(p => p.catch(e => e))).then(function() {
        // Eliminar filas exitosas
        processedRows.forEach(function(item) {
          if (item.success) {
            table.row(item.row).remove();
          }
        });

        table.draw();

        var message = '';
        if (successCount > 0) {
          message += successCount + ' backup(s) eliminado(s) exitosamente';
        }
        if (errorCount > 0) {
          if (message) message += '. ';
          message += errorCount + ' backup(s) no pudieron ser eliminados';
        }

        showAlert(errorCount === 0 ? 'success' : 'warning', message);

        // Resetear selecciones
        $('#selectAll').prop('checked', false);
        $('.backup-checkbox').prop('checked', false);
        updateSelectedCount();
        updateActionButtons();

        $('#deleteSelectedBackups').prop('disabled', false).html('<i class="bi bi-trash"></i> Eliminar Seleccionados');
      });
    }
  });
  {% endif %}

  // Función para mostrar alertas mejorada
  function showAlert(type, message) {
    // Mapear tipos de alerta a clases de Bootstrap 5
    var alertClass = 'alert-' + type;

    var alertHtml = '<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
                   '<div class="d-flex align-items-center">' +
                   '<i class="bi ' + getAlertIcon(type) + ' me-2"></i>' +
                   '<div>' + message + '</div>' +
                   '</div>' +
                   '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>' +
                   '</div>';

    // Remover alertas existentes
    $('.alert').not('.alert-permanent').remove();

    // Insertar alerta al principio del contenido
    $('.container-fluid h2').after(alertHtml);

    // Auto-remover después de 5 segundos para alertas de éxito
    if (type === 'success') {
      setTimeout(function() {
        $('.alert-' + type).fadeOut();
      }, 5000);
    }
  }

  // Función para obtener iconos según el tipo de alerta
  function getAlertIcon(type) {
    switch(type) {
      case 'success': return 'bi-check-circle-fill';
      case 'danger': return 'bi-exclamation-triangle-fill';
      case 'warning': return 'bi-exclamation-triangle-fill';
      case 'info': return 'bi-info-circle-fill';
      default: return 'bi-info-circle-fill';
    }
  }

  // Función para crear backup directo a Google Drive
  function createBackupToDrive() {
    console.log("=== INICIO FUNCIÓN createBackupToDrive ===");
    console.log("Función createBackupToDrive ejecutada");

    const button = document.getElementById("createBackupToDrive");
    if (!button) {
      console.error("No se encontró el botón createBackupToDrive");
      showNotification("Error", "No se encontró el botón de backup", "error");
      return;
    }

    console.log("Botón encontrado, solicitando confirmación");
    if (!confirm("¿Crear backup y subirlo directamente a Google Drive?")) {
      console.log("Usuario canceló la operación");
      return;
    }

    console.log("Usuario confirmó, iniciando proceso");
    // Deshabilitar botón
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creando...';

    // Mostrar progreso
    const progressModal = showProgress("Creando Backup Directo", "Generando backup y subiendo a Google Drive...");

    console.log("Enviando petición a /admin/backup/create-and-upload");
    // Crear backup y subir a Google Drive
    fetch("/admin/backup/create-and-upload", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Requested-With": "XMLHttpRequest",
      },
      credentials: "same-origin",
    })
      .then((response) => {
        console.log("Response status:", response.status);
        console.log("Response headers:", response.headers);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        return response.json();
      })
      .then((data) => {
        console.log("Response data:", data);
        progressModal.hide();

        if (data.success) {
          showNotification("Éxito", "✅ Backup creado y subido a Google Drive exitosamente!", "success");
          setTimeout(() => window.location.reload(), 2000);
        } else {
          throw new Error(data.error || "Error desconocido");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        progressModal.hide();
        showNotification("Error", "❌ Error al crear backup directo: " + error.message, "error");
      })
      .finally(() => {
        // Restaurar botón
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-cloud-upload"></i> Crear Backup Directo';
        console.log("=== FIN FUNCIÓN createBackupToDrive ===");
      });
  }

  // Configurar botón de crear backup directo
  document.addEventListener('DOMContentLoaded', function() {
    const createBackupToDriveBtn = document.getElementById('createBackupToDrive');
    if (createBackupToDriveBtn) {
      createBackupToDriveBtn.addEventListener('click', createBackupToDrive);
    }
  });
</script>
{% endblock %}
