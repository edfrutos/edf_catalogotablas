{% extends "admin/base.html" %}
<!-- eslint-disable -->
{% block title %}Editar Fila - {{ catalog.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="mb-0">
                <i class="fas fa-edit"></i> Editar Fila #{{ row_index + 1 }}
            </h2>
            <a href="{{ url_for('admin.ver_catalogo_unificado', collection_source=catalog.collection_source, catalog_id=catalog._id) }}" 
               class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Volver al Catálogo
            </a>
        </div>
        <div class="card-body">
            <h5 class="card-title mb-4">{{ catalog.name }}</h5>
            
            <form method="POST" enctype="multipart/form-data">
                {% for header in catalog.headers %}
                    <div class="mb-3">
                        {% if header == 'Multimedia' %}
                            <!-- Campo especial para Multimedia -->
                            <div class="fw-bold mb-2" id="multimedia_section_{{ loop.index0 }}">
                                <i class="fas fa-video"></i> {{ header }}
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label" for="{{ header }}_url">URL de Multimedia (opcional)</label>
                                    <input type="url" class="form-control" id="{{ header }}_url" name="{{ header }}_url" 
                                           value="{{ row[header] if row[header] and row[header] is string and row[header].startswith('http') else '' }}"
                                           placeholder="https://ejemplo.com/video.mp4">
                                    <div class="form-text">Enlaza a un video, audio o imagen externa</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="{{ header }}_file">Subir Archivo Multimedia</label>
                                    <input type="file" class="form-control" id="{{ header }}_file" name="{{ header }}_file" 
                                           accept="video/*,audio/*,image/*">
                                    <div class="form-text">Videos, Audio, Imágenes | Máximo: 100MB</div>
                                </div>
                            </div>
                            
                            <!-- Mostrar multimedia actual -->
                            {% if row[header] %}
                                <div class="mt-3">
                                    <div class="form-label fw-bold mb-2" id="multimedia_actual_{{ loop.index0 }}">Multimedia Actual:</div>
                                    <div class="multimedia-preview" aria-labelledby="multimedia_actual_{{ loop.index0 }}">
                                        {% if row[header] is string and row[header].startswith('http') %}
                                            <div class="alert alert-info d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas fa-external-link-alt"></i> URL Externa: 
                                                    <a href="{{ row[header] }}" target="_blank">{{ row[header] }}</a>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        onclick="removeMultimedia('{{ header }}', '{{ row[header] }}', this)">
                                                    <i class="fas fa-trash"></i> Eliminar
                                                </button>
                                            </div>
                                        {% else %}
                                            <div class="alert alert-success d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas fa-file"></i> Archivo Local: {{ row[header] }}
                                                    <a href="{% if row[header] is string and (row[header].startswith('http') or row[header].startswith('/admin/s3/') or row[header].startswith('/s3/') or '/admin/s3/' in row[header] or '/s3/' in row[header]) %}{{ row[header] }}{% else %}{{ url_for('uploaded_images.uploaded_images', filename=row[header]) }}{% endif %}" 
                                                       target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                                                        <i class="fas fa-download"></i> Descargar
                                                    </a>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        onclick="removeMultimedia('{{ header }}', '{{ row[header] }}', this)">
                                                    <i class="fas fa-trash"></i> Eliminar
                                                </button>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                            
                        {% elif header in ['Documentos', 'Documentación'] or header.startswith('Documentación') %}
                            <!-- Campo especial para Documentos/Documentación - MÚLTIPLES DOCUMENTOS -->
                            <div class="fw-bold mb-2" id="documentos_section_{{ loop.index0 }}">
                                <i class="fas fa-file-alt"></i> {{ header }}
                                <span class="badge bg-success ms-2">Múltiples</span>
                            </div>
                            
                            <!-- URLs de Documentos -->
                            <div class="mb-3">
                                <fieldset>
                                    <legend class="form-label">URLs de Documentos (opcional)</legend>
                                    <div id="urls-container-{{ loop.index0 }}">
                                    {% if row[header] and row[header] is iterable and row[header] is not string %}
                                        <!-- Mostrar URLs existentes -->
                                        {% for doc in row[header] %}
                                            {% if doc is string and doc.startswith('http') %}
                                                <div class="input-group mb-2">
                                                    <input type="url" class="form-control" name="{{ header }}_url_{{ loop.index0 }}" 
                                                           value="{{ doc }}" placeholder="https://ejemplo.com/documento.pdf">
                                                    <button type="button" class="btn btn-outline-danger" onclick="removeUrlField(this)">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    {% elif row[header] and row[header] is string and row[header].startswith('http') %}
                                        <!-- Documento único existente (formato antiguo) -->
                                        <div class="input-group mb-2">
                                            <input type="url" class="form-control" name="{{ header }}_url_{{ loop.index0 }}" 
                                                   value="{{ row[header] }}" placeholder="https://ejemplo.com/documento.pdf">
                                            <button type="button" class="btn btn-outline-danger" onclick="removeUrlField(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    {% else %}
                                        <!-- Campo vacío inicial -->
                                        <div class="input-group mb-2">
                                            <input type="url" class="form-control" name="{{ header }}_url_{{ loop.index0 }}" 
                                                   placeholder="https://ejemplo.com/documento.pdf">
                                            <button type="button" class="btn btn-outline-success" onclick="addUrlField('urls-container-{{ loop.index0 }}', '{{ header }}_url_{{ loop.index0 }}')">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    {% endif %}
                                </div>
                                </fieldset>
                                <div class="form-text">Puedes agregar múltiples URLs de documentos externos</div>
                            </div>
                            
                            <!-- Archivos de Documentos -->
                            <div class="mb-3">
                                <label class="form-label" for="{{ header }}_file_{{ loop.index0 }}">Subir Documentos</label>
                                    <input type="file" class="form-control" id="{{ header }}_file_{{ loop.index0 }}" name="{{ header }}_file_{{ loop.index0 }}" 
                                           accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.rtf,.md" multiple>
                                <div class="form-text">PDF, Word, Excel, Texto, RTF, Markdown | Máximo: 50MB cada uno | Puedes seleccionar múltiples archivos</div>
                            </div>
                            
                            <!-- Mostrar documentos actuales -->
                            {% if row[header] %}
                                <div class="mt-3">
                                    <div class="form-label fw-bold mb-2">Documentos Actuales:</div>
                                    <div class="documentos-preview">
                                        {% if row[header] is iterable and row[header] is not string %}
                                            <!-- Múltiples documentos (formato nuevo) -->
                                            {% for doc in row[header] %}
                                                {% if doc is string and doc.startswith('http') %}
                                                    <div class="alert alert-info mb-2 d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <i class="fas fa-external-link-alt"></i> URL Externa: 
                                                            <a href="{{ doc }}" target="_blank">{{ doc }}</a>
                                                        </div>
                                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                                onclick="removeDocument('{{ header }}', '{{ doc }}', this)">
                                                            <i class="fas fa-trash"></i> Eliminar
                                                        </button>
                                                    </div>
                                                {% elif doc %}
                                                    <div class="alert alert-success mb-2 d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <i class="fas fa-file"></i> Archivo Local: {{ doc }}
                                                            <a href="{% if doc is string and (doc.startswith('http') or doc.startswith('/admin/s3/') or doc.startswith('/s3/') or '/admin/s3/' in doc or '/s3/' in doc) %}{{ doc }}{% else %}{{ url_for('uploaded_images.uploaded_images', filename=doc) }}{% endif %}" 
                                                               target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                                                                <i class="fas fa-download"></i> Descargar
                                                            </a>
                                                        </div>
                                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                                onclick="removeDocument('{{ header }}', '{{ doc }}', this)">
                                                            <i class="fas fa-trash"></i> Eliminar
                                                        </button>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        {% elif row[header] is string and row[header].startswith('http') %}
                                            <!-- Documento único URL (formato antiguo) -->
                                            <div class="alert alert-info d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas fa-external-link-alt"></i> URL Externa: 
                                                    <a href="{{ row[header] }}" target="_blank">{{ row[header] }}</a>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        onclick="removeDocument('{{ header }}', '{{ row[header] }}', this)">
                                                    <i class="fas fa-trash"></i> Eliminar
                                                </button>
                                            </div>
                                        {% elif row[header] %}
                                            <!-- Documento único archivo (formato antiguo) -->
                                            <div class="alert alert-success d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas fa-file"></i> Archivo Local: {{ row[header] }}
                                                    <a href="{% if row[header] is string and (row[header].startswith('http') or row[header].startswith('/admin/s3/') or row[header].startswith('/s3/') or '/admin/s3/' in row[header] or '/s3/' in row[header]) %}{{ row[header] }}{% else %}{{ url_for('uploaded_images.uploaded_images', filename=row[header]) }}{% endif %}" 
                                                       target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                                                        <i class="fas fa-download"></i> Descargar
                                                    </a>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        onclick="removeDocument('{{ header }}', '{{ row[header] }}', this)">
                                                    <i class="fas fa-trash"></i> Eliminar
                                                </button>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                            
                        {% elif header == 'Fecha' %}
                            <!-- Campo especial para Fecha (columna inteligente) -->
                            <label for="{{ header }}" class="form-label fw-bold">
                                <i class="fas fa-calendar-alt"></i> {{ header }}
                                <span class="badge bg-info ms-2">Auto</span>
                            </label>
                            <div class="input-group">
                                <input type="date" class="form-control" id="{{ header }}" name="{{ header }}" 
                                       value="{{ row[header] if row[header] else '' }}">
                                <button type="button" class="btn btn-outline-secondary" onclick="setTodayDate('{{ header }}')">
                                    <i class="fas fa-calendar-day"></i> Hoy
                                </button>
                            </div>
                            <div class="form-text">
                                <i class="fas fa-magic"></i> <strong>Columna Inteligente:</strong> 
                                Esta fecha se asigna automáticamente al crear la fila. Puedes modificarla si es necesario.
                            </div>
                        {% else %}
                            <!-- Campo normal -->
                            <label class="form-label fw-bold" for="campo_{{ header|lower|replace(' ', '_') }}">{{ header }}</label>
                            <input type="text" class="form-control" name="{{ header }}" 
                                   value="{{ row[header] or '' }}" placeholder="Ingrese {{ header.lower() }}">
                        {% endif %}
                    </div>
                {% endfor %}
                
                <!-- Campo de imágenes -->
                <div class="mb-3">
                    <label class="form-label fw-bold" for="form_images">
                        <i class="fas fa-images"></i> Imágenes
                    </label>
                    <input type="file" class="form-control" id="form_images" name="images" multiple accept="image/*">
                    <div class="form-text">Puedes seleccionar múltiples imágenes | Máximo: 10MB por imagen</div>
                    
                    <!-- Mostrar imágenes actuales -->
                                            {% if row is mapping and row.get('images') %}
                        <div class="mt-3">
                            <small class="text-muted">Imágenes actuales:</small>
                            <div class="row mt-2">
                                {% for img in row.images %}
                                    <div class="col-md-2 mb-2">
                                        <div class="position-relative">
                                            {% if img is string and (img.startswith('http') or img.startswith('/admin/s3/') or img.startswith('/s3/') or '/admin/s3/' in img or '/s3/' in img) %}
                                                <!-- URL externa o S3 -->
                                                <button type="button" class="p-0 border-0 bg-transparent" onclick="previewImage('{{ img }}')">
                                                    <img src="{{ img }}" 
                                                         alt="{{ loop.index }}" 
                                                         class="img-thumbnail" 
                                                         style="width: 100px; height: 100px; object-fit: cover;">
                                                </button>
                                            {% else %}
                                                <!-- Archivo local -->
                                                <button type="button" class="p-0 border-0 bg-transparent" onclick="previewImage('{{ url_for('uploaded_images.uploaded_images', filename=img) }}')">
                                                    <img src="{{ url_for('uploaded_images.uploaded_images', filename=img) }}" 
                                                         alt="{{ loop.index }}" 
                                                         class="img-thumbnail" 
                                                         style="width: 100px; height: 100px; object-fit: cover;">
                                                </button>
                                            {% endif %}
                                            <div class="form-check position-absolute top-0 start-0">
                                                <input class="form-check-input" type="checkbox" 
                                                       name="delete_images" value="{{ img }}" 
                                                       id="delete_img_{{ loop.index }}">
                                                <label class="form-check-label text-danger" for="delete_img_{{ loop.index }}">
                                                    <i class="fas fa-trash"></i>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Campos ocultos para elementos a eliminar -->
                <input type="hidden" name="deleted_documents" id="deleted_documents" value="">
                <input type="hidden" name="deleted_multimedia" id="deleted_multimedia" value="">
                
                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('admin.ver_catalogo_unificado', collection_source=catalog.collection_source, catalog_id=catalog._id) }}" 
                       class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block head %}
{{ super() }}
<style>
    .form-label.fw-bold {
        color: #495057;
        font-size: 1.1em;
    }
    
    .badge {
        font-size: 0.9em;
    }
    
    .position-relative {
        position: relative;
    }
    
    .position-absolute {
        position: absolute;
    }
    
    .top-0 {
        top: 0;
    }
    
    .start-0 {
        left: 0;
    }
    
    .form-check-input:checked {
        background-color: #dc3545;
        border-color: #dc3545;
    }
</style>

<script>
// Función para establecer la fecha de hoy
function setTodayDate(fieldId) {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const formattedDate = `${year}-${month}-${day}`;
    
    const dateInput = document.getElementById(fieldId);
    if (dateInput) {
        dateInput.value = formattedDate;
        // Mostrar notificación
        showNotification('Fecha actualizada a hoy', 'success');
    }
}

// Función para agregar campos de URL dinámicamente
function addUrlField(containerId, fieldName) {
    const container = document.getElementById(containerId);
    const newField = document.createElement('div');
    newField.className = 'input-group mb-2';
    newField.innerHTML = `
        <input type="url" class="form-control" name="${fieldName}" 
               placeholder="https://ejemplo.com/documento.pdf">
        <button type="button" class="btn btn-outline-danger" onclick="removeUrlField(this)">
            <i class="fas fa-trash"></i>
        </button>
    `;
    container.appendChild(newField);
}

// Función para eliminar campos de URL
function removeUrlField(button) {
    button.parentElement.remove();
}

// Función para eliminar documentos
function removeDocument(header, documentValue, button) {
    if (confirm('¿Estás seguro de que quieres eliminar este documento?')) {
        // Agregar a la lista de documentos eliminados
        const deletedField = document.getElementById('deleted_documents');
        const currentDeleted = deletedField.value ? JSON.parse(deletedField.value) : [];
        currentDeleted.push({
            header: header,
            value: documentValue
        });
        deletedField.value = JSON.stringify(currentDeleted);
        
        // Remover visualmente el elemento
        button.closest('.alert').remove();
        
        // Mostrar mensaje de confirmación
        showNotification('Documento marcado para eliminación', 'warning');
    }
}

// Función para eliminar multimedia
function removeMultimedia(header, multimediaValue, button) {
    if (confirm('¿Estás seguro de que quieres eliminar este multimedia?')) {
        // Agregar a la lista de multimedia eliminado
        const deletedField = document.getElementById('deleted_multimedia');
        const currentDeleted = deletedField.value ? JSON.parse(deletedField.value) : [];
        currentDeleted.push({
            header: header,
            value: multimediaValue
        });
        deletedField.value = JSON.stringify(currentDeleted);
        
        // Remover visualmente el elemento
        button.closest('.alert').remove();
        
        // Mostrar mensaje de confirmación
        showNotification('Multimedia marcado para eliminación', 'warning');
    }
}

// Función para mostrar notificaciones
function showNotification(message, type = 'info') {
    // Crear elemento de notificación
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Agregar al body
    document.body.appendChild(notification);
    
    // Auto-remover después de 3 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

// Script para proteger imágenes de interferencia de extensiones del navegador
document.addEventListener('DOMContentLoaded', function() {
    console.log('[IMG-PROTECTION] 🛡️ Iniciando protección de imágenes...');
    
    const protectImages = () => {
        const images = document.querySelectorAll('img');
        let correctedCount = 0;
        
        images.forEach(img => {
            // Si la imagen tiene una URL incorrecta, corregirla
            if (img.src && img.src.includes('/static/uploads/')) {
                let newSrc = img.src;
                
                // Corregir URLs malformadas
                if (img.src.includes('/static/uploads//admin/s3/')) {
                    newSrc = img.src.replace('/static/uploads//admin/s3/', '/admin/s3/');
                } else if (img.src.includes('/static/uploads/')) {
                    // Extraer el nombre del archivo
                    const filename = img.src.split('/').pop();
                    // Usar la ruta correcta para archivos locales
                    newSrc = `{{ url_for('static', filename='uploads/') }}${filename}`;
                }
                
                console.log('[IMG-PROTECTION] 🔧 Corrigiendo URL:', img.src, '→', newSrc);
                img.src = newSrc;
                correctedCount++;
            }
        });
        
        if (correctedCount > 0) {
            console.log(`[IMG-PROTECTION] ✅ ${correctedCount} imágenes corregidas`);
        }
    };
    
    // Ejecutar protección inmediatamente
    protectImages();
    
    // Re-ejecutar cada 2 segundos para nuevas imágenes o cambios por extensiones
    setInterval(protectImages, 2000);
});
</script>

<!-- Scripts de modales para templates de edición admin -->
<!-- modal-functions-UNIFIED.js ya se carga en base.html, no duplicar -->
<script src="{{ url_for('static', filename='js/modal-img-display-fix.js') }}?v={{ range(1, 10000) | random }}&fix=20251007"></script>
{% endblock %}
