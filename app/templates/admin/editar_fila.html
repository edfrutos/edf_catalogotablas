{% extends "admin/base.html" %}

{% block title %}Editar Fila - {{ catalog.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="mb-0">
                <i class="fas fa-edit"></i> Editar Fila #{{ row_index + 1 }}
            </h2>
            <a href="{{ url_for('admin.ver_catalogo_unificado', collection_source=catalog.collection_source, catalog_id=catalog._id) }}" 
               class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Volver al Catálogo
            </a>
        </div>
        <div class="card-body">
            <h5 class="card-title mb-4">{{ catalog.name }}</h5>
            
            <form method="POST" enctype="multipart/form-data">
                {% for header in catalog.headers %}
                    <div class="mb-3">
                        {% if header == 'Multimedia' %}
                            <!-- Campo especial para Multimedia -->
                            <label class="form-label fw-bold">
                                <i class="fas fa-video"></i> {{ header }}
                            </label>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">URL de Multimedia (opcional)</label>
                                    <input type="url" class="form-control" name="{{ header }}_url" 
                                           value="{{ row[header] if row[header] and row[header].startswith('http') else '' }}"
                                           placeholder="https://ejemplo.com/video.mp4">
                                    <div class="form-text">Enlaza a un video, audio o imagen externa</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Subir Archivo Multimedia</label>
                                    <input type="file" class="form-control" name="{{ header }}_file" 
                                           accept="video/*,audio/*,image/*">
                                    <div class="form-text">Videos, Audio, Imágenes | Máximo: 100MB</div>
                                </div>
                            </div>
                            
                            <!-- Mostrar multimedia actual -->
                            {% if row[header] %}
                                <div class="mt-2">
                                    <small class="text-muted">Multimedia actual:</small>
                                    {% if row[header].startswith('http') %}
                                        <a href="{{ row[header] }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-external-link-alt"></i> Ver Multimedia
                                        </a>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ row[header] }}</span>
                                    {% endif %}
                                </div>
                            {% endif %}
                            
                        {% elif header in ['Documentos', 'Documentación'] %}
                            <!-- Campo especial para Documentos/Documentación -->
                            <label class="form-label fw-bold">
                                <i class="fas fa-file-alt"></i> {{ header }}
                            </label>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">URL de Documento (opcional)</label>
                                    <input type="url" class="form-control" name="{{ header }}_url" 
                                           value="{{ row[header] if row[header] and row[header].startswith('http') else '' }}"
                                           placeholder="https://ejemplo.com/documento.pdf">
                                    <div class="form-text">Enlaza a un documento externo</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Subir Documento</label>
                                    <input type="file" class="form-control" name="{{ header }}_file" 
                                           accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.rtf,.md">
                                    <div class="form-text">PDF, Word, Excel, Texto, RTF, Markdown | Máximo: 50MB</div>
                                </div>
                            </div>
                            
                            <!-- Mostrar documento actual -->
                            {% if row[header] %}
                                <div class="mt-2">
                                    <small class="text-muted">Documento actual:</small>
                                    {% if row[header].startswith('http') %}
                                        <a href="{{ row[header] }}" target="_blank" class="btn btn-sm btn-outline-info">
                                            <i class="fas fa-external-link-alt"></i> Ver Documento
                                        </a>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ row[header] }}</span>
                                    {% endif %}
                                </div>
                            {% endif %}
                            
                        {% else %}
                            <!-- Campo normal -->
                            <label class="form-label fw-bold">{{ header }}</label>
                            <input type="text" class="form-control" name="{{ header }}" 
                                   value="{{ row[header] or '' }}" placeholder="Ingrese {{ header.lower() }}">
                        {% endif %}
                    </div>
                {% endfor %}
                
                <!-- Campo de imágenes -->
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="fas fa-images"></i> Imágenes
                    </label>
                    <input type="file" class="form-control" name="images" multiple accept="image/*">
                    <div class="form-text">Puedes seleccionar múltiples imágenes | Máximo: 10MB por imagen</div>
                    
                    <!-- Mostrar imágenes actuales -->
                                            {% if row is mapping and row.get('images') %}
                        <div class="mt-3">
                            <small class="text-muted">Imágenes actuales:</small>
                            <div class="row mt-2">
                                {% for img in row.images %}
                                    <div class="col-md-2 mb-2">
                                        <div class="position-relative">
                                            <img src="{{ url_for('static', filename='uploads/' + img) }}" 
                                                 alt="Imagen {{ loop.index }}" 
                                                 class="img-thumbnail" 
                                                 style="width: 100px; height: 100px; object-fit: cover;">
                                            <div class="form-check position-absolute top-0 start-0">
                                                <input class="form-check-input" type="checkbox" 
                                                       name="delete_images" value="{{ img }}" 
                                                       id="delete_img_{{ loop.index }}">
                                                <label class="form-check-label text-danger" for="delete_img_{{ loop.index }}">
                                                    <i class="fas fa-trash"></i>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('admin.ver_catalogo_unificado', collection_source=catalog.collection_source, catalog_id=catalog._id) }}" 
                       class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block head %}
{{ super() }}
<style>
    .form-label.fw-bold {
        color: #495057;
        font-size: 1.1em;
    }
    
    .badge {
        font-size: 0.9em;
    }
    
    .position-relative {
        position: relative;
    }
    
    .position-absolute {
        position: absolute;
    }
    
    .top-0 {
        top: 0;
    }
    
    .start-0 {
        left: 0;
    }
    
    .form-check-input:checked {
        background-color: #dc3545;
        border-color: #dc3545;
    }
</style>
{% endblock %}
