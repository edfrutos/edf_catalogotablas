{% extends "base.html" %}
{% block title %}Panel de Administración{% endblock %}
{% block content %}
<div class="container mt-4">
  <div class="row mb-4">
    <div class="col-12 text-center">
      <h2 class="mb-2"><i class="bi bi-speedometer2"></i> Panel de Administración</h2>
      <p class="lead">Bienvenido, <strong>{{ session.username }}</strong>. Aquí puedes gestionar usuarios, catálogos y ver el estado del sistema.</p>
    </div>
  </div>
  <div class="row mb-4 text-center">
    <div class="col-md-4 mb-3">
      <div class="card shadow border-0 h-100">
        <div class="card-body bg-primary text-white rounded">
          <h5 class="card-title"><i class="bi bi-people"></i> Usuarios registrados</h5>
          <p class="display-4 fw-bold">{{ total_usuarios or '—' }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card shadow border-0 h-100">
        <div class="card-body bg-success text-white rounded">
          <h5 class="card-title"><i class="bi bi-table"></i> Catálogos/Tablas</h5>
          <p class="display-4 fw-bold">{{ total_catalogos or '—' }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card shadow border-0 h-100">
        <div class="card-body bg-warning text-dark rounded">
          <h5 class="card-title"><i class="bi bi-percent"></i> Porcentaje</h5>
          {% if porcentaje is not none and porcentaje > 0 %}
            <p class="fw-bold fs-5">{{ porcentaje|round(2) }}&#37;</p>
          {% else %}
            <p class="fw-bold fs-5 text-muted">—</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  <div class="row mb-4">
    <div class="col-md-4 mb-3">
      <a href="{{ url_for('admin.lista_usuarios') }}" class="btn btn-outline-info w-100 py-3 shadow-sm" title="Gestión de Usuarios">
        <i class="bi bi-person-lines-fill"></i> Gestión de Usuarios
      </a>
    </div>
    <div class="col-md-4 mb-3">
      <a href="{{ url_for('admin.maintenance') }}" class="btn btn-outline-warning w-100 py-3 shadow-sm" title="Mantenimiento del sistema">
        <i class="bi bi-tools"></i> Mantenimiento
      </a>
    </div>
    <div class="col-md-4 mb-3">
      <a href="{{ url_for('catalogs.list') }}" class="btn btn-outline-primary w-100 py-3 shadow-sm" title="Mis Catálogos">
        <i class="bi bi-table"></i> Mis Catálogos
      </a>
    </div>
  </div>
  <h4 class="mt-4 mb-3"><i class="bi bi-people"></i> Catálogos por Usuario</h4>
  <div class="table-responsive mb-4">
    <table class="table table-hover align-middle shadow-sm">
      <thead class="table-light">
        <tr>
          <th>Usuario</th>
          <th>Email</th>
          <th>Rol</th>
          <th>Nº Catálogos</th>
          <th>Última Actualización</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for usuario in usuarios %}
        <tr>
          <td><i class="bi bi-person"></i> {{ usuario.nombre }}</td>
          <td>{{ usuario.email }}</td>
          <td>
            <span class="badge {% if usuario.role == 'admin' %}bg-danger{% else %}bg-primary{% endif %}">
              {{ usuario.role }}
            </span>
          </td>
          <td class="text-center">
            <span class="badge bg-success">{{ usuario.count }}</span>
          </td>
          <td>{{ usuario.last_update_str }}</td>
          <td>
            <a href="{{ url_for('admin.ver_catalogos_usuario_por_id', user_id=usuario.id) }}" class="btn btn-sm btn-outline-primary" title="Ver catálogos"><i class="bi bi-eye"></i> Ver</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% if not usuarios %}
      <div class="alert alert-info mt-3">No hay usuarios registrados.</div>
    {% endif %}
  </div>

  <h4 class="mt-4 mb-3"><i class="bi bi-clock-history"></i> Últimos Catálogos/Tablas Creados</h4>
  <div class="table-responsive">
    <table class="table table-hover align-middle shadow-sm">
      <thead class="table-light">
        <tr>
          <th>Nombre</th>
          <th>Propietario</th>
          <th>Fecha de creación</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for tabla in tablas[:5] %}
        <tr>
          <td><i class="bi bi-table"></i> {{ tabla.name }}</td>
          <td>{{ tabla.owner if tabla.owner else '—' }}</td>
          <td>
            {% if tabla.created_at %}
              {{ tabla.created_at.strftime('%Y-%m-%d %H:%M') if tabla.created_at.strftime else tabla.created_at }}
            {% else %}
              —
            {% endif %}
          </td>
          <td>
            {% if session.role == 'admin' or tabla.owner == session.username %}
              <a href="{{ url_for('main.ver_tabla', table_id=tabla._id) }}" class="btn btn-sm btn-outline-primary me-1" title="Ver"><i class="bi bi-eye"></i></a>
              <form action="{{ url_for('main.delete_table', table_id=tabla._id) }}" method="post" style="display:inline;">
                <button type="submit" class="btn btn-sm btn-outline-danger" title="Eliminar" onclick="return confirm('¿Seguro que deseas eliminar esta tabla?');"><i class="bi bi-trash"></i></button>
              </form>
            {% else %}
              <span class="text-muted">Sin permisos</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% if not tablas %}
      <div class="alert alert-info mt-3">No hay tablas/catálogos creados aún.</div>
    {% endif %}
  </div>
  <div class="row mt-3">
    <div class="col-md-4 mx-auto">
      <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-danger w-100 py-2 shadow-sm">
        <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
      </a>
    </div>
  </div>
</div>
{% endblock %}
