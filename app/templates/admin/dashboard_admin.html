{% extends "admin/base.html" %} {% block title %}Panel de Administraci√≥n{%
endblock %} {% block content %}
<div class="container mt-4">
  <form
    class="row mb-4"
    method="get"
    action="{{ url_for('admin.dashboard_admin') }}"
  >
    <div class="col-md-4 mb-2">
      <input
        type="text"
        class="form-control"
        name="search"
        placeholder="Buscar por nombre o propietario"
        value="{{ search or '' }}"
      />
    </div>
    <div class="col-md-3 mb-2">
      <select class="form-select" name="search_type">
        <option value="name" {% if search_type == 'name' %}selected{% endif %}>
          Nombre de cat√°logo/tabla
        </option>
        <option value="owner" {% if search_type == 'owner' %}selected{% endif %}>
          Usuario propietario
        </option>
      </select>
    </div>
    <div class="col-md-2 mb-2">
      <button type="submit" class="btn btn-primary w-100">
        <i class="bi bi-search"></i> Buscar
      </button>
    </div>
    <div class="col-md-3 mb-2">
      {% if search %}
      <a
        href="{{ url_for('admin.dashboard_admin') }}"
        class="btn btn-outline-secondary w-100"
        >Limpiar b√∫squeda</a
      >
      {% endif %}
    </div>
  </form>
  <div class="row mb-4">
    <div class="col-12 text-center">
      <h2 class="mb-2">
        <i class="bi bi-speedometer2"></i> Panel de Administraci√≥n
      </h2>
      <p class="lead">
        Bienvenido, <strong>{{ session.username }}</strong>. Aqu√≠ puedes
        gestionar usuarios, cat√°logos y ver el estado del sistema.
      </p>
    </div>
  </div>
  <div class="row mb-4 text-center">
    <div class="col-md-4 mb-3">
      <div class="card shadow border-0 h-100">
        <div class="card-body bg-primary text-white rounded">
          <h5 class="card-title">
            <i class="bi bi-people"></i> Usuarios registrados
          </h5>
          <p class="display-4 fw-bold">{{ total_usuarios or '‚Äî' }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card shadow border-0 h-100">
        <div class="card-body bg-success text-white rounded">
          <h5 class="card-title">
            <i class="bi bi-table"></i> Cat√°logos/Tablas
          </h5>
          <p class="display-4 fw-bold">{{ total_catalogos or '‚Äî' }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card shadow border-0 h-100">
        <div class="card-body bg-warning text-dark rounded">
          <h5 class="card-title"><i class="bi bi-percent"></i> Porcentaje</h5>
          {% if porcentaje is not none and porcentaje > 0 %}
          <p class="fw-bold fs-5">{{ porcentaje|round(2) }}&#37;</p>
          {% else %}
          <p class="fw-bold fs-5 text-muted">‚Äî</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  <div class="row mb-4">
    <div class="col-md-4 mb-3">
      <a
        href="{{ url_for('admin.lista_usuarios') }}"
        class="btn btn-outline-info w-100 py-3 shadow-sm"
        title="Gesti√≥n de Usuarios"
      >
        <i class="bi bi-person-lines-fill"></i> Gesti√≥n de Usuarios
      </a>
    </div>
    <div class="col-md-4 mb-3">
      <a
        href="{{ url_for('maintenance.maintenance_dashboard') }}"
        class="btn btn-outline-warning w-100 py-3 shadow-sm"
        title="Mantenimiento del sistema"
      >
        <i class="bi bi-tools"></i> Mantenimiento
      </a>
    </div>
    <div class="col-md-4 mb-3">
      <a
        href="{{ url_for('admin.db_scripts') }}"
        class="btn btn-outline-secondary w-100 py-3 shadow-sm"
        title="Gesti√≥n de Scripts DB"
      >
        <i class="bi bi-terminal"></i> Scripts DB
      </a>
    </div>
  </div>
  <h4 class="mt-4 mb-3"><i class="bi bi-folder-check"></i> Mis Cat√°logos</h4>
  
  <!-- Controles de selecci√≥n m√∫ltiple -->
  <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-light rounded">
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="selectAllCatalogs">
      <label class="form-check-label" for="selectAllCatalogs">
        Seleccionar todos
      </label>
    </div>
    <div>
      <span id="selectedCount" class="text-muted me-3">0 seleccionados</span>
      <button type="button" class="btn btn-danger btn-sm" id="deleteSelectedCatalogs" disabled>
        <i class="bi bi-trash"></i> Eliminar seleccionados
      </button>
    </div>
  </div>

  <div class="table-responsive mb-4">
    <table class="table table-hover align-middle shadow-sm" id="catalogsTable">
      <thead class="table-light">
        <tr>
          <th width="40">
            <input type="checkbox" id="selectAllHeader" class="form-check-input">
          </th>
          <th class="sortable" data-column="1" style="cursor: pointer;">
            <i class="bi bi-table"></i> Nombre
            <i class="bi bi-chevron-expand sort-icon" style="font-size: 0.8em; opacity: 0.5; margin-left: 5px;"></i>
          </th>
          <th class="sortable" data-column="2" style="cursor: pointer;">
            <i class="bi bi-tag"></i> Tipo
            <i class="bi bi-chevron-expand sort-icon" style="font-size: 0.8em; opacity: 0.5; margin-left: 5px;"></i>
          </th>
          <th class="sortable" data-column="3" style="cursor: pointer;">
            <i class="bi bi-calendar"></i> Fecha de creaci√≥n
            <i class="bi bi-chevron-expand sort-icon" style="font-size: 0.8em; opacity: 0.5; margin-left: 5px;"></i>
          </th>
          <th><i class="bi bi-gear"></i> Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for cat in mis_registros %}
        <tr data-catalog-id="{{ cat._id }}" data-collection-source="{{ cat.tipo == 'spreadsheet' and 'spreadsheets' or 'catalogs' }}">
          <td>
            <input type="checkbox" class="form-check-input catalog-checkbox" 
                   data-catalog-id="{{ cat._id }}" 
                   data-collection-source="{{ cat.tipo == 'spreadsheet' and 'spreadsheets' or 'catalogs' }}"
                   data-catalog-name="{{ cat.name }}">
          </td>
          <td><i class="bi bi-table"></i> {{ cat.name }}</td>
          <td>{{ cat.tipo|capitalize }}</td>
          <td>
            {% if cat.created_at %} 
              {{ cat.created_at.strftime('%Y-%m-%d %H:%M') if cat.created_at.strftime else cat.created_at }} 
            {% else %} 
              ‚Äî 
            {% endif %}
          </td>
          <td>
            <div class="btn-group" role="group">
              <a
                href="{{ url_for('admin.ver_catalogo_unificado', collection_source=cat.tipo == 'spreadsheet' and 'spreadsheets' or 'catalogs', catalog_id=cat._id) }}"
                class="btn btn-sm btn-primary"
                title="Ver"
              >
                <i class="bi bi-eye"></i> Ver
              </a>
              <a
                href="{{ url_for('admin.editar_catalogo_admin', collection_source=cat.tipo == 'spreadsheet' and 'spreadsheets' or 'catalogs', catalog_id=cat._id) }}"
                class="btn btn-sm btn-warning"
                title="Editar"
              >
                <i class="bi bi-pencil"></i> Editar
              </a>
              <button
                type="button"
                class="btn btn-sm btn-danger delete-single-catalog"
                title="Eliminar"
                data-catalog-id="{{ cat._id }}"
                data-collection-source="{{ cat.tipo == 'spreadsheet' and 'spreadsheets' or 'catalogs' }}"
                data-catalog-name="{{ cat.name }}"
              >
                <i class="bi bi-trash"></i> Eliminar
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% if not mis_registros %}
    <div class="alert alert-info mt-3">No tienes cat√°logos/tablas propios.</div>
    {% endif %}
  </div>

  <!-- Controles de paginaci√≥n -->
  {% if total_pages > 1 %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
      <span class="text-muted me-3">
        Mostrando {{ ((page - 1) * per_page) + 1 }} a {{ [page * per_page, total_catalogos] | min }} de {{ total_catalogos }} cat√°logos
      </span>
      <select class="form-select form-select-sm" style="width: auto;" onchange="changePerPage(this.value)">
        <option value="10" {% if per_page == 10 %}selected{% endif %}>10 por p√°gina</option>
        <option value="25" {% if per_page == 25 %}selected{% endif %}>25 por p√°gina</option>
        <option value="50" {% if per_page == 50 %}selected{% endif %}>50 por p√°gina</option>
        <option value="100" {% if per_page == 100 %}selected{% endif %}>100 por p√°gina</option>
      </select>
    </div>
    
    <nav aria-label="Navegaci√≥n de p√°ginas">
      <ul class="pagination pagination-sm mb-0">
        <!-- Bot√≥n Anterior -->
        <li class="page-item {% if not has_prev %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('admin.dashboard_admin', page=prev_page, per_page=per_page, search=search, search_type=search_type) }}" {% if not has_prev %}tabindex="-1" aria-disabled="true"{% endif %}>
            <i class="bi bi-chevron-left"></i> Anterior
          </a>
        </li>
        
        <!-- N√∫meros de p√°gina -->
        {% set start_page = [1, page - 2] | max %}
        {% set end_page = [total_pages, page + 2] | min %}
        
        {% if start_page > 1 %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('admin.dashboard_admin', page=1, per_page=per_page, search=search, search_type=search_type) }}">1</a>
        </li>
        {% if start_page > 2 %}
        <li class="page-item disabled">
          <span class="page-link">...</span>
        </li>
        {% endif %}
        {% endif %}
        
        {% for p in range(start_page, end_page + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('admin.dashboard_admin', page=p, per_page=per_page, search=search, search_type=search_type) }}">{{ p }}</a>
        </li>
        {% endfor %}
        
        {% if end_page < total_pages %}
        {% if end_page < total_pages - 1 %}
        <li class="page-item disabled">
          <span class="page-link">...</span>
        </li>
        {% endif %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('admin.dashboard_admin', page=total_pages, per_page=per_page, search=search, search_type=search_type) }}">{{ total_pages }}</a>
        </li>
        {% endif %}
        
        <!-- Bot√≥n Siguiente -->
        <li class="page-item {% if not has_next %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('admin.dashboard_admin', page=next_page, per_page=per_page, search=search, search_type=search_type) }}" {% if not has_next %}tabindex="-1" aria-disabled="true"{% endif %}>
            Siguiente <i class="bi bi-chevron-right"></i>
          </a>
        </li>
      </ul>
    </nav>
  </div>
  {% endif %}

  <h4 class="mt-4 mb-3">
    <i class="bi bi-clock-history"></i> √öltimos Cat√°logos/Tablas Creados
  </h4>
  <div class="table-responsive">
    <table class="table table-hover align-middle shadow-sm">
      <thead class="table-light">
        <tr>
          <th>Nombre</th>
          <th>Tipo</th>
          <th>Propietario</th>
          <th>Fecha de creaci√≥n</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for tabla in mis_registros[:10] %}
        <tr>
          <td><i class="bi bi-table"></i> {{ tabla.name }}</td>
          <td>{{ tabla.tipo|capitalize }}</td>
          <td>{{ tabla.owner if tabla.owner else '‚Äî' }}</td>
          <td>
            {% if tabla.created_at %} {{ tabla.created_at.strftime('%Y-%m-%d
            %H:%M') if tabla.created_at.strftime else tabla.created_at }} {%
            else %} ‚Äî {% endif %}
          </td>
          <td>
            {% if session.role == 'admin' or tabla.owner == session.username %}
            <a
              href="{{ url_for('admin.ver_catalogo_unificado', collection_source='spreadsheets', catalog_id=tabla._id) }}"
              class="btn btn-sm btn-outline-primary me-1"
              title="Ver"
              ><i class="bi bi-eye"></i
            ></a>
            <form
              action="{{ url_for('main.delete_table', table_id=tabla._id) }}"
              method="post"
              style="display: inline"
            >
              <button
                type="submit"
                class="btn btn-sm btn-outline-danger"
                title="Eliminar"
                onclick="return confirm('¬øSeguro que deseas eliminar esta tabla?');"
              >
                <i class="bi bi-trash"></i>
              </button>
            </form>
            {% else %}
            <span class="text-muted">Sin permisos</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% if not mis_registros %}
    <div class="alert alert-info mt-3">
      No hay tablas/cat√°logos creados a√∫n.
    </div>
    {% endif %}
  </div>
  <div class="row mt-3">
    <div class="col-md-4 mx-auto">
      <a
        href="{{ url_for('auth.logout') }}"
        class="btn btn-outline-danger w-100 py-2 shadow-sm"
      >
        <i class="bi bi-box-arrow-right"></i> Cerrar Sesi√≥n
      </a>
    </div>
  </div>
</div>
{% endblock %} 

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}?v=20250803_SMART_DETECTION_{{ range(1000, 9999) | random }}"></script>

<!-- Modal de confirmaci√≥n para eliminaci√≥n -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteModalLabel">Confirmar Eliminaci√≥n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="deleteModalMessage">¬øEst√° seguro que desea eliminar los cat√°logos seleccionados?</p>
        <div id="deleteModalDetails" class="mt-3"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" id="confirmDelete">Eliminar</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elementos del DOM
    const selectAllCatalogs = document.getElementById('selectAllCatalogs');
    const selectAllHeader = document.getElementById('selectAllHeader');
    const catalogCheckboxes = document.querySelectorAll('.catalog-checkbox');
    const selectedCount = document.getElementById('selectedCount');
    const deleteSelectedCatalogs = document.getElementById('deleteSelectedCatalogs');
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    const deleteModalMessage = document.getElementById('deleteModalMessage');
    const deleteModalDetails = document.getElementById('deleteModalDetails');
    const confirmDelete = document.getElementById('confirmDelete');
    
    // Variables globales
    let selectedCatalogs = [];
    
    // Funci√≥n para actualizar el contador de seleccionados
    function updateSelectedCount() {
        const checkedBoxes = document.querySelectorAll('.catalog-checkbox:checked');
        selectedCount.textContent = `${checkedBoxes.length} seleccionados`;
        deleteSelectedCatalogs.disabled = checkedBoxes.length === 0;
        
        // Actualizar array de cat√°logos seleccionados
        selectedCatalogs = Array.from(checkedBoxes).map(checkbox => ({
            catalog_id: checkbox.dataset.catalogId,
            collection_source: checkbox.dataset.collectionSource,
            catalog_name: checkbox.dataset.catalogName
        }));
    }
    
    // Funci√≥n para manejar "Seleccionar todos"
    function handleSelectAll(checked) {
        catalogCheckboxes.forEach(checkbox => {
            checkbox.checked = checked;
        });
        selectAllCatalogs.checked = checked;
        selectAllHeader.checked = checked;
        updateSelectedCount();
    }
    
    // Event listeners para checkboxes individuales
    catalogCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectedCount();
            
            // Actualizar estado de "Seleccionar todos"
            const allChecked = Array.from(catalogCheckboxes).every(cb => cb.checked);
            const anyChecked = Array.from(catalogCheckboxes).some(cb => cb.checked);
            
            selectAllCatalogs.checked = allChecked;
            selectAllHeader.checked = allChecked;
            selectAllCatalogs.indeterminate = anyChecked && !allChecked;
            selectAllHeader.indeterminate = anyChecked && !allChecked;
        });
    });
    
    // Event listener para "Seleccionar todos" (checkbox principal)
    selectAllCatalogs.addEventListener('change', function() {
        handleSelectAll(this.checked);
    });
    
    // Event listener para "Seleccionar todos" (header)
    selectAllHeader.addEventListener('change', function() {
        handleSelectAll(this.checked);
    });
    
    // Event listener para eliminaci√≥n m√∫ltiple
    deleteSelectedCatalogs.addEventListener('click', function() {
        if (selectedCatalogs.length === 0) {
            alert('No hay cat√°logos seleccionados para eliminar.');
            return;
        }
        
        // Mostrar modal de confirmaci√≥n
        deleteModalMessage.textContent = `¬øEst√° seguro que desea eliminar ${selectedCatalogs.length} cat√°logo(s)?`;
        
        // Mostrar detalles de los cat√°logos a eliminar
        const detailsHtml = selectedCatalogs.map(cat => 
            `<div class="alert alert-warning mb-2">
                <i class="bi bi-exclamation-triangle"></i> 
                <strong>${cat.catalog_name}</strong> (${cat.collection_source})
            </div>`
        ).join('');
        deleteModalDetails.innerHTML = detailsHtml;
        
        deleteModal.show();
    });
    
    // Event listener para eliminaci√≥n individual
    document.querySelectorAll('.delete-single-catalog').forEach(button => {
        button.addEventListener('click', function() {
            const catalogId = this.dataset.catalogId;
            const collectionSource = this.dataset.collectionSource;
            const catalogName = this.dataset.catalogName;
            
            // Configurar para eliminaci√≥n individual
            selectedCatalogs = [{
                catalog_id: catalogId,
                collection_source: collectionSource,
                catalog_name: catalogName
            }];
            
            deleteModalMessage.textContent = `¬øEst√° seguro que desea eliminar el cat√°logo "${catalogName}"?`;
            deleteModalDetails.innerHTML = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> 
                    <strong>${catalogName}</strong> (${collectionSource})
                </div>
            `;
            
            deleteModal.show();
        });
    });
    
    // Event listener para confirmar eliminaci√≥n
    confirmDelete.addEventListener('click', function() {
        if (selectedCatalogs.length === 0) {
            deleteModal.hide();
            return;
        }
        
        // Deshabilitar bot√≥n durante la operaci√≥n
        this.disabled = true;
        this.innerHTML = '<i class="bi bi-hourglass-split"></i> Eliminando...';
        
        // Preparar datos para enviar
        const catalogosData = selectedCatalogs.map(cat => ({
            catalog_id: cat.catalog_id,
            collection_source: cat.collection_source
        }));
        
        // Realizar petici√≥n AJAX
        fetch('{{ url_for("admin.eliminar_catalogos_multiple") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                catalogos: catalogosData
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mostrar mensaje de √©xito
                let message = `Se eliminaron ${data.total_eliminados} cat√°logo(s) correctamente.`;
                if (data.total_errores > 0) {
                    message += ` Errores en ${data.total_errores} cat√°logo(s).`;
                }
                
                // Recargar la p√°gina para mostrar los cambios
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al eliminar los cat√°logos. Por favor, intente nuevamente.');
        })
        .finally(() => {
            // Restaurar bot√≥n
            this.disabled = false;
            this.innerHTML = 'Eliminar';
            deleteModal.hide();
        });
    });
    
    // Inicializar contador
    updateSelectedCount();
});

// Funci√≥n para cambiar elementos por p√°gina
function changePerPage(value) {
    const url = new URL(window.location);
    url.searchParams.set('per_page', value);
    url.searchParams.set('page', '1'); // Volver a la primera p√°gina
    window.location.href = url.toString();
}

// Variables para ordenaci√≥n
let ordenActual = {
    columna: null,
    ascendente: true
};

// Funci√≥n para ordenar tabla de cat√°logos
function ordenarTablaCatalogs(columna) {
    console.log(`üîÑ Ordenando cat√°logos por columna ${columna}`);
    
    const tabla = document.getElementById('catalogsTable');
    const tbody = tabla.querySelector('tbody');
    const filas = Array.from(tbody.querySelectorAll('tr'));
    
    // Si es la misma columna, cambiar direcci√≥n; si no, ascendente
    if (ordenActual.columna === columna) {
        ordenActual.ascendente = !ordenActual.ascendente;
    } else {
        ordenActual.columna = columna;
        ordenActual.ascendente = true;
    }
    
    // Ordenar las filas
    filas.sort((a, b) => {
        const celdaA = a.cells[columna]?.textContent?.trim() || '';
        const celdaB = b.cells[columna]?.textContent?.trim() || '';
        
        let resultado;
        
        // Para fecha de creaci√≥n (columna 3), intentar parsear como fecha
        if (columna === 3) {
            const fechaA = new Date(celdaA);
            const fechaB = new Date(celdaB);
            if (!isNaN(fechaA) && !isNaN(fechaB)) {
                resultado = fechaA - fechaB;
            } else {
                resultado = celdaA.localeCompare(celdaB, 'es', { sensitivity: 'base' });
            }
        } else {
            // Para texto normal
            resultado = celdaA.localeCompare(celdaB, 'es', { sensitivity: 'base' });
        }
        
        return ordenActual.ascendente ? resultado : -resultado;
    });
    
    // Reemplazar las filas en el DOM
    filas.forEach(fila => tbody.appendChild(fila));
    
    // Actualizar iconos de ordenamiento
    actualizarIconosOrdenamientoCatalogs();
}

// Funci√≥n para actualizar los iconos de ordenamiento
function actualizarIconosOrdenamientoCatalogs() {
    const headers = document.querySelectorAll('#catalogsTable .sortable');
    headers.forEach((header) => {
        const columna = parseInt(header.dataset.column);
        const icon = header.querySelector('.sort-icon');
        
        if (columna === ordenActual.columna) {
            icon.className = ordenActual.ascendente ? 
                'bi bi-chevron-up sort-icon' : 
                'bi bi-chevron-down sort-icon';
            icon.style.opacity = '1';
        } else {
            icon.className = 'bi bi-chevron-expand sort-icon';
            icon.style.opacity = '0.5';
        }
    });
}

// Agregar event listeners para ordenaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    // Event listeners para ordenaci√≥n de cat√°logos
    document.querySelectorAll('#catalogsTable .sortable').forEach(header => {
        header.addEventListener('click', function() {
            const columna = parseInt(this.dataset.column);
            ordenarTablaCatalogs(columna);
        });
    });
});
</script>
{% endblock %}
