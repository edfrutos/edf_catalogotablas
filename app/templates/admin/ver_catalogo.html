{% extends "admin/base.html" %}
<!-- eslint-disable -->

{% block title %}Detalle del Catálogo{% endblock %}

{% block content %}
<div class="container mt-4">
        <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="mb-0">Detalles del Catálogo/Tabla</h2>
            <a href="{{ return_url or url_for('admin.dashboard_admin') }}" class="btn btn-secondary">&larr; Volver</a>
            </div>
            <div class="card-body">
            <h5>Información general</h5>
            <table class="table table-bordered mb-4">
                <tr><th>Nombre</th><td>{{ catalog.name }}</td></tr>
                <tr><th>Propietario</th><td>{{ catalog.owner_name or catalog.created_by or 'No disponible' }}</td></tr>
                <tr><th>Fecha de creación</th><td>{{ catalog.created_at or 'Desconocida' }}</td></tr>
                <tr><th>Número de filas</th><td>{{ catalog.rows|length if catalog.rows else 0 }}</td></tr>
                <tr><th>Encabezados</th><td>{{ catalog.headers|join(', ') }}</td></tr>
                </table>

            <div class="d-flex justify-content-end mb-3">
                <a href="{{ url_for('catalogs.add_row', catalog_id=catalog._id) }}" class="btn btn-success">
                    <i class="bi bi-plus-circle"></i> Añadir fila
                </a>
            </div>

            <h5>Filas del catálogo</h5>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th style="width: 60px;">#</th>
                            {% for header in catalog.headers %}
                                <th>
                                    {% if header == 'Multimedia' %}
                                        <i class="fas fa-video"></i> {{ header }}
                                    {% elif header in ['Documentos', 'Documentación'] or header.startswith('Documentación') %}
                                        <i class="fas fa-file-alt"></i> {{ header }}
                                    {% else %}
                                        {{ header }}
                                    {% endif %}
                                </th>
                            {% endfor %}
                            <th style="width: 120px;">Imágenes</th>
                            <th style="width: 160px;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if catalog.rows and catalog.rows|length > 0 %}
                            {% for row in catalog.rows %}
                                <tr>
                                    <td class="fw-bold text-primary">{{ loop.index }}</td>
                                    {% for header in catalog.headers %}
                                        <td>
                                            {% if header.startswith('Documentación') %}
                                                {% set header_key = header %}
                                            {% else %}
                                                {% set header_key = header + '_' + (loop.index0)|string if header in ['Documentos', 'Documentación'] else header %}
                                            {% endif %}
                                            <!-- Debug: {{ header_key }} -->
                                            {% if header == 'Multimedia' %}
                                                <!-- Columna Multimedia -->
                                                {% if row[header] %}
                                                    {% if row[header] is iterable and row[header] is not string %}
                                                        {% set multimedia_data = row[header][0] if row[header] else '' %}
                                                    {% else %}
                                                        {% set multimedia_data = row[header] %}
                                                    {% endif %}
                                                    {% if multimedia_data and multimedia_data.startswith('/admin/s3/') %}
                                                        {% set multimedia_data = multimedia_data %}
                                                    {% endif %}
                                                    {% if multimedia_data is string and (multimedia_data.startswith('http') or multimedia_data.startswith('/admin/s3/') or multimedia_data.startswith('/s3/')) %}
                                                        <!-- URL externa o S3 -->
                                                        {% if multimedia_data.startswith('https://edf-catalogo-tablas.s3.eu-central-1.amazonaws.com/') or multimedia_data.startswith('/admin/s3/') or multimedia_data.startswith('/s3/') %}
                                                            <!-- Archivo en S3 -->
                                                            <div class="multimedia-preview">
                                                                {% if multimedia_data is string and multimedia_data.lower().endswith(('.jpg', '.jpeg', '.png', '.gif', '.webp')) %}
                                                                    <img src="{{ multimedia_data }}" 
                                                                         alt="Multimedia" 
                                                                         class="img-thumbnail multimedia-thumbnail"
                                                                         onclick="showMultimediaModal('{{ multimedia_data }}', '{{ multimedia_data.split('/')[-1] }}')">
                                                                {% elif multimedia_data is string and multimedia_data.lower().endswith(('.mp4', '.avi', '.mov', '.wmv')) %}
                                                                    <div class="multimedia-thumbnail-container" 
                                                                         onclick="if (typeof showPyWebViewVideo !== 'undefined') { showPyWebViewVideo('{{ multimedia_data }}', '{{ multimedia_data.split('/')[-1] }}'); } else { showMultimediaModal('{{ multimedia_data }}', '{{ multimedia_data.split('/')[-1] }}'); }"
                                                                         style="cursor: pointer; position: relative; display: inline-block;">
                                                                        <video class="multimedia-thumbnail" 
                                                                               style="pointer-events: none;">
                                                                            <source src="{{ multimedia_data }}" type="video/mp4">
                                                                            Tu navegador no soporta el elemento video.
                                                                        </video>
                                                                        <div class="play-overlay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                                                                            <i class="fas fa-play text-white" style="font-size: 12px;"></i>
                                                                        </div>
                                                                    </div>
                                                                {% elif multimedia_data is string and multimedia_data.lower().endswith(('.mp3', '.wav', '.ogg')) %}
                                                                    <div class="multimedia-thumbnail-container" 
                                                                         data-multimedia-url="{{ multimedia_data }}"
                                                                         data-multimedia-title="{{ multimedia_data.split('/')[-1] }}"
                                                                         style="cursor: pointer; position: relative; display: inline-block;"
                                                                         onclick="showMultimediaModal(this.dataset.multimediaUrl, this.dataset.multimediaTitle)">
                                                                        <audio class="multimedia-thumbnail" 
                                                                               style="pointer-events: none;">
                                                                            <source src="{{ multimedia_data }}" type="audio/mpeg">
                                                                            Tu navegador no soporta el elemento audio.
                                                                        </audio>
                                                                        <div class="play-overlay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                                                                            <i class="fas fa-music text-white" style="font-size: 12px;"></i>
                                                                        </div>
                                                                    </div>
                                                                {% else %}
                                                                    <a href="{{ multimedia_data }}" 
                                                                       target="_blank" class="btn btn-sm btn-outline-secondary">
                                                                        <i class="fas fa-download"></i> Descargar
                                                                    </a>
                                                                {% endif %}
                                                            </div>
                                                        {% else %}
                                                            <!-- URL externa -->
                                                            <a href="{{ multimedia_data }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                                <i class="fas fa-external-link-alt"></i> Ver Multimedia
                                                            </a>
                                                        {% endif %}
                                                    {% else %}
                                                        <!-- Archivo local -->
                                                        <div class="multimedia-preview">
                                                            {% if multimedia_data is string and multimedia_data.lower().endswith(('.jpg', '.jpeg', '.png', '.gif', '.webp')) %}
                                                                                                <img src="{{ url_for('uploaded_images.uploaded_images', filename=multimedia_data) }}" 
                                     alt="Multimedia" 
                                     class="img-thumbnail multimedia-thumbnail"
                                     onclick="showMultimediaModal('{{ url_for('uploaded_images.uploaded_images', filename=multimedia_data) }}', '{{ multimedia_data }}')">
                                                            {% elif multimedia_data is string and multimedia_data.lower().endswith(('.mp4', '.avi', '.mov', '.wmv', '.webm')) %}
                                                                <div class="multimedia-thumbnail-container" 
                                                                     onclick="if (typeof showPyWebViewVideo !== 'undefined') { showPyWebViewVideo('{{ url_for('uploaded_images.uploaded_images', filename=multimedia_data) }}', '{{ multimedia_data }}'); } else { showMultimediaModal('{{ url_for('uploaded_images.uploaded_images', filename=multimedia_data) }}', '{{ multimedia_data }}'); }"
                                                                     style="cursor: pointer; position: relative; display: inline-block;">
                                                                    <video class="multimedia-thumbnail" 
                                                                           style="pointer-events: none;">
                                                                        <source src="{{ url_for('uploaded_images.uploaded_images', filename=multimedia_data) }}" type="video/mp4">
                                                                        Tu navegador no soporta el elemento video.
                                                                    </video>
                                                                    <div class="play-overlay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                                                                        <i class="fas fa-play text-white" style="font-size: 12px;"></i>
                                                                    </div>
                                                                </div>
                                                            {% elif multimedia_data is string and multimedia_data.lower().endswith(('.mp3', '.wav', '.ogg')) %}
                                                                <div class="multimedia-thumbnail-container" 
                                                                     onclick='showMultimediaModal("{{ url_for("uploaded_images.uploaded_images", filename=multimedia_data) }}", "{{ multimedia_data }}")'
                                                                     style="cursor: pointer; position: relative; display: inline-block;">
                                                                    <audio class="multimedia-thumbnail" 
                                                                           style="pointer-events: none;">
                                                                        <source src="{{ url_for('uploaded_images.uploaded_images', filename=multimedia_data) }}" type="audio/mpeg">
                                                                        Tu navegador no soporta el elemento audio.
                                                                    </audio>
                                                                    <div class="play-overlay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                                                                        <i class="fas fa-music text-white" style="font-size: 12px;"></i>
                                                                    </div>
                                                                </div>
                                                            {% else %}
                                                                <a href="{{ url_for('uploaded_images.uploaded_images', filename=multimedia_data) }}" 
                                                                   target="_blank" class="btn btn-sm btn-outline-secondary">
                                                                    <i class="fas fa-download"></i> Descargar
                                                                </a>
                                                            {% endif %}
                                                        </div>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            {% elif header in ['Documentos', 'Documentación'] or header.startswith('Documentación') %}
                                                <!-- Columna Documentos/Documentación -->
                                                <!-- Debug: row[header_key] = {{ row[header_key] }} -->
                                                {% if row[header_key] %}
                                                    {% set documento_data = row[header_key] %}
                                                    
                                                    <!-- Manejar múltiples documentos -->
                                                    {% if documento_data is iterable and documento_data is not string %}
                                                        <!-- Array de documentos -->
                                                        <div class="documentos-list">
                                                            {% for doc in documento_data %}
                                                                {% if doc %}
                                                                    {% set clean_doc = doc %}
                                                                    {% if doc.startswith('/admin/s3/') %}
                                                                        {% set clean_doc = doc %}
                                                                    {% endif %}
                                                                    {% if clean_doc is string and (clean_doc.startswith('http') or clean_doc.startswith('/admin/s3/') or clean_doc.startswith('/s3/')) %}
                                                                        <!-- URL externa o S3 -->
                                                                        {% if clean_doc.startswith('https://edf-catalogo-tablas.s3.eu-central-1.amazonaws.com/') or clean_doc.startswith('/admin/s3/') or clean_doc.startswith('/s3/') %}
                                                                            <!-- Archivo en S3 -->
                                                                            {% if clean_doc.lower().endswith('.pdf') %}
                                                                                <a href="#" 
                                                                                   class="btn btn-sm btn-outline-danger mb-1"
                                                                                   onclick='event.preventDefault(); if (typeof showPyWebViewDocument !== "undefined") { showPyWebViewDocument("{{ clean_doc }}", "{{ clean_doc.split("/")[-1] }}"); } else { showDocumentModal("{{ clean_doc }}", "{{ clean_doc.split("/")[-1] }}"); }'>
                                                                                    <i class="fas fa-file-pdf"></i> Ver PDF
                                                                                </a>
                                                                            {% elif clean_doc.lower().endswith('.md') %}
                                                                                <a href="#" 
                                                                                   class="btn btn-sm btn-outline-info mb-1"
                                                                                   onclick='event.preventDefault(); if (typeof showPyWebViewDocument !== "undefined") { showPyWebViewDocument("{{ clean_doc }}", "{{ clean_doc.split("/")[-1] }}"); } else { showDocumentModal("{{ clean_doc }}", "{{ clean_doc.split("/")[-1] }}"); }'>
                                                                                    <i class="fas fa-file-code"></i> Ver Markdown
                                                                                </a>
                                                                            {% else %}
                                                                                <a href="{{ clean_doc }}" 
                                                                                   target="_blank" class="btn btn-sm btn-outline-dark mb-1">
                                                                                    <i class="fas fa-download"></i> Descargar
                                                                                </a>
                                                                            {% endif %}
                                                                        {% else %}
                                                                            <!-- URL externa -->
                                                                            <a href="#" 
                                                                               class="btn btn-sm btn-outline-info mb-1"
                                                                               onclick='event.preventDefault(); if (typeof showPyWebViewDocument !== "undefined") { showPyWebViewDocument("{{ clean_doc }}", "{{ clean_doc.split("/")[-1] }}"); } else { showDocumentModal("{{ clean_doc }}", "{{ clean_doc.split("/")[-1] }}"); }'>
                                                                                <i class="fas fa-external-link-alt"></i> Ver Documento
                                                                            </a>
                                                                        {% endif %}
                                                                    {% else %}
                                                                        <!-- Archivo local (legacy) -->
                                                                        {% if doc.lower().endswith('.pdf') %}
                                                                            <a href="#" 
                                                                               class="btn btn-sm btn-outline-danger mb-1"
                                                                               onclick="event.preventDefault(); if (typeof showPyWebViewDocument !== 'undefined') { showPyWebViewDocument('{{ url_for('uploaded_images.uploaded_images', filename=doc) }}', '{{ doc }}'); } else { showDocumentModal('{{ url_for('uploaded_images.uploaded_images', filename=doc) }}', '{{ doc }}'); }"
                                                                                <i class="fas fa-file-pdf"></i> Ver PDF
                                                                            </a>
                                                                        {% elif doc.lower().endswith('.md') %}
                                                                            <a href="#" 
                                                                               class="btn btn-sm btn-outline-info mb-1"
                                                                               onclick="event.preventDefault(); if (typeof showPyWebViewDocument !== 'undefined') { showPyWebViewDocument('{{ url_for('uploaded_images.uploaded_images', filename=doc) }}', '{{ doc }}'); } else { showDocumentModal('{{ url_for('uploaded_images.uploaded_images', filename=doc) }}', '{{ doc }}'); }"
                                                                                <i class="fas fa-file-code"></i> Ver Markdown
                                                                            </a>
                                                                        {% else %}
                                                                            <a href="{{ url_for('uploaded_images.uploaded_images', filename=doc) }}" 
                                                                               target="_blank" class="btn btn-sm btn-outline-dark mb-1">
                                                                                <i class="fas fa-download"></i> Descargar
                                                                            </a>
                                                                        {% endif %}
                                                                    {% endif %}
                                                                {% endif %}
                                                            {% endfor %}
                                                        </div>
                                                    
                                                    <!-- Documento único (fallback para compatibilidad) -->
                                                    {% elif documento_data is string and (documento_data.startswith('http') or documento_data.startswith('/admin/s3/') or documento_data.startswith('/s3/')) %}
                                                        <!-- URL externa o S3 -->
                                                        {% if documento_data.startswith('https://edf-catalogo-tablas.s3.eu-central-1.amazonaws.com/') or documento_data.startswith('/admin/s3/') or documento_data.startswith('/s3/') %}
                                                            <!-- Archivo en S3 -->
                                                            <div class="documento-preview">
                                                                {% if documento_data is string and documento_data.lower().endswith('.pdf') %}
                                                                    <a href="#" 
                                                                       class="btn btn-sm btn-outline-danger"
                                                                       onclick="
                                                                           event.preventDefault(); 
                                                                           if (typeof showPyWebViewDocument !== 'undefined') { 
                                                                               showPyWebViewDocument('{{ '/admin/s3/' + documento_data.split('/')[-1] if documento_data.startswith('https://edf-catalogo-tablas.s3.eu-central-1.amazonaws.com/') else url_for('uploaded_images.uploaded_images', filename=documento_data) }}', '{{ documento_data }}'); 
                                                                           } else { 
                                                                               showDocumentModal('{{ '/admin/s3/' + documento_data.split('/')[-1] if documento_data.startswith('https://edf-catalogo-tablas.s3.eu-central-1.amazonaws.com/') else url_for('uploaded_images.uploaded_images', filename=documento_data) }}', '{{ documento_data }}'); 
                                                                           }
                                                                       ">
                                                                        <i class="fas fa-file-pdf"></i> Ver PDF
                                                                    </a>
                                                                {% elif documento_data is string and documento_data.lower().endswith(('.doc', '.docx')) %}
                                                                    <a href="#" 
                                                                       class="btn btn-sm btn-outline-primary"
                                                                       onclick="
                                                                           event.preventDefault(); 
                                                                           if (typeof showPyWebViewDocument !== 'undefined') { 
                                                                               showPyWebViewDocument('{{ '/admin/s3/' + documento_data.split('/')[-1] if documento_data.startswith('https://edf-catalogo-tablas.s3.eu-central-1.amazonaws.com/') else url_for('uploaded_images.uploaded_images', filename=documento_data) }}', '{{ documento_data }}'); 
                                                                           } else { 
                                                                               showDocumentModal('{{ '/admin/s3/' + documento_data.split('/')[-1] if documento_data.startswith('https://edf-catalogo-tablas.s3.eu-central-1.amazonaws.com/') else url_for('uploaded_images.uploaded_images', filename=documento_data) }}', '{{ documento_data }}'); 
                                                                           }
                                                                       ">
                                                                        <i class="fas fa-file-word"></i> Ver Word
                                                                    </a>
                                                                {% elif documento_data is string and documento_data.lower().endswith(('.xls', '.xlsx')) %}
                                                                    <a href="#" 
                                                                       class="btn btn-sm btn-outline-success"
                                                                       onclick="
                                                                           event.preventDefault(); 
                                                                           if (typeof showPyWebViewDocument !== 'undefined') { 
                                                                               showPyWebViewDocument('{{ '/admin/s3/' + documento_data.split('/')[-1] if documento_data.startswith('https://edf-catalogo-tablas.s3.eu-central-1.amazonaws.com/') else url_for('uploaded_images.uploaded_images', filename=documento_data) }}', '{{ documento_data }}'); 
                                                                           } else { 
                                                                               showDocumentModal('{{ '/admin/s3/' + documento_data.split('/')[-1] if documento_data.startswith('https://edf-catalogo-tablas.s3.eu-central-1.amazonaws.com/') else url_for('uploaded_images.uploaded_images', filename=documento_data) }}', '{{ documento_data }}'); 
                                                                           }
                                                                       ">
                                                                        <i class="fas fa-file-excel"></i> Ver Excel
                                                                    </a>
                                                                {% elif documento_data is string and documento_data.lower().endswith('.txt') %}
                                                                    <a href="#" 
                                                                       class="btn btn-sm btn-outline-secondary"
                                                                       onclick="
                                                                           event.preventDefault(); 
                                                                           if (typeof showPyWebViewDocument !== 'undefined') { 
                                                                               showPyWebViewDocument('{{ '/admin/s3/' + documento_data.split('/')[-1] if documento_data.startswith('https://edf-catalogo-tablas.s3.eu-central-1.amazonaws.com/') else url_for('uploaded_images.uploaded_images', filename=documento_data) }}', '{{ documento_data }}'); 
                                                                           } else { 
                                                                               showDocumentModal('{{ '/admin/s3/' + documento_data.split('/')[-1] if documento_data.startswith('https://edf-catalogo-tablas.s3.eu-central-1.amazonaws.com/') else url_for('uploaded_images.uploaded_images', filename=documento_data) }}', '{{ documento_data }}'); 
                                                                           }
                                                                       ">
                                                                        <i class="fas fa-file-alt"></i> Ver Texto
                                                                    </a>
                                                                {% elif documento_data is string and documento_data.lower().endswith('.md') %}
                                                                    <a href="#" 
                                                                       class="btn btn-sm btn-outline-secondary"
                                                                       onclick="
                                                                           console.log('[DEBUG] Click en Markdown:', '{{ documento_data }}'); 
                                                                           event.preventDefault(); 
                                                                           if (typeof showPyWebViewDocument !== 'undefined') { 
                                                                               showPyWebViewDocument('{{ '/admin/s3/' + documento_data.split('/')[-1] if documento_data.startswith('https://edf-catalogo-tablas.s3.eu-central-1.amazonaws.com/') else url_for('uploaded_images.uploaded_images', filename=documento_data) }}', '{{ documento_data }}'); 
                                                                           } else { 
                                                                               showDocumentModal('{{ '/admin/s3/' + documento_data.split('/')[-1] if documento_data.startswith('https://edf-catalogo-tablas.s3.eu-central-1.amazonaws.com/') else url_for('uploaded_images.uploaded_images', filename=documento_data) }}', '{{ documento_data }}'); 
                                                                           }
                                                                       ">
                                                                        <i class="fas fa-file-alt"></i> Ver Markdown
                                                                    </a>
                                                                {% else %}
                                                                    <a href="{{ documento_data }}" 
                                                                       target="_blank" class="btn btn-sm btn-outline-dark">
                                                                        <i class="fas fa-download"></i> Descargar
                                                                    </a>
                                                                {% endif %}
                                                            </div>
                                                        {% else %}
                                                            <!-- URL externa -->
                                                            <a href="#" 
                                                               class="btn btn-sm btn-outline-info"
                                                               onclick="
                                                                   event.preventDefault(); 
                                                                   if (typeof showPyWebViewDocument !== 'undefined') { 
                                                                       showPyWebViewDocument('{{ documento_data }}', '{{ documento_data.split('/')[-1] }}'); 
                                                                   } else { 
                                                                       showDocumentModal('{{ documento_data }}', '{{ documento_data.split('/')[-1] }}'); 
                                                                   }
                                                               ">
                                                                <i class="fas fa-external-link-alt"></i> Ver Documento
                                                            </a>
                                                        {% endif %}
                                                    {% else %}
                                                        <!-- Archivo local (legacy) -->
                                                        <div class="documento-preview">
                                                            <a href="{{ '/admin/s3/' + documento_data.split('/')[-1] if documento_data.startswith('https://edf-catalogo-tablas.s3.eu-central-1.amazonaws.com/') else url_for('uploaded_images.uploaded_images', filename=documento_data) }}" 
                                                               target="_blank" class="btn btn-sm btn-outline-dark">
                                                                <i class="fas fa-download"></i> Descargar
                                                            </a>
                                                        </div>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            {% else %}
                                                {{ row[header_key] or '-' }}
                                            {% endif %}
                                        </td>
                                    {% endfor %}
                                    <td>
                                        <!-- Usar imágenes procesadas por el backend -->
                                        {% if row is mapping and row.get('_imagenes') and row._imagenes %}
                                            {% for img_url in row._imagenes %}
                                                {% if loop.index <= 3 %}
                                                    <img src="{{ img_url }}" 
                                                         alt="Imagen {{ loop.index }}" 
                                                         class="img-thumbnail catalog-preview-img" 
                                                         style="width: 60px; height: 60px; object-fit: cover; margin-right: 4px; cursor: pointer; border-radius: 4px; border: 1px solid #ccc;"
                                                         onclick='showImageModal("{{ img_url }}", "Imagen {{ loop.index }}")'
                                                         onerror="if(typeof handleImageError === 'function') { handleImageError(this); } else { this.src='{{ url_for('static', filename='img/image-error.svg') }}'; }"
                                                         loading="lazy">
                                                {% endif %}
                                            {% endfor %}
                                            {% if row._imagenes|length > 3 %}
                                                <small class="text-muted">+{{ row._imagenes|length - 3 }}</small>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group-vertical btn-group-sm d-flex flex-column flex-md-row" role="group">
                                            <a href="{{ url_for('admin.editar_fila_admin', collection_source=catalog.collection_source, catalog_id=catalog._id, row_index=loop.index0) }}" 
                                               class="btn btn-warning btn-sm mb-1 mb-md-0 me-md-1" 
                                               title="Editar fila">
                                                <i class="bi bi-pencil-square"></i> 
                                                <span class="d-none d-sm-inline">Editar</span>
                                            </a>
                                            {% if session.get('role') == 'admin' or catalog.owner == session.get('username') or catalog.owner_name == session.get('username') or catalog.created_by == session.get('username') %}
                                            <form method="POST" action="{{ url_for('catalogs.delete_row', catalog_id=catalog._id, row_index=loop.index0) }}" 
                                                  style="display:inline;" 
                                                  onsubmit="return confirm('¿Seguro que quieres eliminar esta fila?');">
                                                <button type="submit" class="btn btn-danger btn-sm" title="Eliminar fila">
                                                    <i class="bi bi-trash"></i> 
                                                    <span class="d-none d-sm-inline">Eliminar</span>
                                                </button>
                                            </form>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="{{ catalog.headers|length + 2 }}" class="text-center text-muted">Sin datos</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal for image preview -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg image-modal">
    <div class="modal-content image-modal-content">
      <div class="modal-header image-modal-header">
        <h5 class="modal-title" id="imageModalLabel">
          <i class="bi bi-image"></i> Vista Previa de Imagen
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body image-modal-body">
        <div class="modal-image-container">
          <div class="spinner-border text-primary image-loading-spinner" role="status" style="display: none;">
            <span class="visually-hidden">Cargando imagen...</span>
          </div>
          <img src="/static/img/image-placeholder.png" id="modalImage" class="modal-image" alt="imagen del catálogo"
               onload="hideImageLoadingSpinner()" onerror="if(typeof handleImageError === 'function') { handleImageError(this); } else { this.src='{{ url_for('static', filename='img/image-error.svg') }}'; }">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> Cerrar
        </button>
        <button type="button" class="btn btn-primary" onclick='downloadImage()'>
          <i class="fas fa-download"></i> Descargar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for multimedia preview -->
<div class="modal fade" id="multimediaModal" tabindex="-1" aria-labelledby="multimediaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="multimediaModalLabel">
          <i class="fas fa-video"></i> Vista Previa de Multimedia
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <div id="multimediaContent">
          <!-- El contenido multimedia se cargará aquí -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> Cerrar
        </button>
        <button type="button" class="btn btn-primary" onclick='downloadMultimedia()'>
          <i class="fas fa-download"></i> Descargar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for document preview -->
<div class="modal fade" id="documentModal" tabindex="-1" aria-labelledby="documentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="documentModalLabel">
          <i class="fas fa-file-alt"></i> Vista Previa de Documento
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="documentContent">
          <!-- El contenido del documento se cargará aquí -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> Cerrar
        </button>
        <button type="button" class="btn btn-primary" onclick='downloadDocument()'>
          <i class="fas fa-download"></i> Descargar
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block head %}
{{ super() }}
<style>
    .image-container {
        position: relative;
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        overflow: hidden;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
    }
    
    /* Estilos para multimedia y documentos */
    .multimedia-thumbnail {
        max-width: 100px;
        max-height: 60px;
        cursor: pointer;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }
    
    .documento-preview {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Estilos para modales */
    .image-modal {
        max-width: 90vw;
    }
    
    .image-modal-content {
        background-color: rgba(0, 0, 0, 0.9);
        border: none;
    }
    
    .image-modal-header {
        background-color: rgba(0, 0, 0, 0.8);
        border-bottom: 1px solid #333;
        color: white;
    }
    
    .image-modal-body {
        padding: 0;
        background-color: rgba(0, 0, 0, 0.9);
    }
    
    .modal-image-container {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 400px;
    }
    
    .modal-image {
        max-width: 100%;
        max-height: 80vh;
        object-fit: contain;
    }
    
    .image-loading-spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    
    /* Estilos para botones de documentos */
    .btn-outline-danger {
        border-color: #dc3545;
        color: #dc3545;
    }
    
    .btn-outline-danger:hover {
        background-color: #dc3545;
        border-color: #dc3545;
        color: white;
    }
    
    .btn-outline-primary {
        border-color: #0d6efd;
        color: #0d6efd;
    }
    
    .btn-outline-primary:hover {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: white;
    }
    
    .btn-outline-success {
        border-color: #198754;
        color: #198754;
    }
    
    .btn-outline-success:hover {
        background-color: #198754;
        border-color: #198754;
        color: white;
    }
    
    .btn-outline-secondary {
        border-color: #6c757d;
        color: #6c757d;
    }
    
    .btn-outline-secondary:hover {
        background-color: #6c757d;
        border-color: #6c757d;
        color: white;
    }
    
    .btn-outline-info {
        border-color: #0dcaf0;
        color: #0dcaf0;
    }
    
    .btn-outline-info:hover {
        background-color: #0dcaf0;
        border-color: #0dcaf0;
        color: white;
    }
    
    .btn-outline-dark {
        border-color: #212529;
        color: #212529;
    }
    
    .btn-outline-dark:hover {
        background-color: #212529;
        border-color: #212529;
        color: white;
    }
    
    .catalog-image {
        opacity: 0;
        transition: opacity 0.3s ease;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .modal-image-container {
        position: relative;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    #imagenModalSrc {
        opacity: 0;
        transition: opacity 0.3s ease;
        max-width: 100%;
        max-height: 70vh;
        width: auto;
        height: auto;
        object-fit: contain;
    }
    
    .modal-xl {
        max-width: 95vw;
    }
    
    .modal-image-container {
        max-height: 75vh;
        overflow: hidden;
    }
    
    /* Estilos para previsualización de documentos */
    .markdown-preview {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
    }
    
    .markdown-preview pre {
        background-color: #ffffff;
        border: 1px solid #e9ecef;
        border-radius: 3px;
        padding: 10px;
        margin: 0;
        font-size: 14px;
        line-height: 1.4;
    }
    
    /* Estilos para iframe de PDF */
    iframe {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Mejoras de responsividad para la tabla */
    .table-responsive {
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .table th {
        background-color: #f8f9fa;
        border-top: none;
        font-weight: 600;
        white-space: nowrap;
        min-width: 120px;
    }
    
    .table td {
        vertical-align: middle;
        word-wrap: break-word;
        max-width: 200px;
    }
    
    /* Columna de acciones - mantener ancho fijo */
    .table td:last-child {
        width: 140px;
        min-width: 140px;
        max-width: 140px;
    }
    
    /* Columna de imágenes - mantener ancho fijo */
    .table td:nth-last-child(2) {
        width: 120px;
        min-width: 120px;
        max-width: 120px;
    }
    
    /* Botones responsivos */
    .btn-group-vertical .btn {
        white-space: nowrap;
    }
    
    @media (max-width: 768px) {
        .table td {
            max-width: 150px;
            font-size: 0.9rem;
        }
        
        .btn-group-vertical .btn {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<!-- Incluir funciones de modal unificadas -->
<script src="{{ url_for('static', filename='js/modal-functions-UNIFIED.js') }}?v={{ range(1, 10000) | random }}&t={{ range(1, 100000) | random }}&ts={{ range(1, 999999) | random }}"></script>
{% endblock %}