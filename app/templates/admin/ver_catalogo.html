{% extends "base.html" %}

{% block title %}Ver Catálogo{% endblock %}

{% block content %}
<div class="container mt-4">
    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
        <a href="{{ url_for('admin.dashboard_admin') }}" class="btn btn-secondary">&larr; Volver al panel de administración</a>
    {% elif catalog %}
        <h2>Detalles del Catálogo/Tabla</h2>
        <a href="{{ request.referrer or url_for('admin.dashboard_admin') }}" class="btn btn-secondary mb-3">&larr; Volver</a>
        
        <div class="card mb-4">
            <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Información general</h5>
                    {% if catalog.collection_source %}
                        <span class="badge bg-{{ 'primary' if catalog.collection_source == 'catalogs' else 'info' }}">{{ catalog.collection_source }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <table class="table table-bordered mb-0">
                    <tr><th style="width: 200px;">Nombre</th><td>{{ catalog.name }}</td></tr>
                    <tr><th>Propietario</th><td>{{ catalog.created_by or catalog.owner or catalog.email or '—' }}</td></tr>
                    <tr><th>Fecha de creación</th><td>{{ catalog.created_at_formatted }}</td></tr>
                    <tr><th>Número de filas</th><td>{{ catalog.row_count }}</td></tr>
                    <tr><th>Encabezados</th><td>{% if catalog.headers %}{{ catalog.headers|join(', ') }}{% else %}—{% endif %}</td></tr>
                </table>
            </div>
        </div>
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">Filas del catálogo</h5>
            </div>
            <div class="card-body">
                {% if catalog.data and catalog.headers %}
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    {% for header in catalog.headers %}
                                        <th>{{ header }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in catalog.data %}
                                    <tr>
                                        {% for header in catalog.headers %}
                                            <td>
                                                {% if header in ['images', 'imagenes'] and row[header] is defined and row[header] %}
                                                    {% set images = row[header] if row[header] is iterable and row[header] is not string else [row[header]] %}
                                                    <div class="d-flex flex-wrap gap-2">
                                                        {% for img in images %}
                                                            {% if img and img|length > 5 %}
                                                                {% set img_url = row.imagen_urls[loop.index0] if row.imagen_urls is defined and row.imagen_urls|length > loop.index0 else img %}
                                                                <a href="#" onclick="mostrarImagenModal('{{ img_url }}'); return false;" class="position-relative">
                                                                    <div class="image-container" data-img-url="{{ img_url }}">
                                                                        <div class="spinner-border text-primary spinner-border-sm position-absolute top-50 start-50 translate-middle" role="status">
                                                                            <span class="visually-hidden">Cargando...</span>
                                                                        </div>
                                                                        <img src="{{ img_url }}" alt="Imagen" class="img-thumbnail catalog-image" 
                                                                             style="max-width: 80px; max-height: 80px; object-fit: cover;"
                                                                             onload="this.style.opacity='1'; this.previousElementSibling.style.display='none';"
                                                                             onerror="this.src='/static/img/image-error.png'; this.style.opacity='1'; this.previousElementSibling.style.display='none';"
                                                                             loading="lazy">
                                                                    </div>
                                                                </a>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                {% elif header in ['image', 'imagen'] and row[header] is defined and row[header] %}
                                                    <a href="#" onclick="mostrarImagenModal('{{ row[header] }}'); return false;" class="position-relative">
                                                        <div class="image-container" data-img-url="{{ row[header] }}">
                                                            <div class="spinner-border text-primary spinner-border-sm position-absolute top-50 start-50 translate-middle" role="status">
                                                                <span class="visually-hidden">Cargando...</span>
                                                            </div>
                                                            <img src="{{ row[header] }}" alt="Imagen" class="img-thumbnail catalog-image" 
                                                                 style="max-width: 80px; max-height: 80px; object-fit: cover;"
                                                                 onload="this.style.opacity='1'; this.previousElementSibling.style.display='none';"
                                                                 onerror="this.src='/static/img/image-error.png'; this.style.opacity='1'; this.previousElementSibling.style.display='none';"
                                                                 loading="lazy">
                                                        </div>
                                                    </a>
                                                {% else %}
                                                    {{ row[header] if row[header] is defined else '' }}
                                                {% endif %}
                                            </td>
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info">Este catálogo no tiene datos o no tiene encabezados definidos.</div>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block head %}
{{ super() }}
<style>
    .image-container {
        position: relative;
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        overflow: hidden;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
    }
    
    .catalog-image {
        opacity: 0;
        transition: opacity 0.3s ease;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .modal-image-container {
        position: relative;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    #imagenModalSrc {
        opacity: 0;
        transition: opacity 0.3s ease;
        max-width: 100%;
        max-height: 80vh;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
function mostrarImagenModal(imagenUrl) {
    // Crear el modal si no existe
    if (!document.getElementById('imagenModal')) {
        const modalHTML = `
        <div class="modal fade" id="imagenModal" tabindex="-1" aria-labelledby="imagenModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="imagenModalLabel">Visualizar Imagen</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <div class="modal-image-container">
                            <div class="spinner-border text-primary position-absolute" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <img id="imagenModalSrc" src="" alt="Imagen" 
                                 onload="this.style.opacity='1'; this.previousElementSibling.style.display='none';"
                                 onerror="this.src='/static/img/image-error.png'; this.style.opacity='1'; this.previousElementSibling.style.display='none';">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
        `;
        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHTML;
        document.body.appendChild(modalContainer.firstElementChild);
    }
    
    // Restablecer el spinner y la opacidad antes de cargar la nueva imagen
    const spinner = document.querySelector('#imagenModal .spinner-border');
    const modalImg = document.getElementById('imagenModalSrc');
    if (spinner) spinner.style.display = 'block';
    if (modalImg) {
        modalImg.style.opacity = '0';
        modalImg.src = imagenUrl;
    }
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('imagenModal'));
    modal.show();
}

// Función para manejar errores de carga de imágenes
document.addEventListener('DOMContentLoaded', function() {
    // Crear una imagen de error por defecto si no existe
    const errorImgPath = '/static/img/image-error.png';
    fetch(errorImgPath)
        .catch(() => {
            // Si la imagen de error no existe, crear un canvas con un icono de error
            const canvas = document.createElement('canvas');
            canvas.width = 80;
            canvas.height = 80;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#f8d7da';
            ctx.fillRect(0, 0, 80, 80);
            ctx.font = '40px Arial';
            ctx.fillStyle = '#721c24';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('!', 40, 40);
            
            // Convertir el canvas a una imagen base64
            const dataUrl = canvas.toDataURL('image/png');
            
            // Reemplazar todas las referencias a la imagen de error
            document.querySelectorAll('img[onerror]').forEach(img => {
                img.onerror = function() {
                    this.src = dataUrl;
                    this.style.opacity = '1';
                    const spinner = this.previousElementSibling;
                    if (spinner) spinner.style.display = 'none';
                };
            });
        });
});
</script>
{% endblock %}