{% extends "admin/base.html" %}

{% block title %}Detalle del Catálogo{% endblock %}

{% block content %}
<div class="container mt-4">
        <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="mb-0">Detalles del Catálogo/Tabla</h2>
            <a href="{{ return_url or url_for('admin.dashboard_admin') }}" class="btn btn-secondary">&larr; Volver</a>
            </div>
            <div class="card-body">
            <h5>Información general</h5>
            <table class="table table-bordered mb-4">
                <tr><th>Nombre</th><td>{{ catalog.name }}</td></tr>
                <tr><th>Propietario</th><td>{{ catalog.owner_name or catalog.created_by or 'No disponible' }}</td></tr>
                <tr><th>Fecha de creación</th><td>{{ catalog.created_at or 'Desconocida' }}</td></tr>
                <tr><th>Número de filas</th><td>{{ catalog.rows|length if catalog.rows else 0 }}</td></tr>
                <tr><th>Encabezados</th><td>{{ catalog.headers|join(', ') }}</td></tr>
                </table>

            <div class="d-flex justify-content-end mb-3">
                <a href="{{ url_for('catalogs.add_row', catalog_id=catalog._id) }}" class="btn btn-success">
                    <i class="bi bi-plus-circle"></i> Añadir fila
                </a>
            </div>

            <h5>Filas del catálogo</h5>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            {% for header in catalog.headers %}
                                <th>{{ header }}</th>
                            {% endfor %}
                            <th>Imágenes</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if catalog.rows and catalog.rows|length > 0 %}
                            {% for row in catalog.rows %}
                                <tr>
                                    {% for header in catalog.headers %}
                                        <td>{{ row[header] }}</td>
                                    {% endfor %}
                                    <td>
                                        {# Unificación de campo de imágenes: acepta 'imagenes' o 'images' #}
                                        {% set imgs = row["imagenes"] if row is mapping and "imagenes" in row else row["images"] if row is mapping and "images" in row else None %}
                                        {% if imgs %}
                                            <div class="d-flex flex-wrap gap-2">
                                                {% for img in imgs %}
                                                    {% if img.startswith('http') %}
                                                        {# Imagen de S3 (URL completa) #}
                                                        <img src="{{ img }}" alt="img" class="img-thumbnail" style="height:60px;margin-right:4px;cursor:pointer;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                                                        <span style="display:none; color:red; font-size:10px;">Error</span>
                                                    {% else %}
                                                        {# Imagen local o S3 (solo nombre de archivo) - intentar S3 primero, luego local #}
                                                        <img src="{{ get_image_url(img, use_s3=true) }}" alt="img" class="img-thumbnail" style="height:60px;margin-right:4px;cursor:pointer;" onerror="this.onerror=null; this.src='{{ url_for('static', filename='img/image-placeholder.png') }}'; this.nextElementSibling.style.display='inline';">
                                                        <span style="display:none; color:red; font-size:10px;">Error</span>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        {% else %}-{% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('catalogs.edit_row', catalog_id=catalog._id, row_index=loop.index0) }}" class="btn btn-warning">
                                            <i class="bi bi-pencil-square"></i> Editar
                                        </a>
                                        {% if session.get('role') == 'admin' or catalog.owner == session.get('username') or catalog.owner_name == session.get('username') or catalog.created_by == session.get('username') %}
                                        <form method="POST" action="{{ url_for('catalogs.delete_row', catalog_id=catalog._id, row_index=loop.index0) }}" style="display:inline;" onsubmit="return confirm('¿Seguro que quieres eliminar esta fila?');">
                                            <button type="submit" class="btn btn-danger btn-sm">
                                                <i class="bi bi-trash"></i> Eliminar
                                            </button>
                                        </form>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="{{ catalog.headers|length + 2 }}" class="text-center text-muted">Sin datos</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{# El bloque content termina aquí. El bloque head comienza después del bloque content. #}
{% block head %}
{{ super() }}
<style>
    .image-container {
        position: relative;
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        overflow: hidden;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
    }
    
    .catalog-image {
        opacity: 0;
        transition: opacity 0.3s ease;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .modal-image-container {
        position: relative;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    #imagenModalSrc {
        opacity: 0;
        transition: opacity 0.3s ease;
        max-width: 100%;
        max-height: 70vh;
        width: auto;
        height: auto;
        object-fit: contain;
    }
    
    .modal-xl {
        max-width: 95vw;
    }
    
    .modal-image-container {
        max-height: 75vh;
        overflow: hidden;
    }
</style>
{% endblock %}

{# El bloque head termina aquí. El bloque scripts comienza después del bloque head. #}
{% block scripts %}
<script>
function mostrarImagenModal(imagenUrl) {
    // Crear el modal si no existe
    if (!document.getElementById('imagenModal')) {
        const modalHTML = `
        <div class="modal fade" id="imagenModal" tabindex="-1" aria-labelledby="imagenModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="imagenModalLabel">Visualizar Imagen</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <div class="modal-image-container">
                            <div class="spinner-border text-primary position-absolute" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <img id="imagenModalSrc" src="" alt="Imagen" 
                                 onload="this.style.opacity='1'; this.previousElementSibling.style.display='none';"
                                 onerror="this.src='/static/img/image-error.svg'; this.style.opacity='1'; this.previousElementSibling.style.display='none';">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
        `;
        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHTML;
        document.body.appendChild(modalContainer.firstElementChild);
    }
    
    // Restablecer el spinner y la opacidad antes de cargar la nueva imagen
    const spinner = document.querySelector('#imagenModal .spinner-border');
    const modalImg = document.getElementById('imagenModalSrc');
    if (spinner) spinner.style.display = 'block';
    if (modalImg) {
        modalImg.style.opacity = '0';
        modalImg.src = imagenUrl;
    }
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('imagenModal'));
    modal.show();
}

// Función para manejar errores de carga de imágenes
document.addEventListener('DOMContentLoaded', function() {
    // Crear una imagen de error por defecto si no existe
    const errorImgPath = "/static/img/image-error.svg";
    fetch(errorImgPath)
        .catch(() => {
            // Si la imagen de error no existe, crear un canvas con un icono de error
            const canvas = document.createElement('canvas');
            canvas.width = 80;
            canvas.height = 80;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#f8d7da';
            ctx.fillRect(0, 0, 80, 80);
            ctx.font = '40px Arial';
            ctx.fillStyle = '#721c24';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('!', 40, 40);
            
            // Convertir el canvas a una imagen base64
            const dataUrl = canvas.toDataURL('image/png');
            
            // Reemplazar todas las referencias a la imagen de error
            document.querySelectorAll('img[onerror]').forEach(img => {
                img.onerror = function() {
                    this.src = dataUrl;
                    this.style.opacity = '1';
                    const spinner = this.previousElementSibling;
                    if (spinner) spinner.style.display = 'none';
                };
            });
        });
});
</script>
{% endblock %}