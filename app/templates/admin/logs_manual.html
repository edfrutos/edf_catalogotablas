{% extends 'admin/base.html' %}
{% block content %}
<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Gestión de Logs</h2>
    <div>
      <button class="btn btn-outline-primary" id="refreshLogsList" onclick="actualizarListaLogs()" title="Actualizar lista de logs">
        <i class="bi bi-arrow-clockwise"></i> Actualizar Lista
      </button>
      <div class="form-check form-switch d-inline-block ms-3">
        <input class="form-check-input" type="checkbox" id="autoRefreshSwitch" checked>
        <label class="form-check-label" for="autoRefreshSwitch">
          Actualización automática (30s)
        </label>
      </div>
    </div>
  </div>
  
  <form id="log-select-form" class="mb-3">
    <label for="logfile" class="form-label">Selecciona un archivo de log:</label>
    <div class="input-group">
      <select id="logfile" name="logfile" class="form-select" onchange="actualizarLogSeleccionado()">
        <option value="">-- Selecciona un log --</option>
        <!-- Las opciones se cargarán dinámicamente -->
      </select>
      <span class="input-group-text" id="logFileCount">Cargando...</span>
    </div>
  </form>
  
  <div class="card mb-3">
    <div class="card-header">
      <h5 class="mb-0">Filtros de visualización</h5>
    </div>
    <div class="card-body">
      <div class="row mb-3">
        <div class="col-md-3">
          <label for="linesCount" class="form-label">Mostrar últimas líneas:</label>
          <div class="input-group">
            <input type="number" id="linesCount" class="form-control" value="50" min="1">
            <button class="btn btn-primary" onclick="aplicarFiltros()">Aplicar</button>
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label">Filtrar por fecha:</label>
          <div class="input-group">
            <input type="date" id="dateFrom" class="form-control" placeholder="Desde">
            <span class="input-group-text">a</span>
            <input type="date" id="dateTo" class="form-control" placeholder="Hasta">
            <button class="btn btn-outline-secondary" type="button" onclick="aplicarFiltroFechas()">
              <i class="bi bi-funnel"></i> Filtrar
            </button>
          </div>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <div class="btn-group w-100" role="group">
            <button class="btn btn-primary" onclick="aplicarFiltrosUnificados()" title="Aplicar todos los filtros">
              <i class="bi bi-funnel"></i> Aplicar Filtros
            </button>
            <button class="btn btn-success" onclick="descargarLog()" title="Descargar log">
              <i class="bi bi-download"></i>
            </button>
            <button class="btn btn-danger" onclick="mostrarModalTruncar()" title="Truncar log">
              <i class="bi bi-scissors"></i> Truncar
            </button>
            <button class="btn btn-info" onclick="verTamano()" title="Ver tamaño y rotaciones">
              <i class="bi bi-info-circle"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <div class="input-group">
            <input type="text" id="keyword" class="form-control" placeholder="Buscar por palabra clave...">
            <button class="btn btn-outline-secondary" type="button" onclick="buscarLogs()">
              <i class="bi bi-search"> Buscar</i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="filter-info" class="alert alert-info d-none"></div>
  
  <div class="card mb-3">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Contenido del Log</h5>
      <div>
        <button class="btn btn-sm btn-outline-light" id="copyLogsBtn" onclick="copyLogsToClipboard()" title="Copiar al portapapeles">
          <i class="bi bi-clipboard"></i> Copiar al portapapeles
        </button>
        <button class="btn btn-sm btn-outline-light" onclick="descargarLog()" title="Descargar log">
          <i class="bi bi-download"></i> Descargar
        </button>
      </div>
    </div>
    <div class="card-body p-0">
      <pre id="log-output" style="background:#222;color:#0f0;padding:1em;height:70vh;overflow:auto;margin:0"></pre>
    </div>
  </div>
</div>

<!-- Modal para truncar log -->
<div class="modal fade" id="modalTruncar" tabindex="-1" aria-labelledby="modalTruncarLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="formTruncar" onsubmit="truncarLog(event)">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="modalTruncarLabel">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Truncar Archivo de Log
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>¡Atención!</strong> Esta acción eliminará permanentemente parte del contenido del archivo de log.
          </div>
          
          <div class="alert alert-info">
            <i class="bi bi-file-text me-2"></i>
            <strong>Archivo seleccionado:</strong> <span id="logFileName">Ninguno</span>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="card h-100">
                <div class="card-header">
                  <h6 class="mb-0"><i class="bi bi-list-ol me-2"></i>Por Número de Líneas</h6>
                </div>
                <div class="card-body">
                  <label for="numLineas" class="form-label">Mantener las últimas N líneas:</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="numLineas" name="numLineas" min="10" max="10000" placeholder="Ej: 100">
                    <span class="input-group-text">líneas</span>
                  </div>
                  <div class="form-text">Se eliminarán todas las líneas excepto las últimas N.</div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card h-100">
                <div class="card-header">
                  <h6 class="mb-0"><i class="bi bi-calendar me-2"></i>Por Fecha</h6>
                </div>
                <div class="card-body">
                  <label for="fechaCorte" class="form-label">Mantener desde fecha:</label>
                  <input type="date" class="form-control" id="fechaCorte" name="fechaCorte">
                  <div class="form-text">Se mantendrán solo las líneas desde esta fecha en adelante (se eliminarán las anteriores).</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="mt-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="confirmTruncate" required>
              <label class="form-check-label" for="confirmTruncate">
                Confirmo que entiendo que esta acción es irreversible
              </label>
            </div>
            <div class="mt-2">
              <button type="button" class="btn btn-outline-info btn-sm" onclick="mostrarVistaPrevia()">
                <i class="bi bi-eye me-1"></i>Vista previa del resultado
              </button>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-2"></i>Cancelar
          </button>
          <button type="submit" class="btn btn-danger" id="btnTruncar" disabled>
            <i class="bi bi-scissors me-2"></i>Truncar Archivo
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
let logSeleccionado = '';
let currentFilters = {
  lines: 50,
  dateFrom: null,
  dateTo: null,
  keyword: ''
};

// Formatear fecha para mostrarla en el input date
function formatDateForInput(date) {
  if (!date) return '';
  return new Date(date).toISOString().split('T')[0];
}

// Actualizar la información del filtro aplicado
function updateFilterInfo() {
  const infoEl = document.getElementById('filter-info');
  let info = [];
  
  if (currentFilters.lines) {
    info.push(`Líneas: ${currentFilters.lines}`);
  }
  
  if (currentFilters.dateFrom || currentFilters.dateTo) {
    const from = currentFilters.dateFrom || 'inicio';
    const to = currentFilters.dateTo || 'hoy';
    info.push(`Fecha: ${from} a ${to}`);
  }
  
  if (currentFilters.keyword) {
    info.push(`Búsqueda: "${currentFilters.keyword}"`);
  }
  
  if (logSeleccionado) {
    info.push(`Archivo: ${logSeleccionado}`);
  }
  
  if (info.length > 0) {
    infoEl.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <div><strong>Filtros activos:</strong> ${info.join(' | ')}</div>
        <button class="btn btn-sm btn-outline-danger" onclick="resetFilters()">
          <i class="bi bi-x-circle"></i> Limpiar filtros
        </button>
      </div>
    `;
    infoEl.classList.remove('d-none');
  } else {
    infoEl.classList.add('d-none');
  }
}

// Aplicar filtros unificados
function aplicarFiltros() {
  const lines = parseInt(document.getElementById('linesCount').value) || 50;
  currentFilters.lines = lines > 0 ? lines : null;
  
  aplicarFiltrosUnificados();
}

// Aplicar filtro por fechas
function aplicarFiltroFechas() {
  const dateFrom = document.getElementById('dateFrom').value;
  const dateTo = document.getElementById('dateTo').value;
  
  currentFilters.dateFrom = dateFrom || null;
  currentFilters.dateTo = dateTo || null;
  
  aplicarFiltrosUnificados();
}

// Función unificada para aplicar todos los filtros
function aplicarFiltrosUnificados() {
  if (!getLogParam()) return;
  
  const params = new URLSearchParams();
  
  // Parámetro de líneas
  if (currentFilters.lines) {
    params.append('n', currentFilters.lines);
  }
  
  // Parámetros de fecha
  if (currentFilters.dateFrom) {
    params.append('date_from', currentFilters.dateFrom);
  }
  if (currentFilters.dateTo) {
    params.append('date_to', currentFilters.dateTo);
  }
  
  // Parámetro de archivo de log
  if (logSeleccionado) {
    params.append('log_file', logSeleccionado);
  }
  
  // Parámetro de búsqueda por palabra clave
  if (currentFilters.keyword) {
    params.append('keyword', currentFilters.keyword);
  }
  
  const url = `/admin/logs/tail?${params.toString()}`;
  
  fetch(url)
    .then(r => r.json())
    .then(d => {
      const output = document.getElementById('log-output');
      output.textContent = d.logs.join('');
      
      // Actualizar información de filtros
      if (d.total_lines !== undefined) {
        const info = `Mostrando ${d.filtered_lines} de ${d.total_lines} líneas`;
        if (d.filtered_lines === 0) {
          output.textContent = 'No se encontraron registros que coincidan con los filtros actuales.';
        }
      }
      
      // Hacer scroll al final
      output.scrollTop = output.scrollHeight;
      updateFilterInfo();
    })
    .catch(error => {
      console.error('Error al cargar los logs:', error);
      document.getElementById('log-output').textContent = `Error al cargar los registros: ${error.message}`;
    });
}

// Resetear todos los filtros
function resetFilters() {
  currentFilters = {
    lines: 50,
    dateFrom: null,
    dateTo: null,
    keyword: ''
  };
  
  document.getElementById('linesCount').value = '50';
  document.getElementById('dateFrom').value = '';
  document.getElementById('dateTo').value = '';
  document.getElementById('keyword').value = '';
  
  // Usar el sistema unificado de filtros
  aplicarFiltrosUnificados();
}
function actualizarLogSeleccionado() {
  logSeleccionado = document.getElementById('logfile').value;
  
  // Si hay un log seleccionado, aplicar los filtros actuales
  if (logSeleccionado) {
    aplicarFiltrosUnificados();
  }
}
function getLogParam() {
  if (!logSeleccionado) {
    alert('Selecciona un archivo de log.');
    return null;
  }
  return `?log_file=${encodeURIComponent(logSeleccionado)}`;
}
function verUltimos(n) {
  if (!getLogParam()) return;
  
  // Actualizar el filtro de líneas
  currentFilters.lines = n;
  
  // Usar el sistema unificado de filtros
  aplicarFiltrosUnificados();
}
function buscarLogs() {
  if (!getLogParam()) return;
  
  const keyword = document.getElementById('keyword').value;
  currentFilters.keyword = keyword || '';
  
  // Usar el sistema unificado de filtros
  aplicarFiltrosUnificados();
}
function descargarLog() {
  if (!getLogParam()) return;
  window.location = `/admin/logs/download${getLogParam()}`;
}
function mostrarModalTruncar() {
  if (!getLogParam()) return;
  
  // Mostrar el nombre del archivo seleccionado
  const logFileName = document.getElementById('logFileName');
  logFileName.textContent = logSeleccionado || 'Ninguno';
  
  var modal = new bootstrap.Modal(document.getElementById('modalTruncar'));
  modal.show();
}
function truncarLog(event) {
  event.preventDefault();
  if (!getLogParam()) return;
  
  const numLineas = document.getElementById('numLineas').value;
  const fechaCorte = document.getElementById('fechaCorte').value;
  const confirmTruncate = document.getElementById('confirmTruncate').checked;
  
  if (!confirmTruncate) {
    mostrarMensajeTemporal('Debes confirmar que entiendes que la acción es irreversible', 'warning');
    return;
  }
  
  if (!numLineas && !fechaCorte) {
    mostrarMensajeTemporal('Debes indicar número de líneas o fecha de corte', 'warning');
    return;
  }
  
  // Validación adicional para evitar truncados accidentales
  if (numLineas && parseInt(numLineas) < 10) {
    const confirmacion = confirm(`¿Estás seguro de que quieres mantener solo ${numLineas} líneas? Esto podría eliminar la mayor parte del archivo.`);
    if (!confirmacion) {
      return;
    }
  }
  
  if (fechaCorte) {
    const fechaSeleccionada = new Date(fechaCorte);
    const hoy = new Date();
    const diffTime = Math.abs(hoy - fechaSeleccionada);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays > 7) {
      const confirmacion = confirm(`¿Estás seguro de que quieres mantener solo las líneas desde ${fechaCorte}? Esto podría eliminar ${diffDays} días de logs.`);
      if (!confirmacion) {
        return;
      }
    }
  }
  
  // Mostrar estado de carga
  const btnTruncar = document.getElementById('btnTruncar');
  const originalText = btnTruncar.innerHTML;
  btnTruncar.disabled = true;
  btnTruncar.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Procesando...';
  
  const formData = new FormData();
  formData.append('log_file', logSeleccionado);
  if (numLineas) formData.append('lines', numLineas);
  if (fechaCorte) formData.append('date', fechaCorte);
  
  fetch('/admin/logs/clear' + getLogParam(), {method:'POST', body:formData})
    .then(r => {
      if (!r.ok) {
        throw new Error(`Error ${r.status}: ${r.statusText}`);
      }
      return r.json();
    })
    .then(data => {
      // Cerrar modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('modalTruncar'));
      modal.hide();
      
      // Mostrar mensaje de éxito con detalles
      let mensaje = data.status;
      if (data.lines_removed !== undefined) {
        mensaje += ` (${data.lines_removed} líneas eliminadas, ${data.lines_kept} mantenidas)`;
      }
      mostrarMensajeTemporal(mensaje, 'success');
      
      // Limpiar formulario
      document.getElementById('formTruncar').reset();
      document.getElementById('btnTruncar').disabled = true;
      
      // Recargar logs con el sistema unificado
      aplicarFiltrosUnificados();
    })
    .catch(error => {
      console.error('Error al truncar log:', error);
      mostrarMensajeTemporal(`Error al truncar el archivo: ${error.message}`, 'danger');
    })
    .finally(() => {
      // Restaurar botón
      btnTruncar.disabled = false;
      btnTruncar.innerHTML = originalText;
    });
}
function verTamano() {
  if (!getLogParam()) return;
  fetch(`/admin/logs/size${getLogParam()}`)
    .then(r => r.json())
    .then(d => {
      document.getElementById('log-output').textContent = `Tamaño: ${d.size} bytes\nRotaciones: ${d.backups}`;
    });
}

function copyLogsToClipboard() {
  const logOutput = document.getElementById('log-output');
  const textToCopy = logOutput.textContent;
  
  navigator.clipboard.writeText(textToCopy)
    .then(() => {
      // Mostrar mensaje de éxito
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-success alert-dismissible fade show';
      alertDiv.innerHTML = `
        <strong>¡Copiado!</strong> El contenido del log ha sido copiado al portapapeles.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
      `;
      
      // Insertar alerta antes del div de filtros
      const filterInfo = document.getElementById('filter-info');
      filterInfo.parentNode.insertBefore(alertDiv, filterInfo);
      
      // Auto-cerrar después de 3 segundos
      setTimeout(() => {
        alertDiv.remove();
      }, 3000);
    })
    .catch(err => {
      console.error('Error al copiar al portapapeles:', err);
      alert('No se pudo copiar al portapapeles. Error: ' + err);
    });
}

// Variables para la actualización automática
let autoRefreshInterval = null;
let logFilesList = [];

// Función para actualizar la lista de logs
function actualizarListaLogs() {
  const refreshBtn = document.getElementById('refreshLogsList');
  const logFileCount = document.getElementById('logFileCount');
  
  // Mostrar estado de carga
  refreshBtn.disabled = true;
  refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Actualizando...';
  logFileCount.textContent = 'Actualizando...';
  
  fetch('/admin/logs/list')
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        logFilesList = data.files;
        actualizarSelectLogs(data.files);
        logFileCount.textContent = `${data.files.length} archivos`;
        
        // Mostrar mensaje de éxito temporal
        mostrarMensajeTemporal('Lista de logs actualizada correctamente', 'success');
      } else {
        throw new Error('Error en la respuesta del servidor');
      }
    })
    .catch(error => {
      console.error('Error al actualizar lista de logs:', error);
      logFileCount.textContent = 'Error al cargar';
      mostrarMensajeTemporal('Error al actualizar la lista de logs', 'danger');
    })
    .finally(() => {
      // Restaurar botón
      refreshBtn.disabled = false;
      refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Actualizar Lista';
    });
}

// Función para actualizar el select con los archivos de log
function actualizarSelectLogs(files) {
  const select = document.getElementById('logfile');
  const selectedValue = select.value; // Preservar selección actual
  
  // Limpiar opciones existentes
  select.innerHTML = '<option value="">-- Selecciona un log --</option>';
  
  // Añadir nuevas opciones
  files.forEach(file => {
    const option = document.createElement('option');
    option.value = file;
    option.textContent = file;
    select.appendChild(option);
  });
  
  // Restaurar selección si el archivo aún existe
  if (selectedValue && files.includes(selectedValue)) {
    select.value = selectedValue;
  }
}

// Función para mostrar mensajes temporales
function mostrarMensajeTemporal(mensaje, tipo) {
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${tipo} alert-dismissible fade show`;
  alertDiv.innerHTML = `
    ${mensaje}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
  `;
  
  // Insertar al inicio del contenedor
  const container = document.querySelector('.container');
  container.insertBefore(alertDiv, container.firstChild);
  
  // Auto-cerrar después de 3 segundos
  setTimeout(() => {
    if (alertDiv.parentNode) {
      alertDiv.remove();
    }
  }, 3000);
}

// Función para configurar la actualización automática
function configurarActualizacionAutomatica() {
  const autoRefreshSwitch = document.getElementById('autoRefreshSwitch');
  
  function iniciarActualizacionAutomatica() {
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
    }
    
    autoRefreshInterval = setInterval(() => {
      if (autoRefreshSwitch.checked) {
        actualizarListaLogs();
      }
    }, 30000); // 30 segundos
  }
  
  function detenerActualizacionAutomatica() {
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
      autoRefreshInterval = null;
    }
  }
  
  // Event listener para el switch
  autoRefreshSwitch.addEventListener('change', function() {
    if (this.checked) {
      iniciarActualizacionAutomatica();
      mostrarMensajeTemporal('Actualización automática activada (cada 30 segundos)', 'info');
    } else {
      detenerActualizacionAutomatica();
      mostrarMensajeTemporal('Actualización automática desactivada', 'warning');
    }
  });
  
  // Iniciar automáticamente si está activado
  if (autoRefreshSwitch.checked) {
    iniciarActualizacionAutomatica();
  }
}

// Añadir estilos CSS para la animación de rotación
const style = document.createElement('style');
style.textContent = `
  .spin {
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
`;
document.head.appendChild(style);

// Modificar la función window.onload existente
window.onload = function() {
  // Cargar lista inicial de logs
  actualizarListaLogs();
  
  // Configurar actualización automática
  configurarActualizacionAutomatica();
  
  // Establecer fecha por defecto (hoy) en el campo de fecha hasta
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('dateTo').value = today;
  
  // Cargar los logs iniciales después de un breve delay
  setTimeout(() => {
    if (logSeleccionado) {
      verUltimos(50);
    }
  }, 1000);
  
  updateFilterInfo();
  
  // Permitir usar Enter en el campo de búsqueda
  document.getElementById('keyword').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      aplicarFiltrosUnificados();
    }
  });
  
  // Aplicar filtros automáticamente cuando cambien los campos de fecha
  document.getElementById('dateFrom').addEventListener('change', function() {
    currentFilters.dateFrom = this.value || null;
  });
  
  document.getElementById('dateTo').addEventListener('change', function() {
    currentFilters.dateTo = this.value || null;
  });
  
  // Aplicar filtros automáticamente cuando cambie el número de líneas
  document.getElementById('linesCount').addEventListener('change', function() {
    currentFilters.lines = parseInt(this.value) || 50;
  });
  
  // Validación del modal de truncar
  document.getElementById('confirmTruncate').addEventListener('change', function() {
    const btnTruncar = document.getElementById('btnTruncar');
    btnTruncar.disabled = !this.checked;
  });
  
  // Limpiar formulario cuando se abra el modal
  document.getElementById('modalTruncar').addEventListener('show.bs.modal', function() {
    document.getElementById('formTruncar').reset();
    document.getElementById('btnTruncar').disabled = true;
  });
  
  // Función para mostrar vista previa del truncado
  window.mostrarVistaPrevia = function() {
    const numLineas = document.getElementById('numLineas').value;
    const fechaCorte = document.getElementById('fechaCorte').value;
    
    if (!numLineas && !fechaCorte) {
      mostrarMensajeTemporal('Debes indicar número de líneas o fecha de corte para ver la vista previa', 'warning');
      return;
    }
    
    // Crear un modal de vista previa
    const previewModal = document.createElement('div');
    previewModal.className = 'modal fade';
    previewModal.id = 'previewModal';
    previewModal.innerHTML = `
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-info text-white">
            <h5 class="modal-title">
              <i class="bi bi-eye me-2"></i>Vista Previa del Truncado
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="previewContent">
              <div class="text-center">
                <div class="spinner-border" role="status">
                  <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2">Calculando vista previa...</p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(previewModal);
    const modal = new bootstrap.Modal(previewModal);
    modal.show();
    
    // Simular la vista previa (en una implementación real, esto haría una llamada al backend)
    setTimeout(() => {
      const previewContent = document.getElementById('previewContent');
      let previewText = '';
      
      if (numLineas) {
        previewText = `
          <div class="alert alert-info">
            <strong>Truncado por líneas:</strong> Se mantendrán las últimas ${numLineas} líneas del archivo.
          </div>
          <p><strong>Resultado esperado:</strong></p>
          <ul>
            <li>Líneas a mantener: ${numLineas}</li>
            <li>Líneas a eliminar: Todas las anteriores</li>
            <li>Archivo resultante: Solo las últimas ${numLineas} líneas</li>
          </ul>
        `;
      } else if (fechaCorte) {
        previewText = `
          <div class="alert alert-info">
            <strong>Truncado por fecha:</strong> Se mantendrán las líneas desde ${fechaCorte} en adelante.
          </div>
          <p><strong>Resultado esperado:</strong></p>
          <ul>
            <li>Fecha de corte: ${fechaCorte}</li>
            <li>Líneas a mantener: Todas desde ${fechaCorte} hasta hoy</li>
            <li>Líneas a eliminar: Todas las anteriores a ${fechaCorte}</li>
          </ul>
        `;
      }
      
      previewContent.innerHTML = previewText;
    }, 1000);
    
    // Limpiar el modal cuando se cierre
    previewModal.addEventListener('hidden.bs.modal', function() {
      document.body.removeChild(previewModal);
    });
  };
};

// Limpiar interval al salir de la página
window.addEventListener('beforeunload', function() {
  if (autoRefreshInterval) {
    clearInterval(autoRefreshInterval);
  }
});
</script>
{% endblock %}