{% extends "admin/base.html" %} {% block title %}Herramientas y Scripts{%
endblock %} {% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
          <i class="bi bi-tools me-2"></i>Herramientas y Scripts
        </h1>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary" onclick="refreshScripts()">
            <i class="bi bi-arrow-clockwise"></i> Actualizar
          </button>
          <a
            href="{{ url_for('admin.list_drive_backups') }}"
            class="btn btn-outline-secondary"
          >
            <i class="bi bi-cloud"></i> Google Drive
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Barra de búsqueda -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="input-group">
            <span class="input-group-text">
              <i class="bi bi-search"></i>
            </span>
            <input
              type="text"
              class="form-control"
              id="script-search"
              placeholder="Buscar herramientas y scripts..."
            />
            <button
              class="btn btn-outline-secondary"
              type="button"
              onclick="clearSearch()"
            >
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Contenido principal -->
  <div class="row">
    <!-- Menú lateral -->
    <div class="col-md-3">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-list me-2"></i>Categorías</h5>
        </div>
        <div class="card-body p-0">
          <div
            class="list-group list-group-flush"
            id="category-menu"
            role="tablist"
          >
            <!-- Se llena dinámicamente -->
          </div>
        </div>
      </div>
    </div>

    <!-- Contenido de scripts -->
    <div class="col-md-9">
      <div id="scripts-content" class="tab-content">
        <!-- Se llena dinámicamente -->
      </div>
    </div>
  </div>
</div>

<!-- Modal de ejecución -->
<div class="modal fade" id="executionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="executionModalTitle">
          <i class="bi bi-play-circle me-2"></i>Ejecutando Script
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <div id="executionProgress" class="text-center">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Ejecutando...</span>
          </div>
          <p class="mb-0">Ejecutando script...</p>
        </div>
        <div id="executionResult" style="display: none">
          <div class="mb-3">
            <h6>Resultado:</h6>
            <div id="executionStatus" class="alert"></div>
          </div>
          <div class="mb-3">
            <h6>Salida estándar:</h6>
            <pre id="executionStdout" class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto; white-space: pre-wrap;"></pre>
          </div>
          <div class="mb-3">
            <h6>Errores:</h6>
            <pre id="executionStderr" class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto; white-space: pre-wrap;"></pre>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de contenido del script -->
<div
  class="modal fade"
  id="scriptContentModal"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="scriptContentModalTitle">
          <i class="bi bi-file-code me-2"></i>Contenido del Script
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <pre
          id="scriptContent"
          class="bg-light p-3 rounded"
          style="max-height: 500px; overflow-y: auto"
        ></pre>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  let scriptsData = [];

  // Cargar scripts al iniciar
  document.addEventListener("DOMContentLoaded", function () {
    // Pequeño retraso para asegurar que Bootstrap esté listo
    setTimeout(() => {
      loadScripts();
    }, 100);
  });

  // Función para cargar scripts
  async function loadScripts() {
    try {
      const response = await fetch("/admin/tools/api/scripts_metadata", {
        credentials: "same-origin",
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      scriptsData = await response.json();
      renderScripts();
    } catch (error) {
      console.error("Error cargando scripts:", error);
      showNotification(
        "Error",
        "No se pudieron cargar las herramientas",
        "error"
      );
    }
  }

  // Función para renderizar scripts
  function renderScripts() {
    const categoryMenu = document.getElementById("category-menu");
    const scriptsContent = document.getElementById("scripts-content");

    // Limpiar contenido
    categoryMenu.innerHTML = "";
    scriptsContent.innerHTML = "";

    // Crear menú de categorías
    scriptsData.forEach((category, index) => {
      const menuItem = document.createElement("a");
      menuItem.href = `#cat-${index}`;
      menuItem.id = `cat-${index}-tab`;
      menuItem.className = `list-group-item list-group-item-action ${index === 0 ? "active" : ""}`;
      menuItem.setAttribute("data-bs-toggle", "list");
      menuItem.setAttribute("role", "tab");
      menuItem.setAttribute("aria-selected", index === 0 ? "true" : "false");
      menuItem.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <span>${category.categoria}</span>
                <span class="badge bg-primary rounded-pill">${category.scripts.length}</span>
            </div>
        `;
      categoryMenu.appendChild(menuItem);

      // Crear contenido de categoría
      const categoryContent = document.createElement("div");
      categoryContent.className = `tab-pane fade ${index === 0 ? "show active" : ""}`;
      categoryContent.id = `cat-${index}`;
      categoryContent.setAttribute("role", "tabpanel");
      categoryContent.setAttribute("aria-labelledby", `cat-${index}-tab`);

      const categoryHeader = document.createElement("div");
      categoryHeader.className = "card mb-4";
      categoryHeader.innerHTML = `
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="bi bi-folder me-2"></i>${category.categoria}
                </h4>
            </div>
        `;

      const scriptsList = document.createElement("div");
      scriptsList.className = "list-group list-group-flush";

      category.scripts.forEach((script) => {
        const scriptItem = document.createElement("div");
        scriptItem.className =
          "list-group-item d-flex justify-content-between align-items-start";
        scriptItem.innerHTML = `
                <div class="ms-2 me-auto">
                    <div class="fw-bold">
                        <i class="bi bi-${script.tipo === "python" ? "file-code" : "terminal"} me-2"></i>
                        ${script.nombre}
                    </div>
                    <div class="text-muted small">${script.descripcion}</div>
                    <div class="mt-1">
                        <span class="badge bg-secondary me-1">${script.tipo}</span>
                        <span class="badge bg-${script.executable ? "success" : "warning"}">${script.executable ? "Ejecutable" : "Solo lectura"}</span>
                    </div>
                </div>
                <div class="btn-group" role="group">
                    ${
                      script.executable
                        ? `
                        <button type="button" class="btn btn-primary btn-sm" onclick="executeScript('${script.path}')">
                            <i class="bi bi-play"></i> Ejecutar
                        </button>
                    `
                        : ""
                    }
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="viewScriptContent('${script.path}')">
                        <i class="bi bi-eye"></i> Ver
                    </button>
                </div>
            `;
        scriptsList.appendChild(scriptItem);
      });

      categoryHeader.appendChild(scriptsList);
      categoryContent.appendChild(categoryHeader);
      scriptsContent.appendChild(categoryContent);
    });

    // Agregar manejador de eventos para el cambio de pestañas
    const tabElements = categoryMenu.querySelectorAll(
      '[data-bs-toggle="list"]'
    );
    tabElements.forEach((tab) => {
      tab.addEventListener("shown.bs.list", function (event) {
        // Actualizar estado activo
        tabElements.forEach((t) => t.classList.remove("active"));
        event.target.classList.add("active");
      });
    });

    // Inicializar la primera pestaña como activa
    if (tabElements.length > 0) {
      const firstTab = tabElements[0];
      const firstTabContent = document.querySelector(
        firstTab.getAttribute("href")
      );
      if (firstTabContent) {
        firstTabContent.classList.add("show", "active");
        firstTab.classList.add("active");
        firstTab.setAttribute("aria-selected", "true");
      }
    }
  }

  // Función para ejecutar script
  async function executeScript(scriptPath) {
    const modal = new bootstrap.Modal(
      document.getElementById("executionModal")
    );
    const title = document.getElementById("executionModalTitle");
    const progress = document.getElementById("executionProgress");
    const result = document.getElementById("executionResult");
    const status = document.getElementById("executionStatus");
    const stdout = document.getElementById("executionStdout");
    const stderr = document.getElementById("executionStderr");

    // Mostrar modal
    title.innerHTML = `<i class="bi bi-play-circle me-2"></i>Ejecutando: ${scriptPath.split("/").pop()}`;
    progress.style.display = "block";
    result.style.display = "none";
    modal.show();

    try {
      const response = await fetch(
        `/admin/tools/run/${encodeURIComponent(scriptPath)}`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest",
          },
          credentials: "same-origin",
        }
      );

      const data = await response.json();

      // Ocultar progreso y mostrar resultado
      progress.style.display = "none";
      result.style.display = "block";

      // Configurar estado
      if (data.status === "success") {
        status.className = "alert alert-success";
        status.innerHTML = `<i class="bi bi-check-circle me-2"></i>${data.message}`;
      } else {
        status.className = "alert alert-danger";
        status.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>${data.message || data.error}`;
      }

      // Mostrar salida
      stdout.textContent = data.stdout || "(Sin salida)";
      stderr.textContent = data.stderr || "(Sin errores)";
    } catch (error) {
      progress.style.display = "none";
      result.style.display = "block";

      status.className = "alert alert-danger";
      status.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>Error de conexión: ${error.message}`;
      stdout.textContent = "(Error de conexión)";
      stderr.textContent = error.message;
    }
  }

  // Función para ver contenido del script
  async function viewScriptContent(scriptPath) {
    try {
      const response = await fetch(
        `/admin/tools/content/${encodeURIComponent(scriptPath)}`,
        {
          credentials: "same-origin",
        }
      );

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const data = await response.json();

      const modal = new bootstrap.Modal(
        document.getElementById("scriptContentModal")
      );
      const title = document.getElementById("scriptContentModalTitle");
      const content = document.getElementById("scriptContent");

      title.innerHTML = `<i class="bi bi-file-code me-2"></i>${scriptPath.split("/").pop()}`;
      content.textContent = data.content;
      modal.show();
    } catch (error) {
      console.error("Error cargando contenido:", error);
      showNotification(
        "Error",
        "No se pudo cargar el contenido del script",
        "error"
      );
    }
  }

  // Función para buscar scripts
  document
    .getElementById("script-search")
    .addEventListener("input", function (e) {
      const searchTerm = e.target.value.toLowerCase();

      // Filtrar categorías
      scriptsData.forEach((category, categoryIndex) => {
        const categoryContent = document.getElementById(`cat-${categoryIndex}`);
        const menuItem = document.querySelector(
          `[href="#cat-${categoryIndex}"]`
        );

        const visibleScripts = category.scripts.filter(
          (script) =>
            script.nombre.toLowerCase().includes(searchTerm) ||
            script.descripcion.toLowerCase().includes(searchTerm)
        );

        if (visibleScripts.length > 0) {
          // Mostrar pestaña usando clases de Bootstrap
          categoryContent.classList.remove("d-none");
          menuItem.classList.remove("d-none");

          // Actualizar contador
          const badge = menuItem.querySelector(".badge");
          badge.textContent = visibleScripts.length;
        } else {
          // Ocultar pestaña usando clases de Bootstrap
          categoryContent.classList.add("d-none");
          menuItem.classList.add("d-none");
        }
      });
    });

  // Función para limpiar búsqueda
  function clearSearch() {
    document.getElementById("script-search").value = "";
    document.getElementById("script-search").dispatchEvent(new Event("input"));
  }

  // Función para refrescar scripts
  function refreshScripts() {
    loadScripts();
  }

  // Función para mostrar notificaciones
  function showNotification(title, message, type = "info") {
    const alertClass =
      type === "success"
        ? "alert-success"
        : type === "error"
          ? "alert-danger"
          : type === "warning"
            ? "alert-warning"
            : "alert-info";

    const alert = document.createElement("div");
    alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    alert.style.cssText =
      "top: 20px; right: 20px; z-index: 9999; min-width: 300px;";
    alert.innerHTML = `
        <strong>${title}</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alert);

    // Auto-remover después de 5 segundos
    setTimeout(() => {
      if (alert.parentNode) {
        alert.remove();
      }
    }, 5000);
  }
</script>
{% endblock %}
