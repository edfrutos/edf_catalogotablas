{% extends 'admin/base.html' %} {% block title %}Gestor de Scripts y
Herramientas - Catálogo Tablas{% endblock %} {% block content %}
<div class="container mt-4">
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div
          class="card-header bg-primary text-white d-flex align-items-center"
        >
          <i class="fas fa-tools me-2"></i>
          <h1 class="h3 mb-0">Gestor de Scripts y Herramientas</h1>
        </div>
        <div class="card-body">
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Información:</strong> Esta herramienta permite visualizar y
            ejecutar los scripts de shell (.sh) y utilidades del sistema
            disponibles. Utilice con precaución, ya que algunos scripts pueden
            afectar la configuración del sistema.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Navegación por pestañas -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <ul class="nav nav-tabs" id="toolsTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button
                class="nav-link active"
                id="scripts-tab"
                data-bs-toggle="tab"
                data-bs-target="#scripts"
                type="button"
                role="tab"
              >
                <i class="fas fa-terminal me-2"></i>Scripts de Shell
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="system-tab"
                data-bs-toggle="tab"
                data-bs-target="#system"
                type="button"
                role="tab"
              >
                <i class="fas fa-cogs me-2"></i>Utilidades del Sistema
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="maintenance-tab"
                data-bs-toggle="tab"
                data-bs-target="#maintenance"
                type="button"
                role="tab"
              >
                <i class="fas fa-wrench me-2"></i>Mantenimiento
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="data-tab"
                data-bs-toggle="tab"
                data-bs-target="#data"
                type="button"
                role="tab"
              >
                <i class="fas fa-database me-2"></i>Gestión de Datos
              </button>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Contenido de las pestañas -->
  <div class="tab-content" id="toolsTabContent">
    <!-- Pestaña de Scripts de Shell -->
    <div class="tab-pane fade show active" id="scripts" role="tabpanel">
      <div class="row mb-4">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="input-group mb-3">
                <span class="input-group-text"
                  ><i class="fas fa-search"></i
                ></span>
                <input
                  type="text"
                  id="searchInput"
                  class="form-control"
                  placeholder="Buscar scripts por nombre o descripción..."
                />
              </div>
              <div
                class="btn-group mb-3 category-filter"
                id="categoryFilterContainer"
              >
                <button
                  class="btn btn-outline-primary active"
                  data-category="all"
                >
                  Todos
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row" id="scriptAccordionContainer">
        <!-- Aquí se inyectará dinámicamente el acordeón de scripts por JS -->
      </div>

      <div class="row" id="noScriptsAlert" style="display: none">
        <div class="col-12">
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            No se encontraron scripts en el sistema.
          </div>
        </div>
      </div>
    </div>

    <!-- Pestaña de Utilidades del Sistema -->
    <div class="tab-pane fade" id="system" role="tabpanel">
      <div class="row">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0">
                <i class="fas fa-cogs me-2"></i>Utilidades del Sistema
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Configuración y Logging -->
                <div class="col-md-6 mb-3">
                  <div class="card h-100">
                    <div class="card-header bg-light">
                      <h6 class="mb-0">
                        <i class="fas fa-cog me-2"></i>Configuración y Logging
                      </h6>
                    </div>
                    <div class="card-body">
                      <div class="list-group list-group-flush">
                        <div
                          class="list-group-item d-flex justify-content-between align-items-center"
                        >
                          <div>
                            <strong>Logging Unificado</strong>
                            <br /><small class="text-muted"
                              >Sistema de logging centralizado</small
                            >
                          </div>
                          <button
                            class="btn btn-sm btn-outline-primary"
                            onclick="runSystemUtility('logging_unified')"
                          >
                            <i class="fas fa-play"></i>
                          </button>
                        </div>
                        <div
                          class="list-group-item d-flex justify-content-between align-items-center"
                        >
                          <div>
                            <strong>Limpieza de Logs</strong>
                            <br /><small class="text-muted"
                              >Eliminar logs verbosos</small
                            >
                          </div>
                          <button
                            class="btn btn-sm btn-outline-warning"
                            onclick="runSystemUtility('clean_logging')"
                          >
                            <i class="fas fa-broom"></i>
                          </button>
                        </div>
                        <div
                          class="list-group-item d-flex justify-content-between align-items-center"
                        >
                          <div>
                            <strong>Configuración Embebida</strong>
                            <br /><small class="text-muted"
                              >Configuración para app empaquetada</small
                            >
                          </div>
                          <button
                            class="btn btn-sm btn-outline-info"
                            onclick="runSystemUtility('config_embedded')"
                          >
                            <i class="fas fa-cog"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Monitoreo y Notificaciones -->
                <div class="col-md-6 mb-3">
                  <div class="card h-100">
                    <div class="card-header bg-light">
                      <h6 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>Monitoreo y
                        Notificaciones
                      </h6>
                    </div>
                    <div class="card-body">
                      <div class="list-group list-group-flush">
                        <div
                          class="list-group-item d-flex justify-content-between align-items-center"
                        >
                          <div>
                            <strong>Sistema de Monitoreo</strong>
                            <br /><small class="text-muted"
                              >Monitoreo del servidor y recursos</small
                            >
                          </div>
                          <button
                            class="btn btn-sm btn-outline-success"
                            onclick="runSystemUtility('monitoring')"
                          >
                            <i class="fas fa-eye"></i>
                          </button>
                        </div>
                        <div
                          class="list-group-item d-flex justify-content-between align-items-center"
                        >
                          <div>
                            <strong>Notificaciones</strong>
                            <br /><small class="text-muted"
                              >Sistema de alertas y notificaciones</small
                            >
                          </div>
                          <button
                            class="btn btn-sm btn-outline-info"
                            onclick="runSystemUtility('notifications')"
                          >
                            <i class="fas fa-bell"></i>
                          </button>
                        </div>
                        <div
                          class="list-group-item d-flex justify-content-between align-items-center"
                        >
                          <div>
                            <strong>Datos de Respaldo</strong>
                            <br /><small class="text-muted"
                              >Gestión de datos de fallback</small
                            >
                          </div>
                          <button
                            class="btn btn-sm btn-outline-secondary"
                            onclick="runSystemUtility('data_fallback')"
                          >
                            <i class="fas fa-shield-alt"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pestaña de Mantenimiento -->
    <div class="tab-pane fade" id="maintenance" role="tabpanel">
      <div class="row">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">
              <h5 class="mb-0">
                <i class="fas fa-wrench me-2"></i>Herramientas de Mantenimiento
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Mantenimiento de Usuarios -->
                <div class="col-md-6 mb-3">
                  <div class="card h-100">
                    <div class="card-header bg-light">
                      <h6 class="mb-0">
                        <i class="fas fa-users me-2"></i>Mantenimiento de
                        Usuarios
                      </h6>
                    </div>
                    <div class="card-body">
                      <div class="list-group list-group-flush">
                        <div
                          class="list-group-item d-flex justify-content-between align-items-center"
                        >
                          <div>
                            <strong>Normalizar Usuarios</strong>
                            <br /><small class="text-muted"
                              >Normalizar campos username, email y nombre</small
                            >
                          </div>
                          <button
                            class="btn btn-sm btn-outline-primary"
                            onclick="runMaintenanceUtility('normalize_users')"
                          >
                            <i class="fas fa-magic"></i>
                          </button>
                        </div>
                        <div
                          class="list-group-item d-flex justify-content-between align-items-center"
                        >
                          <div>
                            <strong>Backup de Usuarios</strong>
                            <br /><small class="text-muted"
                              >Crear backup de la colección de usuarios</small
                            >
                          </div>
                          <button
                            class="btn btn-sm btn-outline-success"
                            onclick="runMaintenanceUtility('backup_users')"
                          >
                            <i class="fas fa-download"></i>
                          </button>
                        </div>
                        <div
                          class="list-group-item d-flex justify-content-between align-items-center"
                        >
                          <div>
                            <strong>Crear Imagen Perfil</strong>
                            <br /><small class="text-muted"
                              >Generar imagen de perfil por defecto</small
                            >
                          </div>
                          <button
                            class="btn btn-sm btn-outline-info"
                            onclick="runMaintenanceUtility('create_profile_image')"
                          >
                            <i class="fas fa-image"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Utilidades Generales -->
                <div class="col-md-6 mb-3">
                  <div class="card h-100">
                    <div class="card-header bg-light">
                      <h6 class="mb-0">
                        <i class="fas fa-tools me-2"></i>Utilidades Generales
                      </h6>
                    </div>
                    <div class="card-body">
                      <div class="list-group list-group-flush">
                        <div
                          class="list-group-item d-flex justify-content-between align-items-center"
                        >
                          <div>
                            <strong>Procesar Excel</strong>
                            <br /><small class="text-muted"
                              >Utilidades para archivos Excel</small
                            >
                          </div>
                          <button
                            class="btn btn-sm btn-outline-success"
                            onclick="runMaintenanceUtility('excel_utils')"
                          >
                            <i class="fas fa-file-excel"></i>
                          </button>
                        </div>
                        <div
                          class="list-group-item d-flex justify-content-between align-items-center"
                        >
                          <div>
                            <strong>Limpieza del Proyecto</strong>
                            <br /><small class="text-muted"
                              >Script de limpieza general</small
                            >
                          </div>
                          <button
                            class="btn btn-sm btn-outline-warning"
                            onclick="runMaintenanceUtility('cleanup_project')"
                          >
                            <i class="fas fa-broom"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pestaña de Gestión de Datos -->
    <div class="tab-pane fade" id="data" role="tabpanel">
      <div class="row">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">
                <i class="fas fa-database me-2"></i>Gestión de Datos
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Backups y Restauración -->
                <div class="col-md-6 mb-3">
                  <div class="card h-100">
                    <div class="card-header bg-light">
                      <h6 class="mb-0">
                        <i class="fas fa-cloud-upload-alt me-2"></i>Backups y
                        Restauración
                      </h6>
                    </div>
                    <div class="card-body">
                      <div class="list-group list-group-flush">
                        <div
                          class="list-group-item d-flex justify-content-between align-items-center"
                        >
                          <div>
                            <strong>Crear Backup Completo</strong>
                            <br /><small class="text-muted"
                              >Backup de todas las colecciones</small
                            >
                          </div>
                          <button
                            class="btn btn-sm btn-outline-success"
                            onclick="runDataUtility('create_backup')"
                          >
                            <i class="fas fa-download"></i>
                          </button>
                        </div>
                        <div
                          class="list-group-item d-flex justify-content-between align-items-center"
                        >
                          <div>
                            <strong>Restaurar Backup</strong>
                            <br /><small class="text-muted"
                              >Restaurar desde archivo de backup</small
                            >
                          </div>
                          <button
                            class="btn btn-sm btn-outline-warning"
                            onclick="runDataUtility('restore_backup')"
                          >
                            <i class="fas fa-upload"></i>
                          </button>
                        </div>
                        <div
                          class="list-group-item d-flex justify-content-between align-items-center"
                        >
                          <div>
                            <strong>Validar Integridad</strong>
                            <br /><small class="text-muted"
                              >Verificar integridad de la base de datos</small
                            >
                          </div>
                          <button
                            class="btn btn-sm btn-outline-info"
                            onclick="runDataUtility('validate_integrity')"
                          >
                            <i class="fas fa-check-circle"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Gestión de Archivos -->
                <div class="col-md-6 mb-3">
                  <div class="card h-100">
                    <div class="card-header bg-light">
                      <h6 class="mb-0">
                        <i class="fas fa-file me-2"></i>Gestión de Archivos
                      </h6>
                    </div>
                    <div class="card-body">
                      <div class="list-group list-group-flush">
                        <div
                          class="list-group-item d-flex justify-content-between align-items-center"
                        >
                          <div>
                            <strong>Procesar Imágenes</strong>
                            <br /><small class="text-muted"
                              >Utilidades para gestión de imágenes</small
                            >
                          </div>
                          <button
                            class="btn btn-sm btn-outline-primary"
                            onclick="runDataUtility('image_utils')"
                          >
                            <i class="fas fa-image"></i>
                          </button>
                        </div>
                        <div
                          class="list-group-item d-flex justify-content-between align-items-center"
                        >
                          <div>
                            <strong>Procesar Hojas de Cálculo</strong>
                            <br /><small class="text-muted"
                              >Utilidades para Excel y CSV</small
                            >
                          </div>
                          <button
                            class="btn btn-sm btn-outline-success"
                            onclick="runDataUtility('spreadsheet_utils')"
                          >
                            <i class="fas fa-table"></i>
                          </button>
                        </div>
                        <div
                          class="list-group-item d-flex justify-content-between align-items-center"
                        >
                          <div>
                            <strong>Almacenamiento S3</strong>
                            <br /><small class="text-muted"
                              >Gestión de archivos en Amazon S3</small
                            >
                          </div>
                          <button
                            class="btn btn-sm btn-outline-info"
                            onclick="runDataUtility('s3_utils')"
                          >
                            <i class="fas fa-cloud"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para ver el contenido del script -->
<div
  class="modal fade"
  id="scriptModal"
  tabindex="-1"
  aria-labelledby="scriptModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Contenido del Script</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="script-path mb-3 text-muted small" id="modalPath"></div>
        <pre class="bg-light p-3 rounded" id="scriptContent"><code></code></pre>
        <div id="outputContainer" class="mt-4" style="display: none">
          <h6 class="border-bottom pb-2 mb-3">Salida del Script:</h6>
          <div class="d-flex align-items-center mb-2">
            <div
              id="runningIndicator"
              class="spinner-border spinner-border-sm text-primary me-2"
              role="status"
            >
              <span class="visually-hidden">Ejecutando...</span>
            </div>
            <div id="statusBadge" class="badge bg-secondary me-2">
              Esperando
            </div>
            <div id="timestampInfo" class="small text-muted"></div>
          </div>
          <pre class="bg-dark text-light p-3 rounded" id="scriptOutput"></pre>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cerrar
        </button>
        <button type="button" class="btn btn-success" id="modalRunBtn">
          <i class="fas fa-play me-1"></i> Ejecutar Script
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para utilidades del sistema -->
<div
  class="modal fade"
  id="utilityModal"
  tabindex="-1"
  aria-labelledby="utilityModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="utilityModalTitle">Ejecutar Utilidad</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div id="utilityOutput" class="bg-light p-3 rounded">
          <div class="d-flex align-items-center">
            <div
              class="spinner-border spinner-border-sm text-primary me-2"
              role="status"
            >
              <span class="visually-hidden">Ejecutando...</span>
            </div>
            <span>Ejecutando utilidad...</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const scriptAccordionContainer = document.getElementById(
      "scriptAccordionContainer"
    );
    const searchInput = document.getElementById("searchInput");

    let scriptsData = [];
    let filteredData = [];

    // Función para cargar los scripts desde la API
    function loadScripts() {
      fetch("/admin/scripts-tools-api/list")
        .then((response) => response.json())
        .then((data) => {
          scriptsData = data.scripts || [];
          filteredData = [...scriptsData];
          renderScripts();
          updateCategoryFilter();
        })
        .catch((error) => {
          console.error("Error cargando scripts:", error);
          document.getElementById("noScriptsAlert").style.display = "block";
        });
    }

    // Función para renderizar los scripts
    function renderScripts() {
      if (filteredData.length === 0) {
        document.getElementById("noScriptsAlert").style.display = "block";
        scriptAccordionContainer.innerHTML = "";
        return;
      }

      document.getElementById("noScriptsAlert").style.display = "none";

      const accordionHtml = filteredData
        .map(
          (script, index) => `
            <div class="col-12 mb-3">
                <div class="card">
                    <div class="card-header" id="heading${index}">
                        <div class="d-flex justify-content-between align-items-center">
                            <button class="btn btn-link text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                                <i class="fas fa-file-code me-2"></i>
                                <strong>${script.name}</strong>
                            </button>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewScript('${script.rel_path}')">
                                    <i class="fas fa-eye"></i> Ver
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="runScript('${script.rel_path}')">
                                    <i class="fas fa-play"></i> Ejecutar
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="collapse${index}" class="collapse" data-bs-parent="#scriptAccordionContainer">
                        <div class="card-body">
                            <p><strong>Descripción:</strong> ${script.description || "Sin descripción disponible"}</p>
                            <p><strong>Ruta:</strong> <code>${script.rel_path}</code></p>
                            <p><strong>Tamaño:</strong> ${script.size ? (script.size / 1024).toFixed(2) + " KB" : "N/A"}</p>
                            <p><strong>Última modificación:</strong> ${script.mtime || "N/A"}</p>
                        </div>
                    </div>
                </div>
            </div>
        `
        )
        .join("");

      scriptAccordionContainer.innerHTML = accordionHtml;
    }

    // Función para actualizar el filtro de categorías
    function updateCategoryFilter() {
      const categories = [
        ...new Set(
          scriptsData.map((script) => script.category || "Sin categoría")
        ),
      ];
      const container = document.getElementById("categoryFilterContainer");

      // Mantener el botón "Todos"
      container.innerHTML =
        '<button class="btn btn-outline-primary active" data-category="all">Todos</button>';

      // Agregar botones para cada categoría
      categories.forEach((category) => {
        const button = document.createElement("button");
        button.className = "btn btn-outline-secondary";
        button.setAttribute("data-category", category);
        button.textContent = category;
        button.onclick = () => filterByCategory(category);
        container.appendChild(button);
      });
    }

    // Función para filtrar por categoría
    function filterByCategory(category) {
      // Actualizar botones activos
      document
        .querySelectorAll("#categoryFilterContainer .btn")
        .forEach((btn) => {
          btn.classList.remove("active");
          btn.classList.remove("btn-primary");
          btn.classList.add("btn-outline-secondary");
        });

      event.target.classList.add("active");
      event.target.classList.remove("btn-outline-secondary");
      event.target.classList.add("btn-primary");

      if (category === "all") {
        filteredData = [...scriptsData];
      } else {
        filteredData = scriptsData.filter(
          (script) => (script.category || "Sin categoría") === category
        );
      }

      renderScripts();
    }

    // Función para buscar scripts
    searchInput.addEventListener("input", function () {
      const searchTerm = this.value.toLowerCase();
      filteredData = scriptsData.filter(
        (script) =>
          script.name.toLowerCase().includes(searchTerm) ||
          (script.description &&
            script.description.toLowerCase().includes(searchTerm))
      );
      renderScripts();
    });

    // Cargar scripts al inicializar
    loadScripts();
  });

  // Funciones globales para utilidades del sistema
  function runSystemUtility(utility) {
    const modal = new bootstrap.Modal(document.getElementById("utilityModal"));
    const output = document.getElementById("utilityOutput");
    const title = document.getElementById("utilityModalTitle");

    title.textContent = `Ejecutando: ${utility}`;
    output.innerHTML =
      '<div class="d-flex align-items-center"><div class="spinner-border spinner-border-sm text-primary me-2"></div><span>Ejecutando utilidad...</span></div>';

    modal.show();

    // Conectar con la API real
    fetch(`/admin/scripts-tools-api/system/${utility}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          output.innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>${data.message}</div><pre class="mt-2">${data.output}</pre>`;
        } else {
          output.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error: ${data.error}</div>`;
        }
      })
      .catch((error) => {
        output.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error de conexión: ${error.message}</div>`;
      });
  }

  function runMaintenanceUtility(utility) {
    const modal = new bootstrap.Modal(document.getElementById("utilityModal"));
    const output = document.getElementById("utilityOutput");
    const title = document.getElementById("utilityModalTitle");

    title.textContent = `Mantenimiento: ${utility}`;
    output.innerHTML =
      '<div class="d-flex align-items-center"><div class="spinner-border spinner-border-sm text-warning me-2"></div><span>Ejecutando mantenimiento...</span></div>';

    modal.show();

    // Conectar con la API real
    fetch(`/admin/scripts-tools-api/maintenance/${utility}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          output.innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>${data.message}</div><pre class="mt-2">${data.output}</pre>`;
        } else {
          output.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error: ${data.error}</div>`;
        }
      })
      .catch((error) => {
        output.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error de conexión: ${error.message}</div>`;
      });
  }

  function runDataUtility(utility) {
    const modal = new bootstrap.Modal(document.getElementById("utilityModal"));
    const output = document.getElementById("utilityOutput");
    const title = document.getElementById("utilityModalTitle");

    title.textContent = `Gestión de Datos: ${utility}`;
    output.innerHTML =
      '<div class="d-flex align-items-center"><div class="spinner-border spinner-border-sm text-success me-2"></div><span>Procesando datos...</span></div>';

    modal.show();

    // Conectar con la API real
    fetch(`/admin/scripts-tools-api/data/${utility}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          output.innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>${data.message}</div><pre class="mt-2">${data.output}</pre>`;
        } else {
          output.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error: ${data.error}</div>`;
        }
      })
      .catch((error) => {
        output.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error de conexión: ${error.message}</div>`;
      });
  }

  // Funciones para scripts (mantener compatibilidad)
  function viewScript(path) {
    fetch(`/admin/scripts-tools-api/download?path=${encodeURIComponent(path)}`)
      .then((response) => response.text())
      .then((content) => {
        document.getElementById("modalTitle").textContent =
          `Contenido: ${path.split("/").pop()}`;
        document.getElementById("modalPath").textContent = path;
        document.getElementById("scriptContent").textContent = content;
        document.getElementById("outputContainer").style.display = "none";

        const modal = new bootstrap.Modal(
          document.getElementById("scriptModal")
        );
        modal.show();
      })
      .catch((error) => {
        console.error("Error cargando script:", error);
        alert("Error al cargar el contenido del script");
      });
  }

  function runScript(path) {
    if (
      !confirm(
        `¿Está seguro de que desea ejecutar el script "${path.split("/").pop()}"?`
      )
    ) {
      return;
    }

    const modal = document.getElementById("scriptModal");
    const outputContainer = document.getElementById("outputContainer");
    const runningIndicator = document.getElementById("runningIndicator");
    const statusBadge = document.getElementById("statusBadge");
    const scriptOutput = document.getElementById("scriptOutput");
    const timestampInfo = document.getElementById("timestampInfo");

    outputContainer.style.display = "block";
    runningIndicator.style.display = "inline-block";
    statusBadge.textContent = "Ejecutando";
    statusBadge.className = "badge bg-warning me-2";
    scriptOutput.textContent = "Iniciando ejecución...";
    timestampInfo.textContent = new Date().toLocaleString();

    fetch("/admin/scripts-tools-api/run", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ path: path }),
    })
      .then((response) => response.json())
      .then((data) => {
        runningIndicator.style.display = "none";

        if (data.success) {
          statusBadge.textContent = "Completado";
          statusBadge.className = "badge bg-success me-2";
          scriptOutput.textContent =
            data.output || "Script ejecutado correctamente";
        } else {
          statusBadge.textContent = "Error";
          statusBadge.className = "badge bg-danger me-2";
          scriptOutput.textContent = data.error || "Error desconocido";
        }
      })
      .catch((error) => {
        runningIndicator.style.display = "none";
        statusBadge.textContent = "Error";
        statusBadge.className = "badge bg-danger me-2";
        scriptOutput.textContent = `Error de conexión: ${error.message}`;
      });
  }
</script>
{% endblock %}
