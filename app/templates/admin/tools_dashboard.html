{% extends 'admin/base.html' %}

{% block title %}Gestor de Scripts - Catálogo Tablas{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex align-items-center">
                    <i class="fas fa-tools me-2"></i>
                    <h1 class="h3 mb-0">Gestor de Scripts</h1>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Información:</strong> Esta herramienta permite visualizar y ejecutar los scripts de shell (.sh) disponibles en el sistema. Utilice con precaución, ya que algunos scripts pueden afectar la configuración del sistema.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="input-group mb-3">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" id="searchInput" class="form-control" placeholder="Buscar scripts por nombre o descripción...">
                    </div>
                    <div class="btn-group mb-3 category-filter">
                        <button class="btn btn-outline-primary active" data-category="all">Todos</button>
                        {% for category_id, category in categories.items() %}
                        <button class="btn btn-outline-{{ category.color }}" data-category="{{ category_id }}">{{ category.name }}</button>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row" id="scriptGrid">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="col-12 mb-4">
            {% for category, message in messages %}
            <div class="alert alert-{{ category if category != 'error' else 'danger' }} alert-dismissible fade show" role="alert">
                <i class="fas fa-{% if category == 'error' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}
        
        {% for script in scripts %}
        <div class="col-md-6 col-lg-4 mb-4 script-card" data-category="{{ script.category }}">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">{{ script.name }}</h5>
                </div>
                <div class="card-body">
                    <div class="script-path text-muted small mb-2">
                        <code>{{ script.path }}</code>
                    </div>
                    <div class="script-description mb-3">
                        {{ script.description }}
                    </div>
                    <div class="script-category mb-3">
                        <span class="badge bg-{{ categories[script.category].color }}">
                            {{ categories[script.category].name }}
                        </span>
                    </div>
                </div>
                <div class="card-footer bg-white border-top-0">
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('scripts.view_script_content', script_path=script.path) }}" class="btn btn-outline-primary">
                            <i class="fas fa-eye me-1"></i> Ver Contenido
                        </a>
                        <button class="btn btn-outline-success run-script-btn" data-path="{{ script.path }}">
                            <i class="fas fa-play me-1"></i> Ejecutar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if not scripts %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                No se encontraron scripts en el sistema.
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal para ver el contenido del script -->
<div class="modal fade" id="scriptModal" tabindex="-1" aria-labelledby="scriptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Contenido del Script</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="script-path mb-3 text-muted small" id="modalPath"></div>
                <pre class="bg-light p-3 rounded" id="scriptContent"><code></code></pre>
                <div id="outputContainer" class="mt-4" style="display: none;">
                    <h6 class="border-bottom pb-2 mb-3">Salida del Script:</h6>
                    <div class="d-flex align-items-center mb-2">
                        <div id="runningIndicator" class="spinner-border spinner-border-sm text-primary me-2" role="status">
                            <span class="visually-hidden">Ejecutando...</span>
                        </div>
                        <div id="statusBadge" class="badge bg-secondary me-2">Esperando</div>
                        <div id="timestampInfo" class="small text-muted"></div>
                    </div>
                    <pre class="bg-dark text-light p-3 rounded" id="scriptOutput"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-success" id="modalRunBtn">
                    <i class="fas fa-play me-1"></i> Ejecutar Script
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Referencias a elementos del DOM
        const searchInput = document.getElementById('searchInput');
        const scriptGrid = document.getElementById('scriptGrid');
        const scriptModal = new bootstrap.Modal(document.getElementById('scriptModal'));
        const modalTitle = document.getElementById('modalTitle');
        const modalPath = document.getElementById('modalPath');
        const scriptContent = document.getElementById('scriptContent');
        const outputContainer = document.getElementById('outputContainer');
        const scriptOutput = document.getElementById('scriptOutput');
        const modalRunBtn = document.getElementById('modalRunBtn');
        const runningIndicator = document.getElementById('runningIndicator');
        const statusBadge = document.getElementById('statusBadge');
        const timestampInfo = document.getElementById('timestampInfo');
        
        // Configurar la búsqueda
        searchInput.addEventListener('input', function() {
            filterScripts();
        });
        
        // Configurar los filtros de categoría
        document.querySelectorAll('.category-filter button').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.category-filter button').forEach(b => {
                    b.classList.remove('active');
                });
                this.classList.add('active');
                filterScripts();
            });
        });
        
        // Función para filtrar scripts
        function filterScripts() {
            const searchTerm = searchInput.value.toLowerCase();
            const activeCategory = document.querySelector('.category-filter button.active').getAttribute('data-category');
            
            document.querySelectorAll('.script-card').forEach(card => {
                const cardCategory = card.getAttribute('data-category');
                const cardTitle = card.querySelector('.card-title').textContent.toLowerCase();
                const cardDescription = card.querySelector('.script-description').textContent.toLowerCase();
                
                const matchesSearch = cardTitle.includes(searchTerm) || cardDescription.includes(searchTerm);
                const matchesCategory = activeCategory === 'all' || cardCategory === activeCategory;
                
                if (matchesSearch && matchesCategory) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        // Configurar botones de ver contenido
        document.querySelectorAll('.btn-view').forEach(btn => {
            btn.addEventListener('click', function() {
                const path = this.getAttribute('data-path');
                viewScript(path);
            });
        });
        
        // Configurar los botones para ejecutar scripts
        document.querySelectorAll('.btn-outline-success').forEach(btn => {
            btn.addEventListener('click', function() {
                const path = this.getAttribute('data-path');
                runScript(path);
            });
        });
        
        // Configurar el botón de ejecución en el modal
        modalRunBtn.addEventListener('click', function() {
            const path = this.getAttribute('data-path');
            runScript(path);
        });
        
        // Función para ver el contenido de un script - ahora se usa el enlace directo
        function viewScript(path, autoRun = false) {
            // Asegurarse de que la ruta esté correctamente codificada
            window.location.href = `/admin/tools/content/${encodeURIComponent(path)}`;
        }
        
        // Función para ejecutar un script
        function runScript(path) {
            // Mostrar el modal para ver la salida
            const scriptModal = new bootstrap.Modal(document.getElementById('scriptModal'));
            const outputContainer = document.getElementById('outputContainer');
            const scriptOutput = document.getElementById('scriptOutput');
            const runningIndicator = document.getElementById('runningIndicator');
            const statusBadge = document.getElementById('statusBadge');
            const timestampInfo = document.getElementById('timestampInfo');
            const modalTitle = document.getElementById('modalTitle');
            const modalPath = document.getElementById('modalPath');
            
            modalTitle.textContent = 'Ejecutando script: ' + path.split('/').pop();
            modalPath.textContent = path;
            
            outputContainer.style.display = 'block';
            scriptOutput.textContent = 'Ejecutando script...';
            runningIndicator.style.display = 'inline-block';
            statusBadge.textContent = 'Ejecutando';
            statusBadge.className = 'badge bg-warning me-2';
            timestampInfo.textContent = 'Iniciado: ' + new Date().toLocaleTimeString();
            
            scriptModal.show();
            
            // Realizar la petición POST para ejecutar el script usando la nueva ruta simplificada
            fetch('/admin/tools/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    script_path: path  // Enviamos la ruta del script como parámetro en el cuerpo JSON
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                runningIndicator.style.display = 'none';
                
                if (data.error && !data.output) {
                    statusBadge.textContent = 'Error';
                    statusBadge.className = 'badge bg-danger me-2';
                    scriptOutput.textContent = data.error;
                } else {
                    let output = '';
                    
                    if (data.exit_code === 0) {
                        statusBadge.textContent = 'Completado';
                        statusBadge.className = 'badge bg-success me-2';
                    } else {
                        statusBadge.textContent = `Error (${data.exit_code})`;
                        statusBadge.className = 'badge bg-danger me-2';
                    }
                    
                    if (data.output) {
                        output += data.output;
                    }
                    
                    if (data.error) {
                        if (output) output += '\n\n';
                        output += '--- ERRORES ---\n' + data.error;
                    }
                    
                    scriptOutput.textContent = output || 'El script se ejecutó correctamente pero no produjo ninguna salida.';
                }
                
                timestampInfo.textContent = 'Finalizado: ' + new Date().toLocaleTimeString();
            })
            .catch(error => {
                runningIndicator.style.display = 'none';
                statusBadge.textContent = 'Error';
                statusBadge.className = 'badge bg-danger me-2';
                scriptOutput.textContent = 'Error al ejecutar el script: ' + error.message;
                timestampInfo.textContent = 'Error: ' + new Date().toLocaleTimeString();
            });
        }
        
        // Función para obtener el token CSRF
        function getCsrfToken() {
            // Intentar obtener el token CSRF de una meta etiqueta
            const metaTag = document.querySelector('meta[name="csrf-token"]');
            if (metaTag) {
                return metaTag.getAttribute('content');
            }
            
            // Si no hay meta etiqueta, intentar obtenerlo de una cookie
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith('csrf_token=')) {
                    return cookie.substring('csrf_token='.length, cookie.length);
                }
            }
            
            // Si no se encuentra, devolver un valor vacío
            return '';
        }
    });
</script>
{% endblock %}
