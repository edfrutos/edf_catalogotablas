{% extends "base.html" %}
{% block title %}Ver Tabla{% endblock %}
{% block content %}
<div class="container mt-4">
  <h2>Tabla: {{ table.name }}</h2>
  <a href="{{ url_for('main.dashboard_user') }}" class="btn btn-secondary mb-3">&larr; Volver al panel</a>
  <table class="table table-bordered mb-4">
    <tr><th>Nombre</th><td>{{ table.name }}</td></tr>
    <tr><th>Fecha de creación</th><td>{% if table.created_at %}{% if table.created_at is string %}{{ table.created_at }}{% else %}{{ table.created_at.strftime('%Y-%m-%d %H:%M') }}{% endif %}{% else %}—{% endif %}</td></tr>
    <tr><th>Propietario</th><td>{{ table.owner }}</td></tr>
    <tr><th>Encabezados</th><td>{{ table.headers|join(', ') if table.headers else '—' }}</td></tr>
    <tr><th>Número de filas</th><td>{{ table.data|length if table.data else 0 }}</td></tr>
  </table>
  {% if session.username == table.owner %}
    <a href="{{ url_for('main.editar_tabla', id=table._id) }}" class="btn btn-success mb-3"><i class="bi bi-pencil"></i> Editar tabla</a>
  {% endif %}
  {% if session.role == 'admin' or session.username == table.owner %}
    <a href="{{ url_for('main.agregar_fila', tabla_id=table._id|string) }}" class="btn btn-success mb-3">
      <i class="bi bi-plus"></i> Agregar Fila
    </a>
  {% endif %}
  <h4>Filas de la tabla</h4>
  {% if table.data and table.headers %}
    <div class="mb-3">
      <input type="text" id="searchInput" class="form-control" placeholder="Buscar en la tabla...">
    </div>
    <div class="table-responsive">
      <table class="table table-striped table-sm" id="tablaFilas">
        <thead>
          <tr>
            {% for header in table.headers %}
              <th>{{ header }}</th>
            {% endfor %}
            <th>Imágenes</th>
            {% if session.role == 'admin' or session.username == table.owner %}
              <th>Acciones</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for row in table.data %}
            <tr>
              {% for header in table.headers %}
                <td>{{ row[header] if row[header] is defined and row[header] is not none else '' }}</td>
              {% endfor %}
              <td>
                {% if row.imagenes and row.imagenes|length > 0 %}
                <div class="d-flex flex-wrap gap-2">
                  {% for img in row.imagenes %}
                  {% set img_url = row.imagen_urls[loop.index0] if row.imagen_urls is defined and row.imagen_urls|length > loop.index0 else url_for('static', filename='uploads/' ~ img) %}
                  <a href="#" onclick="mostrarImagenModal('{{ img_url }}'); return false;">
                    <img src="{{ img_url }}" alt="Imagen" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #ccc;">
                  </a>
                  {% endfor %}
                </div>
                {% else %}
                <span class="text-muted">Sin imágenes</span>
                {% endif %}
              </td>
              {% if session.role == 'admin' or session.username == table.owner %}
                <td>
                  <a href="{{ url_for('main.editar_fila', tabla_id=table._id, fila_index=loop.index0) }}" class="btn btn-sm btn-primary">Editar</a>
                </td>
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <nav>
      <ul class="pagination justify-content-center" id="paginacionTabla"></ul>
    </nav>
  {% else %}
    <div class="alert alert-info">Esta tabla no tiene filas aún.</div>
  {% endif %}
</div>

<!-- Modal para visualizar imágenes -->
<div class="modal fade" id="imagenModal" tabindex="-1" aria-labelledby="imagenModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imagenModalLabel">Visualizar Imagen</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="imagenModalSrc" src="" alt="Imagen" style="max-width: 100%; max-height: 80vh;">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
{% block scripts %}
<script>
const filas = Array.from(document.querySelectorAll('#tablaFilas tbody tr'));
const filasPorPagina = 10;
let paginaActual = 1;

function mostrarImagenModal(imagenUrl) {
  document.getElementById('imagenModalSrc').src = imagenUrl;
  const modal = new bootstrap.Modal(document.getElementById('imagenModal'));
  modal.show();
}

function mostrarPagina(pagina) {
  const inicio = (pagina - 1) * filasPorPagina;
  const fin = inicio + filasPorPagina;
  filas.forEach((fila, i) => {
    fila.style.display = (i >= inicio && i < fin) ? '' : 'none';
  });
  renderizarPaginacion(pagina);
}

function renderizarPaginacion(pagina) {
  const totalPaginas = Math.ceil(filas.filter(f => f.style.display !== 'none' || f.style.display === '').length / filasPorPagina);
  const paginacion = document.getElementById('paginacionTabla');
  paginacion.innerHTML = '';
  if (totalPaginas <= 1) return;
  for (let i = 1; i <= totalPaginas; i++) {
    const li = document.createElement('li');
    li.className = 'page-item' + (i === pagina ? ' active' : '');
    const a = document.createElement('a');
    a.className = 'page-link';
    a.textContent = i;
    a.href = '#';
    a.onclick = function(e) { e.preventDefault(); paginaActual = i; mostrarPagina(i); };
    li.appendChild(a);
    paginacion.appendChild(li);
  }
}

function filtrarFilas() {
  const valor = document.getElementById('searchInput').value.toLowerCase();
  filas.forEach(fila => {
    const texto = fila.textContent.toLowerCase();
    fila.style.display = texto.includes(valor) ? '' : 'none';
  });
  paginaActual = 1;
  mostrarPagina(1);
}

document.getElementById('searchInput').addEventListener('input', filtrarFilas);
mostrarPagina(1);
</script>
{% endblock %}
